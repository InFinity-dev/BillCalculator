{% extends "base.html" %}
{% block title %}수도요금 상세 - 공과금 정산 시스템{% endblock %}
{% block content %}
<h1>💧 수도요금 상세 내역</h1>

<div style="display:flex; justify-content:space-between; margin-bottom:20px;">
  <div>
    <h2>{{ bill.billing_month.strftime('%Y년 %m월') }}</h2>
    <p style="color:#64748b;">
      총액: {{ "{:,.0f}".format(bill.total_amount) }}원 |
      복지 할인 총액: -{{ "{:,.0f}".format(bill.welfare_discount_total|default(0)) }}원
    </p>
  </div>
  <a href="{{ url_for('view_bills') }}" class="btn btn-secondary">목록으로</a>
</div>

<div class="grid grid-2" style="margin-bottom:30px;">
  <div style="background:#f8fafc; padding:20px; border-radius:12px;">
    <h3>청구 정보</h3>
    <table style="width:100%;">
      <tr><td>수도요금 총액:</td><td style="text-align:right"><strong>{{ "{:,.0f}".format(bill.total_amount) }}원</strong></td></tr>
      <tr><td>복지 할인 총액:</td><td style="text-align:right">-{{ "{:,.0f}".format(bill.welfare_discount_total|default(0)) }}원</td></tr>
      <tr><td>정산 세대수:</td><td style="text-align:right"><strong>{{ details|length }}세대</strong></td></tr>
      <tr><td>최종 청구 총액:</td><td style="text-align:right"><strong>{{ "{:,.0f}".format(details|sum(attribute='charged_amount')) }}원</strong></td></tr>
    </table>
  </div>
  <div style="background:#f8fafc; padding:20px; border-radius:12px;">
    <h3>정산 방식</h3>
    <p style="color:#475569; line-height:1.7;">
      • 기본 배분액 = (세대 거주 인원 ÷ 전체 재실 인원) × (총액 - 복지 할인 총액)<br>
      • 최종 금액 = 기본 배분액 - 세대별 수도 복지 할인<br>
      • 청구 금액 = 최종 금액을 10원 단위로 올림 처리
    </p>
  </div>
</div>

<h3>세대별 상세 내역</h3>
<table>
  <thead>
    <tr style="background:#e2e8f0;">
      <th>세대</th>
      <th>기본 배분액</th>
      <th>수도 복지 할인</th>
      <th>최종 금액</th>
      <th style="background:#fef3c7;">청구 금액<br>(10원 단위)</th>
    </tr>
  </thead>
  <tbody>
    {% for d in details %}
    <tr>
      <td><strong>{{ d.unit.unit_name }}</strong></td>
      <td style="text-align:right">{{ "{:,.0f}".format(d.base_amount) }}원</td>
      <td style="text-align:right; color:#059669;">
        {% if d.welfare_discount > 0 %}-{{ "{:,.0f}".format(d.welfare_discount) }}원{% else %}-{% endif %}
      </td>
      <td style="text-align:right">{{ "{:,.0f}".format(d.final_amount) }}원</td>
      <td style="text-align:right; background:#fef3c7; font-weight:bold; font-size:1.1em;">
        {{ "{:,.0f}".format(d.charged_amount) }}원
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr style="background:#e2e8f0; font-weight:bold;">
      <td>합계</td>
      <td style="text-align:right">{{ "{:,.0f}".format(details|sum(attribute='base_amount')) }}원</td>
      <td style="text-align:right; color:#059669;">
        {% set total_welfare = details|sum(attribute='welfare_discount') %}
        {% if total_welfare > 0 %}-{{ "{:,.0f}".format(total_welfare) }}원{% else %}-{% endif %}
      </td>
      <td style="text-align:right">{{ "{:,.0f}".format(details|sum(attribute='final_amount')) }}원</td>
      <td style="text-align:right; background:#fbbf24; font-size:1.2em;">
        {{ "{:,.0f}".format(details|sum(attribute='charged_amount')) }}원
      </td>
    </tr>
  </tfoot>
</table>

{% endblock %}
