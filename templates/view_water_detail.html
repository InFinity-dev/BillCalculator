{% extends "base.html" %}
{% block title %}ìˆ˜ë„ìš”ê¸ˆ ìƒì„¸ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
    <h1><span class="emoji">ğŸ’§</span> ìˆ˜ë„ìš”ê¸ˆ ìƒì„¸ ë‚´ì—­</h1>

<div style="display:flex; justify-content:space-between; margin-bottom:20px;">
  <div>
    <h2>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</h2>
    <p style="color:#64748b;">
      ì´ì•¡: {{ "{:,.0f}".format(bill.total_amount) }}ì› |
      ë³µì§€ í• ì¸ ì´ì•¡: -{{ "{:,.0f}".format(bill.welfare_discount_total|default(0)) }}ì›
    </p>
  </div>
  <a href="{{ url_for('view_bills') }}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
</div>

{% set included_details = details|selectattr('is_excluded', 'false')|list %}
{% set excluded_details = details|selectattr('is_excluded', 'true')|list %}

<div class="grid grid-2" style="margin-bottom:30px;">
  <div style="background:#f8fafc; padding:20px; border-radius:12px;">
    <h3>ì²­êµ¬ ì •ë³´</h3>
    <table style="width:100%;">
      <tr><td>ìˆ˜ë„ìš”ê¸ˆ ì´ì•¡:</td><td style="text-align:right"><strong>{{ "{:,.0f}".format(bill.total_amount) }}ì›</strong></td></tr>
      <tr><td>ë³µì§€ í• ì¸ ì´ì•¡:</td><td style="text-align:right">-{{ "{:,.0f}".format(bill.welfare_discount_total|default(0)) }}ì›</td></tr>
      <tr><td>ì „ì²´ ì„¸ëŒ€ìˆ˜:</td><td style="text-align:right"><strong>{{ details|length }}ì„¸ëŒ€</strong></td></tr>
      <tr><td>ì •ì‚° ì„¸ëŒ€ìˆ˜:</td><td style="text-align:right"><strong style="color:#0284c7;">{{ included_details|length }}ì„¸ëŒ€</strong></td></tr>
      {% if excluded_details|length > 0 %}
      <tr><td>ì œì™¸ ì„¸ëŒ€ìˆ˜:</td><td style="text-align:right"><strong style="color:#dc2626;">{{ excluded_details|length }}ì„¸ëŒ€</strong></td></tr>
      {% endif %}
      <tr><td>ìµœì¢… ì²­êµ¬ ì´ì•¡:</td><td style="text-align:right"><strong>{{ "{:,.0f}".format(included_details|sum(attribute='charged_amount')) }}ì›</strong></td></tr>
    </table>
  </div>
  <div style="background:#f8fafc; padding:20px; border-radius:12px;">
    <h3>ì •ì‚° ë°©ì‹</h3>
    <p style="color:#475569; line-height:1.7;">
      â€¢ ê¸°ë³¸ ë°°ë¶„ì•¡ = (ì„¸ëŒ€ ê±°ì£¼ ì¸ì› Ã· ì •ì‚° ëŒ€ìƒ ì¸ì›) Ã— (ì´ì•¡ + ë³µì§€ í• ì¸ ì´ì•¡)<br>
      â€¢ ìµœì¢… ê¸ˆì•¡ = ê¸°ë³¸ ë°°ë¶„ì•¡ - ì„¸ëŒ€ë³„ ìˆ˜ë„ ë³µì§€ í• ì¸<br>
      â€¢ ì²­êµ¬ ê¸ˆì•¡ = ìµœì¢… ê¸ˆì•¡ì„ 10ì› ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ ì²˜ë¦¬<br>
      {% if excluded_details|length > 0 %}
      <strong style="color:#dc2626;">â€¢ ì œì™¸ëœ ì„¸ëŒ€ëŠ” ì •ì‚° ëŒ€ìƒì—ì„œ ì œì™¸ë˜ì–´ 0ì›ìœ¼ë¡œ ì²­êµ¬ë©ë‹ˆë‹¤.</strong>
      {% endif %}
    </p>
  </div>
</div>

{% if excluded_details|length > 0 %}
<div style="background:#fee2e2;padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid #dc2626;">
  <h4 style="margin:0 0 8px 0;color:#991b1b;">âš ï¸ ì •ì‚° ì œì™¸ ì„¸ëŒ€</h4>
  <p style="color:#991b1b;margin:0;font-size:14px;">
    ë‹¤ìŒ ì„¸ëŒ€ëŠ” ì •ì‚° ëŒ€ìƒì—ì„œ ì œì™¸ë˜ì–´ 0ì›ìœ¼ë¡œ ì²­êµ¬ë©ë‹ˆë‹¤:
    <strong>
    {% for d in excluded_details %}
      {{ d.unit.unit_name }}{% if not loop.last %}, {% endif %}
    {% endfor %}
    </strong>
  </p>
</div>
{% endif %}

<h3>ì„¸ëŒ€ë³„ ìƒì„¸ ë‚´ì—­</h3>
<table>
  <thead>
    <tr style="background:#e2e8f0;">
      <th>ì„¸ëŒ€</th>
      <th>ìƒíƒœ</th>
      <th>ê¸°ë³¸ ë°°ë¶„ì•¡</th>
      <th>ìˆ˜ë„ ë³µì§€ í• ì¸</th>
      <th>ìµœì¢… ê¸ˆì•¡</th>
      <th style="background:#fef3c7;">ì²­êµ¬ ê¸ˆì•¡<br>(10ì› ë‹¨ìœ„)</th>
    </tr>
  </thead>
  <tbody>
    {% for d in details %}
    <tr {% if d.is_excluded %}style="background:#f9fafb;opacity:0.7;"{% endif %}>
      <td><strong>{{ d.unit.unit_name }}</strong></td>
      <td style="text-align:center;">
        {% if d.is_excluded %}
          <span class="badge badge-danger">ì œì™¸ë¨</span>
        {% else %}
          <span class="badge badge-success">í¬í•¨</span>
        {% endif %}
      </td>
      <td style="text-align:right">
        {% if d.is_excluded %}
          <span style="color:#94a3b8;">-</span>
        {% else %}
          {{ "{:,.0f}".format(d.base_amount) }}ì›
        {% endif %}
      </td>
      <td style="text-align:right; color:#059669;">
        {% if d.is_excluded %}
          <span style="color:#94a3b8;">-</span>
        {% elif d.welfare_discount > 0 %}
          -{{ "{:,.0f}".format(d.welfare_discount) }}ì›
        {% else %}
          -
        {% endif %}
      </td>
      <td style="text-align:right">
        {% if d.is_excluded %}
          <span style="color:#94a3b8;">-</span>
        {% else %}
          {{ "{:,.0f}".format(d.final_amount) }}ì›
        {% endif %}
      </td>
      <td style="text-align:right; {% if not d.is_excluded %}background:#fef3c7; font-weight:bold; font-size:1.1em;{% endif %}">
        {% if d.is_excluded %}
          <span style="color:#dc2626;font-weight:bold;">0ì›</span>
        {% else %}
          {{ "{:,.0f}".format(d.charged_amount) }}ì›
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr style="background:#e2e8f0; font-weight:bold;">
      <td colspan="2">í•©ê³„ (ì •ì‚° ëŒ€ìƒ)</td>
      <td style="text-align:right">{{ "{:,.0f}".format(included_details|sum(attribute='base_amount')) }}ì›</td>
      <td style="text-align:right; color:#059669;">
        {% set total_welfare = included_details|sum(attribute='welfare_discount') %}
        {% if total_welfare > 0 %}-{{ "{:,.0f}".format(total_welfare) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right">{{ "{:,.0f}".format(included_details|sum(attribute='final_amount')) }}ì›</td>
      <td style="text-align:right; background:#fbbf24; font-size:1.2em;">
        {{ "{:,.0f}".format(included_details|sum(attribute='charged_amount')) }}ì›
      </td>
    </tr>
  </tfoot>
</table>

<div style="margin-top:30px; padding:20px; background:#dbeafe; border-radius:12px;">
  <p style="color:#1e40af;">
    ğŸ’¡ <strong>ì•ˆë‚´ì‚¬í•­</strong><br>
    â€¢ ì •ì‚° ëŒ€ìƒ ì„¸ëŒ€: {{ included_details|length }}ì„¸ëŒ€ (ê±°ì£¼ ì¸ì›: {{ included_details|sum(attribute='unit_snapshot.residents_count') }}ëª…)<br>
    {% if excluded_details|length > 0 %}
    â€¢ ì œì™¸ëœ ì„¸ëŒ€: {{ excluded_details|length }}ì„¸ëŒ€<br>
    {% endif %}
    â€¢ ê¸°ë³¸ ë°°ë¶„ì•¡ì€ ì •ì‚° ëŒ€ìƒ ì„¸ëŒ€ì˜ ê±°ì£¼ ì¸ì› ë¹„ìœ¨ë¡œ ë¶„ë°°ë©ë‹ˆë‹¤.<br>
    â€¢ ì²­êµ¬ ê¸ˆì•¡ì€ ìµœì¢… ê¸ˆì•¡ì„ 10ì› ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ ì²˜ë¦¬í•œ ê¸ˆì•¡ì…ë‹ˆë‹¤.
  </p>
</div>

{% endblock %}