{% extends "base.html" %}

{% block title %}ì •ì‚°ì„œ ì¡°íšŒ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
    <style>
        /* í†µê³„ ìš”ì•½ ì¹´ë“œ ë””ìì¸ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
        }

        .stat-card {
            background: white;
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            border: 2px solid var(--gray-200);
            text-align: center;
            transition: var(--transition-base);
        }

        .stat-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .stat-card .label {
            font-size: var(--font-small);
            color: var(--gray-500);
            margin-bottom: var(--space-sm);
            font-weight: 500;
        }

        .stat-card .value {
            font-size: var(--font-2xl);
            font-weight: 700;
            color: var(--gray-800);
        }

        .stat-card .value.primary {
            color: var(--primary-color);
        }

        /* ê¸°íƒ€ ê¸ˆì•¡ ìƒì„¸ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .additional-details {
            font-size: var(--font-xs);
            color: var(--gray-500);
            margin-top: var(--space-xs);
            padding-left: var(--space-sm);
        }

        .charge-item {
            color: var(--danger-dark);
        }

        .refund-item {
            color: var(--success-dark);
        }

        /* ê¸ˆì•¡ ì»¬ëŸ¼ í—¤ë” ìš°ì¸¡ ì •ë ¬ */
        table th.text-right {
            text-align: right !important;
        }

        /* ê¸ˆì•¡ ë°ì´í„° ìš°ì¸¡ ì •ë ¬ */
        table td.text-right {
            text-align: right !important;
            font-weight: 500;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card .value {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <h1><span class="emoji">ğŸ“„</span> {{ combination.invoice_name }}</h1>
        <div>
            <a href="{{ url_for('print_invoice', combination_id=combination.id) }}" target="_blank"
               class="btn btn-primary">ğŸ–¨ï¸ ì¸ì‡„ìš© ë³´ê¸°</a>
            <a href="{{ url_for('invoice_combination') }}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
        </div>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <p style="color: #64748b;">ìƒì„±ì¼: {{ combination.created_at.strftime('%Yë…„ %mì›” %dì¼ %H:%M') }}</p>
            {% if combination.memo %}
                <details style="margin-top:10px;">
                    <summary style="cursor:pointer;color:#667eea;font-weight:500;">ğŸ“ ê³µí†µ ë©”ëª¨ ë³´ê¸°</summary>
                    <div style="background:#f8fafc;padding:15px;border-radius:8px;margin-top:10px;white-space:pre-line;font-size:14px;">
                        {{ combination.memo | trim }}
                    </div>
                </details>
            {% endif %}
        </div>
    </div>

    <!-- í†µê³„ ìš”ì•½ ì¹´ë“œ (ìƒˆ ë””ìì¸) -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">ì´ ì„¸ëŒ€ìˆ˜</div>
            <div class="value primary">{{ invoices|length }}</div>
        </div>
        <div class="stat-card">
            <div class="label">ì „ê¸°ìš”ê¸ˆ í•©ê³„</div>
            <div class="value">{{ "{:,}".format(invoices|sum(attribute='electric_amount')|int) }}ì›</div>
        </div>
        <div class="stat-card">
            <div class="label">ìˆ˜ë„ìš”ê¸ˆ í•©ê³„</div>
            <div class="value">{{ "{:,}".format(invoices|sum(attribute='water_amount')|int) }}ì›</div>
        </div>
        <div class="stat-card">
            <div class="label">ê³µë™ê³µê³¼ê¸ˆ í•©ê³„</div>
            <div class="value">{{ "{:,}".format(invoices|sum(attribute='common_amount')|int) }}ì›</div>
        </div>
        <div class="stat-card">
            <div class="label">ì´ ì²­êµ¬ê¸ˆì•¡</div>
            <div class="value primary">{{ "{:,}".format(invoices|sum(attribute='total_amount')|int) }}ì›</div>
        </div>
    </div>

    <!-- í¬í•¨ëœ í•­ëª© -->
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
        <h3>í¬í•¨ëœ ì²­êµ¬ í•­ëª©</h3>
        <ul style="line-height: 2;">
            {% for item in combination.items %}
                <li>
                    {% if item.item_type == 'ELECTRIC' %}
                        {% if item.electric_bill_ref %}
                            {% set ebill = item.electric_bill_ref %}
                            {% set floor_name = ebill.floor_ref.name if ebill.floor_ref else '' %}

                            âš¡
                            {% if ebill.monthly_details and ebill.monthly_details|length > 0 %}
                                {% set months = ebill.monthly_details | map(attribute='month') | select | list %}
                                {% if months|length > 1 %}
                                    {# ì²« ë‹¬ê³¼ ë§ˆì§€ë§‰ ë‹¬ í‘œì‹œ - ë¬¸ìì—´ì¸ì§€ datetime ê°ì²´ì¸ì§€ í™•ì¸ #}
                                    {{ floor_name }}
                                    {% if months[0] is string %}
                                        {{ months[0] }} ~ {{ months[-1] }}
                                    {% else %}
                                        {{ months[0].strftime('%Yë…„ %mì›”') }} ~ {{ months[-1].strftime('%mì›”') }}
                                    {% endif %}
                                    ({{ months|length }}ê°œì›” ë¬¶ìŒ)
                                {% else %}
                                    {# ë‹¨ì¼ ì›” - ë¬¸ìì—´ì¸ì§€ datetime ê°ì²´ì¸ì§€ í™•ì¸ #}
                                    {{ floor_name }}
                                    {% if months[0] is string %}
                                        {{ months[0] }}
                                    {% else %}
                                        {{ months[0].strftime('%Yë…„ %mì›”') }}
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {# monthly_detailsê°€ ì—†ìœ¼ë©´ billing_month ì‚¬ìš© #}
                                {{ floor_name }} {{ ebill.billing_month.strftime('%Yë…„ %mì›”') }}
                            {% endif %}
                        {% endif %}

                    {% elif item.item_type == 'WATER' %}
                        ğŸ’§ {{ item.billing_month.strftime('%Yë…„ %mì›”') }} ìˆ˜ë„ìš”ê¸ˆ

                    {% elif item.item_type == 'COMMON' %}
                        ğŸ˜ï¸ {{ item.billing_month.strftime('%Yë…„ %mì›”') }} {{ item.item_description|default('ê³µë™ ê³µê³¼ê¸ˆ') }}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- ì„¸ëŒ€ë³„ ì²­êµ¬ ë‚´ì—­ (ì›ë˜ ë””ìì¸ + ê¸°íƒ€ í•­ëª© ìƒì„¸ í‘œì‹œ) -->
    <h2>ì„¸ëŒ€ë³„ ì²­êµ¬ ë‚´ì—­</h2>
    <table>
        <thead>
        <tr>
            <th>ì„¸ëŒ€</th>
            <th>ì„¸ëŒ€ ë¹„ê³ </th>
            <th class="text-right">ì „ê¸°ìš”ê¸ˆ</th>
            <th class="text-right">ìˆ˜ë„ìš”ê¸ˆ</th>
            <th class="text-right">ê³µë™ê³µê³¼ê¸ˆ</th>
            <th class="text-right">ê¸°íƒ€</th>
            <th class="text-right">ì„¸ëŒ€ ë©”ëª¨</th>
            <th class="text-right" style="background: #fef3c7;">ìµœì¢… ì²­êµ¬ê¸ˆì•¡</th>
        </tr>
        </thead>
        <tbody>
        {% for invoice in invoices %}
            <tr>
                <td><strong>{{ invoice.unit.unit_name }}</strong></td>
                <td>
                    {% if invoice.unit.memo %}
                        {{ invoice.unit.memo }}
                    {% else %}
                        <span style="color:#94a3b8;">-</span>
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if invoice.electric_amount > 0 %}
                        {{ "{:,.0f}".format(invoice.electric_amount) }}ì›
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if invoice.water_amount > 0 %}
                        {{ "{:,.0f}".format(invoice.water_amount) }}ì›
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if invoice.common_amount > 0 %}
                        {{ "{:,.0f}".format(invoice.common_amount) }}ì›
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if invoice.additional_charges %}
                        {% set additional_total = invoice.additional_charges | sum(attribute='amount') %}
                        <div style="font-weight:600;">
                            {{ "{:,}".format(additional_total|int) }}ì›
                        </div>
                        <!-- ê¸°íƒ€ í•­ëª© ìƒì„¸ í‘œì‹œ -->
                        <div class="additional-details">
                            {% for charge in invoice.additional_charges %}
                                <div class="{% if charge.amount > 0 %}charge-item{% else %}refund-item{% endif %}">
                                    {{ charge.description }}: {{ "{:,}".format(charge.amount|int) }}ì›
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right">
                    {% if invoice.unit_memo %}
                        {{ invoice.unit_memo }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-right" style="background: #fef3c7; font-weight: bold; font-size: 1.1em;">
                    {{ "{:,.0f}".format(invoice.total_amount) }}ì›
                </td>
            </tr>
        {% endfor %}
        </tbody>
        <tfoot>
        <tr style="background: #e2e8f0; font-weight: bold;">
            <td>í•©ê³„</td>
            <td>-</td>
            <td class="text-right">{{ "{:,.0f}".format(invoices|sum(attribute='electric_amount')) }}ì›</td>
            <td class="text-right">{{ "{:,.0f}".format(invoices|sum(attribute='water_amount')) }}ì›</td>
            <td class="text-right">{{ "{:,.0f}".format(invoices|sum(attribute='common_amount')) }}ì›</td>
            <td class="text-right">
                {% set total_additional = namespace(value=0) %}
                {% for inv in invoices %}
                    {% if inv.additional_charges %}
                        {% set total_additional.value = total_additional.value + (inv.additional_charges|sum(attribute='amount')) %}
                    {% endif %}
                {% endfor %}
                {% if total_additional.value != 0 %}
                    <span style="color:{{ '#dc2626' if total_additional.value > 0 else '#059669' }};">
                        {{ "+" if total_additional.value > 0 else "" }}{{ "{:,.0f}".format(total_additional.value) }}ì›
                    </span>
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="text-right">-</td>
            <td class="text-right" style="background: #fbbf24; font-size: 1.2em;">
                {{ "{:,.0f}".format(invoices|sum(attribute='total_amount')) }}ì›
            </td>
        </tr>
        </tfoot>
    </table>

    <div style="margin-top: 30px; padding: 20px; background: #dbeafe; border-radius: 12px;">
        <p style="color: #1e40af; margin: 0 0 10px 0;">
            ğŸ’¡ <strong>ì•ˆë‚´:</strong>
            ê° í•­ëª©ë³„ ê¸ˆì•¡ì€ 10ì› ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ ì²˜ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            ê¸°íƒ€ í•­ëª©ì€ ì„¸ëŒ€ë³„ë¡œ ê°œë³„ ë¶€ê³¼ëœ í•­ëª©ì…ë‹ˆë‹¤.
            ì¸ì‡„ìš© ë³´ê¸°ì—ì„œëŠ” ì„¸ëŒ€ë³„ë¡œ ì˜ë¼ì„œ ë°°ë¶€í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ë©ë‹ˆë‹¤.
        </p>
        <p style="color: #1e40af; margin: 0;">
            ğŸ“Œ <strong>[ì´ì›”]</strong> í‘œì‹œê°€ ìˆëŠ” í•­ëª©ì€ ì „ì›” ë¯¸ë‚©ê¸ˆ/ì´ˆê³¼ë‚©ë¶€ë¥¼ ì°¸ê³ ìš©ìœ¼ë¡œ í‘œì‹œí•œ ê²ƒìœ¼ë¡œ,
            ì‹¤ì œ ëˆ„ì  ì”ì•¡ ê³„ì‚° ì‹œì—ëŠ” ì¤‘ë³µ ê³„ì‚°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </div>

{% endblock %}