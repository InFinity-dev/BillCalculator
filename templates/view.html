{% extends "base.html" %}
{% block title %}ì „ì²´ ì¡°íšŒ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
<style>
  .chart-container {
    position: relative;
    height: 400px;
    margin: 20px 0;
    padding: 20px;
    background: #f8fafc;
    border-radius: 12px;
  }

  .chart-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .chart-btn {
    padding: 8px 16px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    color: #64748b;
  }

  .chart-btn.active {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-color: #667eea;
  }

  .chart-btn:hover {
    border-color: #667eea;
  }

  .chart-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-top: 15px;
    font-size: 12px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
  }
</style>
{% endblock %}

{% block content %}
<h1>ğŸ“Š ì „ì²´ ì¡°íšŒ</h1>

<div class="tabs">
  <button class="tab active" onclick="showTab('tab-electric', event)">âš¡ ì „ê¸°</button>
  <button class="tab" onclick="showTab('tab-water', event)">ğŸ’§ ìˆ˜ë„</button>
  <button class="tab" onclick="showTab('tab-common', event)">ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</button>
</div>

<!-- ì „ê¸°ìš”ê¸ˆ íƒ­ -->
<div id="tab-electric" class="tab-content">
  <h2>âš¡ ì „ê¸°ìš”ê¸ˆ</h2>

  <!-- ì „ê¸° ê·¸ë˜í”„ ì„¹ì…˜ -->
  <div style="background:white;padding:20px;border-radius:12px;margin-bottom:30px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
    <h3>ğŸ“ˆ ì‚¬ìš©ëŸ‰ ì¶”ì´</h3>

    <div class="chart-selector">
      <button class="chart-btn active" onclick="switchElectricChart('usage')">ì„¸ëŒ€ë³„ ì‚¬ìš©ëŸ‰</button>
      <button class="chart-btn" onclick="switchElectricChart('trend')">ì›”ë³„ ì‚¬ìš©ëŸ‰ ì¶”ì´</button>
      <button class="chart-btn" onclick="switchElectricChart('cost')">ì›”ë³„ ìš”ê¸ˆ ì¶”ì´</button>
    </div>
    <small style="color:#64748b;display:block;margin-bottom:10px;">ğŸ’¡ ì¸µì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¸µì˜ ë°ì´í„°ë§Œ í‘œì‹œë©ë‹ˆë‹¤</small>
    <div style="margin-bottom:15px;">
      <label style="font-weight:500;margin-right:10px;">ì¸µ ì„ íƒ:</label>
      <select id="electricFloorFilter" onchange="updateElectricChart(currentElectricChartType)" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
        <option value="">ì „ì²´</option>
      </select>
    </div>

    <div class="chart-container">
      <canvas id="electricChart"></canvas>
    </div>

    <div class="chart-legend" id="electricLegend"></div>
  </div>

  <!-- ì „ê¸°ìš”ê¸ˆ ëª©ë¡ -->
  <div id="electricList"></div>
</div>

<!-- ìˆ˜ë„ìš”ê¸ˆ íƒ­ -->
<div id="tab-water" class="tab-content" style="display:none;">
  <h2>ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ</h2>

  <!-- ìˆ˜ë„ ê·¸ë˜í”„ ì„¹ì…˜ -->
  <div style="background:white;padding:20px;border-radius:12px;margin-bottom:30px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
    <h3>ğŸ“ˆ ìš”ê¸ˆ ì¶”ì´</h3>

    <div class="chart-container">
      <canvas id="waterChart"></canvas>
    </div>

    <div class="chart-legend" id="waterLegend"></div>
  </div>

  <!-- ìˆ˜ë„ìš”ê¸ˆ ëª©ë¡ -->
  <div id="waterList"></div>
</div>

<!-- ê³µë™ ê³µê³¼ê¸ˆ íƒ­ -->
<div id="tab-common" class="tab-content" style="display:none;">
  <h2>ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</h2>
  <div id="commonList"></div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
function showTab(id, ev){
  document.querySelectorAll('.tab-content').forEach(x=>x.style.display='none');
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById(id).style.display='block';
  if(ev && ev.target) ev.target.classList.add('active');
}

const electricBills = {{ (electric_bills_json|default([]))|tojson }};
const waterBills = {{ (water_bills_json|default([]))|tojson }};
const commonBills = {{ (common_bills_json|default([]))|tojson }};

let electricChart = null;
let waterChart = null;
let currentElectricChartType = 'usage';

// ìƒ‰ìƒ íŒ”ë ˆíŠ¸
const colors = [
  '#667eea', '#764ba2', '#f093fb', '#4facfe',
  '#43e97b', '#fa709a', '#fee140', '#30cfd0',
  '#a8edea', '#fed6e3', '#ff9671', '#ffd93d'
];

// ì „ê¸° ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
function prepareElectricChartData(type) {
  if (type === 'usage') {
    return prepareElectricUsageData();
  } else if (type === 'trend') {
    return prepareElectricTrendData();
  } else if (type === 'cost') {
    return prepareElectricCostData();
  }
}

// ì„ íƒëœ ì¸µ í•„í„° ê°€ì ¸ì˜¤ê¸°
function getSelectedFloor() {
  return document.getElementById('electricFloorFilter').value;
}

// ì„¸ëŒ€ë³„ ì‚¬ìš©ëŸ‰ (ìµœê·¼ ì •ì‚° ê¸°ì¤€)
function prepareElectricUsageData() {
  if (electricBills.length === 0) {
    return { labels: [], datasets: [] };
  }

  const selectedFloor = getSelectedFloor();

  // ìµœê·¼ ì •ì‚° ì„ íƒ
  let latestBill = electricBills[0];
  if (selectedFloor) {
    latestBill = electricBills.find(b => b.floor_id == selectedFloor) || electricBills[0];
  }

  // ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ì—ì„œ ê°€ì ¸ì˜¨ ì„¸ëŒ€ë³„ ì‚¬ìš©ëŸ‰
  // ë°±ì—”ë“œì—ì„œ electric_bills_detail ë°ì´í„°ë¥¼ í•¨ê»˜ ì œê³µí•´ì•¼ í•¨
  const details = latestBill.details || [];
  const labels = details.map(d => d.unit_name);
  const usage = details.map(d => parseFloat(d.usage_amount) || 0);

  if (labels.length === 0) {
    return { labels: [], datasets: [] };
  }

  return {
    labels: labels,
    datasets: [{
      label: `${latestBill.billing_month.slice(0, 7)} ì‚¬ìš©ëŸ‰ (kWh)`,
      data: usage,
      backgroundColor: colors.slice(0, usage.length),
      borderColor: colors.slice(0, usage.length),
      borderWidth: 2,
      borderRadius: 8,
      tension: 0.4
    }]
  };
}

// ì›”ë³„ ì‚¬ìš©ëŸ‰ ì¶”ì´ (ì„¸ëŒ€ë³„)
function prepareElectricTrendData() {
  if (electricBills.length === 0) {
    return { labels: [], datasets: [] };
  }

  const selectedFloor = getSelectedFloor();

  // ì¸µë³„ í•„í„°ë§
  let filteredBills = selectedFloor
    ? electricBills.filter(b => b.floor_id == selectedFloor)
    : electricBills;

  if (filteredBills.length === 0) {
    return { labels: [], datasets: [] };
  }

  // ì›”ë³„ ì •ë ¬
  const sortedBills = filteredBills.sort((a, b) =>
    new Date(a.billing_month) - new Date(b.billing_month)
  );

  const months = sortedBills.map(b => b.billing_month.slice(0, 7));

  // ëª¨ë“  ì„¸ëŒ€ëª… ìˆ˜ì§‘
  const allUnits = new Set();
  sortedBills.forEach(bill => {
    (bill.details || []).forEach(d => allUnits.add(d.unit_name));
  });

  // ì„¸ëŒ€ë³„ ë°ì´í„°ì…‹ ìƒì„±
  const datasets = Array.from(allUnits).map((unitName, idx) => ({
    label: unitName,
    data: sortedBills.map(bill => {
      const detail = (bill.details || []).find(d => d.unit_name === unitName);
      return detail ? parseFloat(detail.usage_amount) : 0;
    }),
    borderColor: colors[idx % colors.length],
    backgroundColor: colors[idx % colors.length] + '20',
    borderWidth: 2,
    tension: 0.4,
    fill: false,
    pointRadius: 4
  }));

  return {
    labels: months,
    datasets: datasets
  };
}

// ì›”ë³„ ìš”ê¸ˆ ì¶”ì´
function prepareElectricCostData() {
  if (electricBills.length === 0) {
    return { labels: [], datasets: [] };
  }

  const selectedFloor = getSelectedFloor();

  let filteredBills = selectedFloor
    ? electricBills.filter(b => b.floor_id == selectedFloor)
    : electricBills;

  if (filteredBills.length === 0) {
    return { labels: [], datasets: [] };
  }

  const sortedBills = filteredBills.sort((a, b) =>
    new Date(a.billing_month) - new Date(b.billing_month)
  );

  const months = sortedBills.map(b => b.billing_month.slice(0, 7));
  const amounts = sortedBills.map(b => parseFloat(b.total_amount) || 0);
  const tvFees = sortedBills.map(b => parseFloat(b.tv_fee_total) || 0);

  return {
    labels: months,
    datasets: [
      {
        label: 'ì „ê¸°ìš”ê¸ˆ',
        data: amounts,
        borderColor: colors[0],
        backgroundColor: colors[0] + '30',
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointRadius: 5
      },
      {
        label: 'TVìˆ˜ì‹ ë£Œ',
        data: tvFees,
        borderColor: colors[1],
        backgroundColor: colors[1] + '30',
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointRadius: 4
      }
    ]
  };
}

// ìˆ˜ë„ ìš”ê¸ˆ ì¶”ì´
function prepareWaterChartData() {
  if (waterBills.length === 0) {
    return { labels: [], datasets: [] };
  }

  const sortedBills = waterBills.sort((a, b) =>
    new Date(a.billing_month) - new Date(b.billing_month)
  );

  const months = sortedBills.map(b => b.billing_month.slice(0, 7));
  const amounts = sortedBills.map(b => parseFloat(b.total_amount) || 0);

  return {
    labels: months,
    datasets: [
      {
        label: 'ìˆ˜ë„ìš”ê¸ˆ',
        data: amounts,
        borderColor: colors[4],
        backgroundColor: colors[4] + '40',
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointRadius: 5,
        pointBackgroundColor: colors[4]
      }
    ]
  };
}

// ì „ê¸° ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
function updateElectricChart(type) {
  currentElectricChartType = type;
  const ctx = document.getElementById('electricChart').getContext('2d');
  const data = prepareElectricChartData(type);

  // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
  if (electricChart) {
    electricChart.destroy();
  }

  const chartType = (type === 'usage') ? 'bar' : 'line';

  electricChart = new Chart(ctx, {
    type: chartType,
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          padding: 12,
          titleFont: { size: 14 },
          bodyFont: { size: 12 },
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString() +
                (type === 'usage' ? 'kWh' : 'ì›');
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // ë²”ë¡€ ì—…ë°ì´íŠ¸
  updateLegend('electricLegend', data.datasets);
}

// ìˆ˜ë„ ì°¨íŠ¸ ìƒì„±
function updateWaterChart() {
  const ctx = document.getElementById('waterChart').getContext('2d');
  const data = prepareWaterChartData();

  if (waterChart) {
    waterChart.destroy();
  }

  waterChart = new Chart(ctx, {
    type: 'line',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          padding: 12,
          titleFont: { size: 14 },
          bodyFont: { size: 12 },
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString() + 'ì›';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString() + 'ì›';
            }
          }
        }
      }
    }
  });

  updateLegend('waterLegend', data.datasets);
}

// ë²”ë¡€ ì—…ë°ì´íŠ¸
function updateLegend(elementId, datasets) {
  const legend = document.getElementById(elementId);
  legend.innerHTML = datasets.map((ds, idx) => `
    <div class="legend-item">
      <div class="legend-color" style="background-color: ${ds.borderColor || ds.backgroundColor}"></div>
      <span>${ds.label}</span>
    </div>
  `).join('');
}

// ì°¨íŠ¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function switchElectricChart(type) {
  document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updateElectricChart(type);
}

// ì „ê¸°ìš”ê¸ˆ ëª©ë¡ ë Œë”ë§
function renderElectric(){
  const el = document.getElementById('electricList');
  if(!electricBills.length){
    el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ì •ì‚°ì›”</th>
          <th>ê³ ì§€ì›” ì •ë³´</th>
          <th>ì¸µ</th>
          <th>ì´ì•¡</th>
          <th>ë³µì§€</th>
          <th>ë°”ìš°ì²˜</th>
          <th>TV</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        ${electricBills.map(b => `
          <tr>
            <td>${b.billing_month.slice(0,7)}</td>
            <td style="min-width:200px;" title="${b.monthly_details ? b.monthly_details.map(m => m.month ? m.month.substring(0, 7) : '-').join(', ') : ''}">
              ${formatMonthlyDetails(b)}
            </td>
            <td>${b.floor_name || ''}</td>
            <td style="text-align:right">${Number(b.total_amount).toLocaleString()}ì›</td>
            <td style="text-align:right">${Number(b.welfare_discount||0).toLocaleString()}ì›</td>
            <td style="text-align:right">${Number(b.voucher_discount||0).toLocaleString()}ì›</td>
            <td style="text-align:right">${Number(b.tv_fee_total||0).toLocaleString()}ì›</td>
            <td style="white-space:nowrap;">
              <a href="/view/electric/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
              <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('electric', ${b.id})">ì‚­ì œ</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// ìˆ˜ë„ìš”ê¸ˆ ëª©ë¡ ë Œë”ë§
function renderWater(){
  const el = document.getElementById('waterList');
  if(!waterBills.length){
    el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  el.innerHTML = '<table><thead><tr><th>ì›”</th><th>ì´ì•¡</th><th>ë³µì§€í•©ê³„</th><th>ì‘ì—…</th></tr></thead><tbody>' +
    waterBills.map(b=>`<tr>
      <td>${b.billing_month.slice(0,7)}</td>
      <td style="text-align:right">${Number(b.total_amount).toLocaleString()}ì›</td>
      <td style="text-align:right">${Number(b.welfare_discount_total||0).toLocaleString()}ì›</td>
      <td>
        <a href="/view/water/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
        <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('water', ${b.id})">ì‚­ì œ</button>
      </td>
    </tr>`).join('') + '</tbody></table>';
}

// ê³µë™ ê³µê³¼ê¸ˆ ëª©ë¡ ë Œë”ë§
function renderCommon(){
  const el = document.getElementById('commonList');
  if(!commonBills.length){
    el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  el.innerHTML = '<table><thead><tr><th>ì›”</th><th>ì„¤ëª…</th><th>ì´ì•¡</th><th>ë¶„ë°° ë°©ì‹</th><th>ì‘ì—…</th></tr></thead><tbody>' +
    commonBills.map(b=>`<tr>
      <td>${b.billing_month.slice(0,7)}</td>
      <td>${b.description||''}</td>
      <td style="text-align:right">${Number(b.total_amount).toLocaleString()}ì›</td>
      <td>${b.distribution_method === 'BY_RESIDENTS' ? 'ì¸ì›ìˆ˜ ë¹„ë¡€' : 'ì„¸ëŒ€ ê· ë“±'}</td>
      <td>
        <a href="/view/common/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
        <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('common', ${b.id})">ì‚­ì œ</button>
      </td>
    </tr>`).join('') + '</tbody></table>';
}

// ì›”ë³„ ì •ë³´ í¬ë§·íŒ…
function formatMonthlyDetails(bill) {
  if (!bill.monthly_details || !Array.isArray(bill.monthly_details) || bill.monthly_details.length === 0) {
    return '<span style="color:#94a3b8;">-</span>';
  }

  const months = bill.monthly_details
    .map(m => m.month ? m.month.substring(0, 7) : '-')
    .filter(m => m !== '-');

  if (months.length === 0) {
    return '<span style="color:#94a3b8;">-</span>';
  }

  if (months.length === 1) {
    return `<span style="color:#334155;">${months[0]}</span>`;
  }

  return `<div style="display:flex;align-items:center;gap:8px;">
    <span style="color:#667eea;font-weight:600;">${months.length}ê°œì›” ë¬¶ìŒ</span>
    <div style="font-size:12px;color:#64748b;">
      ${months.join(', ')}
    </div>
  </div>`;
}

// ì‚­ì œ í•¨ìˆ˜
async function deleteBill(type, id) {
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  const fd = new FormData();
  fd.append('_csrf_token', getCsrfToken());

  const res = await fetch(`/bills/delete/${type}/${id}`, {
    method: 'POST',
    body: fd
  });

  const j = await res.json();
  alert(j.message || (j.success ? 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚­ì œ ì‹¤íŒ¨'));
  if(j.success) location.reload();
}

// ì´ˆê¸° ë Œë”ë§
renderFloorFilter();
renderElectric();
renderWater();
renderCommon();
updateElectricChart('usage');
updateWaterChart();

// ì¸µ í•„í„° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
function renderFloorFilter() {
  const select = document.getElementById('electricFloorFilter');
  const floors = [...new Set(electricBills.map(b => ({ id: b.floor_id, name: b.floor_name })))];

  floors.forEach(floor => {
    const option = document.createElement('option');
    option.value = floor.id;
    option.textContent = floor.name;
    select.appendChild(option);
  });
}
</script>
{% endblock %}