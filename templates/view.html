{% extends "base.html" %}
{% block title %}ì „ì²´ ì¡°íšŒ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
<h1>ğŸ“Š ì „ì²´ ì¡°íšŒ</h1>

<div class="tabs">
  <button class="tab active" onclick="showTab('tab-electric', event)">ì „ê¸°</button>
  <button class="tab" onclick="showTab('tab-water', event)">ìˆ˜ë„</button>
  <button class="tab" onclick="showTab('tab-common', event)">ê³µë™ ê³µê³¼ê¸ˆ</button>
</div>

<div id="tab-electric" class="tab-content">
  <h2>âš¡ ì „ê¸°ìš”ê¸ˆ</h2>
  <div id="electricList"></div>
</div>

<div id="tab-water" class="tab-content" style="display:none;">
  <h2>ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ</h2>
  <div id="waterList"></div>
</div>

<div id="tab-common" class="tab-content" style="display:none;">
  <h2>ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</h2>
  <div id="commonList"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showTab(id, ev){
  document.querySelectorAll('.tab-content').forEach(x=>x.style.display='none');
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.getElementById(id).style.display='block';
  if(ev && ev.target) ev.target.classList.add('active');
}

const electricBills = {{ (electric_bills_json|default([]))|tojson }};
const waterBills = {{ (water_bills_json|default([]))|tojson }};
const commonBills = {{ (common_bills_json|default([]))|tojson }};

async function deleteBill(type, id) {
  if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  const fd = new FormData();
  fd.append('_csrf_token', getCsrfToken());

  const res = await fetch(`/bills/delete/${type}/${id}`, {
    method: 'POST',
    body: fd
  });

  const j = await res.json();
  alert(j.message || (j.success ? 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚­ì œ ì‹¤íŒ¨'));
  if(j.success) location.reload();
}

// ğŸ”§ ê°œì„ : ì›”ë³„ ê³ ì§€ ì •ë³´ë¥¼ íŒŒì‹±í•˜ì—¬ í‘œì‹œ
function formatMonthlyDetails(bill) {
  if (!bill.monthly_details || !Array.isArray(bill.monthly_details) || bill.monthly_details.length === 0) {
    return '<span style="color:#94a3b8;">-</span>';
  }

  const months = bill.monthly_details
    .map(m => m.month ? m.month.substring(0, 7) : '-')
    .filter(m => m !== '-');

  if (months.length === 0) {
    return '<span style="color:#94a3b8;">-</span>';
  }

  if (months.length === 1) {
    return `<span style="color:#334155;">${months[0]}</span>`;
  }

  // ì—¬ëŸ¬ ê°œì›”ì¸ ê²½ìš°
  return `<div style="display:flex;align-items:center;gap:8px;">
    <span style="color:#667eea;font-weight:600;">${months.length}ê°œì›” ë¬¶ìŒ</span>
    <div style="font-size:12px;color:#64748b;">
      ${months.join(', ')}
    </div>
  </div>`;
}

// ğŸ”§ ê°œì„ : ì›”ë³„ ìƒì„¸ ì •ë³´ íˆ´íŒ
function getMonthlyDetailsTooltip(bill) {
  if (!bill.monthly_details || !Array.isArray(bill.monthly_details)) {
    return '';
  }

  const details = bill.monthly_details.map(m => {
    const month = m.month ? m.month.substring(0, 7) : '-';
    const amount = Number(m.amount || 0).toLocaleString();
    const welfare = Number(m.welfare || 0).toLocaleString();
    const voucher = Number(m.voucher || 0).toLocaleString();
    return `${month}: ${amount}ì› (ë³µì§€ ${welfare}ì›, ë°”ìš°ì²˜ ${voucher}ì›)`;
  }).join('\n');

  return `title="${details}"`;
}

function renderElectric(){
  const el = document.getElementById('electricList');
  if(!electricBills.length){
    el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ì •ì‚°ì›”</th>
          <th>ê³ ì§€ì›” ì •ë³´</th>
          <th>ì¸µ</th>
          <th>ì´ì•¡</th>
          <th>ë³µì§€</th>
          <th>ë°”ìš°ì²˜</th>
          <th>TV</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        ${electricBills.map(b => `
          <tr>
            <td>${b.billing_month.slice(0,7)}</td>
            <td style="min-width:200px;" ${getMonthlyDetailsTooltip(b)}>
              ${formatMonthlyDetails(b)}
            </td>
            <td>${b.floor_name || ''}</td>
            <td style="text-align:right">${Number(b.total_amount).toLocaleString()}ì›</td>
            <td style="text-align:right">${Number(b.welfare_discount||0).toLocaleString()}ì›</td>
            <td style="text-align:right">${Number(b.voucher_discount||0).toLocaleString()}ì›</td>
            <td style="text-align:right">${Number(b.tv_fee_total||0).toLocaleString()}ì›</td>
            <td style="white-space:nowrap;">
              <a href="/view/electric/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
              <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('electric', ${b.id})">ì‚­ì œ</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

function renderWater(){
  const el = document.getElementById('waterList');
  if(!waterBills.length){
    el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  el.innerHTML = '<table><thead><tr><th>ì›”</th><th>ì´ì•¡</th><th>ë³µì§€í•©ê³„</th><th>ì‘ì—…</th></tr></thead><tbody>' +
    waterBills.map(b=>`<tr>
      <td>${b.billing_month.slice(0,7)}</td>
      <td style="text-align:right">${Number(b.total_amount).toLocaleString()}ì›</td>
      <td style="text-align:right">${Number(b.welfare_discount_total||0).toLocaleString()}ì›</td>
      <td>
        <a href="/view/water/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
        <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('water', ${b.id})">ì‚­ì œ</button>
      </td>
    </tr>`).join('') + '</tbody></table>';
}

function renderCommon(){
  const el = document.getElementById('commonList');
  if(!commonBills.length){
    el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  el.innerHTML = '<table><thead><tr><th>ì›”</th><th>ì„¤ëª…</th><th>ì´ì•¡</th><th>ë¶„ë°° ë°©ì‹</th><th>ì‘ì—…</th></tr></thead><tbody>' +
    commonBills.map(b=>`<tr>
      <td>${b.billing_month.slice(0,7)}</td>
      <td>${b.description||''}</td>
      <td style="text-align:right">${Number(b.total_amount).toLocaleString()}ì›</td>
      <td>${b.distribution_method === 'BY_RESIDENTS' ? 'ì¸ì›ìˆ˜ ë¹„ë¡€' : 'ì„¸ëŒ€ ê· ë“±'}</td>
      <td>
        <a href="/view/common/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
        <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('common', ${b.id})">ì‚­ì œ</button>
      </td>
    </tr>`).join('') + '</tbody></table>';
}

renderElectric();
renderWater();
renderCommon();
</script>
{% endblock %}