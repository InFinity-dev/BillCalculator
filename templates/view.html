{% extends "base.html" %}
{% block title %}ì „ì²´ ì¡°íšŒ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            margin: var(--space-xl) 0;
            padding: var(--space-xl);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .chart-info {
            background: var(--info-bg);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            border-left: 4px solid var(--info-color);
        }

        .chart-info p {
            margin: 0;
            color: var(--info-dark);
            font-size: var(--font-small);
            line-height: 1.6;
        }

        /* ê°œì„ ëœ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table th {
            background: var(--gray-100) !important;
            font-weight: 600 !important;
            color: var(--gray-700) !important;
            border-bottom: 2px solid var(--gray-300) !important;
            white-space: nowrap;
            padding: var(--space-md) var(--space-lg) !important;
        }

        /* ê¸ˆì•¡ ì»¬ëŸ¼ í—¤ë”ë„ ìš°ì¸¡ ì •ë ¬ */
        table th.text-right {
            text-align: right !important;
        }

        /* ê¸ˆì•¡ ë°ì´í„° ìš°ì¸¡ ì •ë ¬ */
        table td.text-right {
            text-align: right !important;
            font-weight: 500;
        }

        /* í…Œì´ë¸” í˜¸ë²„ íš¨ê³¼ ê°œì„  */
        table tbody tr:hover {
            background: var(--gray-50) !important;
            transition: var(--transition-fast);
        }

        /* í• ì¸ ê¸ˆì•¡ ìŠ¤íƒ€ì¼ */
        .discount-amount {
            color: var(--success-dark);
            font-weight: 600;
        }

        /* TV ìˆ˜ì‹ ë£Œ ìŠ¤íƒ€ì¼ */
        .tv-fee-amount {
            color: var(--danger-dark);
            font-weight: 600;
        }

        /* ì‘ì—… ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        .action-buttons {
            white-space: nowrap;
            display: flex;
            gap: var(--space-xs);
            justify-content: flex-end;
        }

        /* ê³ ì§€ì›” ì •ë³´ ì…€ ìŠ¤íƒ€ì¼ */
        td .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-xs) var(--space-md);
            font-size: var(--font-xs);
            font-weight: 600;
            white-space: nowrap;
        }

        /* ì›” ëª©ë¡ ë˜í¼ */
        .month-list-wrapper {
            display: inline-flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            align-items: center;
        }
    </style>
{% endblock %}

{% block content %}
    <h1><span class="emoji">ğŸ“Š</span> ì „ì²´ ì¡°íšŒ</h1>

    <div class="tabs">
        <button class="tab active" onclick="showTab('tab-electric', event)">âš¡ ì „ê¸°</button>
        <button class="tab" onclick="showTab('tab-water', event)">ğŸ’§ ìˆ˜ë„</button>
        <button class="tab" onclick="showTab('tab-common', event)">ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</button>
    </div>
    <div class="tabs-container">
        <!-- ì „ê¸°ìš”ê¸ˆ íƒ­ -->
        <div id="tab-electric" class="tab-content">
            <h2>âš¡ ì „ê¸°ìš”ê¸ˆ</h2>

            <!-- ì „ê¸° ê·¸ë˜í”„ ì„¹ì…˜ -->
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:30px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                <h3>ğŸ“ˆ ê³ ì§€ì›”ë³„ ì „ê¸°ìš”ê¸ˆ ì¶”ì´ (ì¸µë³„)</h3>

                <div class="chart-info">
                    <p>
                        ğŸ’¡ ê° ì •ì‚°ì›”ì— í¬í•¨ëœ ê³ ì§€ì›”ë³„ ìˆœìˆ˜ ì „ê¸°ìš”ê¸ˆ(TVìˆ˜ì‹ ë£Œ ì œì™¸)ì„ ì¸µë³„ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.<br>
                        ğŸ“Š <strong>ë²”ë¡€ë¥¼ í´ë¦­</strong>í•˜ì—¬ íŠ¹ì • ì¸µì˜ ë°ì´í„°ë¥¼ ìˆ¨ê¸°ê±°ë‚˜ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>

                <div class="chart-container">
                    <canvas id="electricChart"></canvas>
                </div>
            </div>

            <!-- ì „ê¸°ìš”ê¸ˆ ëª©ë¡ -->
            <div id="electricList"></div>
        </div>

        <!-- ìˆ˜ë„ìš”ê¸ˆ íƒ­ -->
        <div id="tab-water" class="tab-content">
            <h2>ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ</h2>

            <!-- ìˆ˜ë„ ê·¸ë˜í”„ ì„¹ì…˜ -->
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:30px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                <h3>ğŸ“ˆ ìš”ê¸ˆ ì¶”ì´</h3>

                <div class="chart-container">
                    <canvas id="waterChart"></canvas>
                </div>
            </div>

            <!-- ìˆ˜ë„ìš”ê¸ˆ ëª©ë¡ -->
            <div id="waterList"></div>
        </div>

        <!-- ê³µë™ ê³µê³¼ê¸ˆ íƒ­ -->
        <div id="tab-common" class="tab-content">
            <h2>ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</h2>
            <div id="commonList"></div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        function showTab(id, ev){
            document.querySelectorAll('.tab-content').forEach(x=>x.style.display='none');
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            document.getElementById(id).style.display='block';
            if(ev && ev.target) ev.target.classList.add('active');
        }

        const electricBills = {{ (electric_bills_json|default([]))|tojson }};
        const waterBills = {{ (water_bills_json|default([]))|tojson }};
        const commonBills = {{ (common_bills_json|default([]))|tojson }};

        let electricChart = null;
        let waterChart = null;

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe',
            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#ff9671', '#ffd93d'
        ];

        // ì „ê¸° ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ (ì¸µë³„ ê³ ì§€ì›” ì „ê¸°ìš”ê¸ˆ ì¶”ì´)
        function prepareElectricChartData() {
            if (electricBills.length === 0) {
                return { labels: [], datasets: [] };
            }

            // ì¸µë³„ë¡œ ê·¸ë£¹í™”
            const floorDataMap = new Map();

            electricBills.forEach(bill => {
                const floorId = bill.floor_id;
                const floorName = bill.floor_name || `ì¸µ ${floorId}`;

                if (!floorDataMap.has(floorId)) {
                    floorDataMap.set(floorId, {
                        floor_name: floorName,
                        monthlyData: new Map()
                    });
                }

                const floorData = floorDataMap.get(floorId);

                if (bill.monthly_details && Array.isArray(bill.monthly_details)) {
                    bill.monthly_details.forEach(detail => {
                        if (detail.month) {
                            const monthKey = detail.month.substring(0, 7);
                            const amount = parseFloat(detail.amount || 0);

                            if (floorData.monthlyData.has(monthKey)) {
                                floorData.monthlyData.set(monthKey, floorData.monthlyData.get(monthKey) + amount);
                            } else {
                                floorData.monthlyData.set(monthKey, amount);
                            }
                        }
                    });
                }
            });

            const allMonths = new Set();
            floorDataMap.forEach(floorData => {
                floorData.monthlyData.forEach((amount, month) => {
                    allMonths.add(month);
                });
            });
            const sortedMonths = Array.from(allMonths).sort();

            if (sortedMonths.length === 0) {
                return { labels: [], datasets: [] };
            }

            const datasets = [];
            let colorIndex = 0;

            floorDataMap.forEach((floorData, floorId) => {
                const data = sortedMonths.map(month => {
                    return floorData.monthlyData.get(month) || 0;
                });

                datasets.push({
                    label: floorData.floor_name,
                    data: data,
                    borderColor: colors[colorIndex % colors.length],
                    backgroundColor: colors[colorIndex % colors.length] + '30',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 5,
                    pointBackgroundColor: colors[colorIndex % colors.length],
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                });

                colorIndex++;
            });

            return {
                labels: sortedMonths,
                datasets: datasets
            };
        }

        // ìˆ˜ë„ ìš”ê¸ˆ ì¶”ì´
        function prepareWaterChartData() {
            if (waterBills.length === 0) {
                return { labels: [], datasets: [] };
            }

            const sortedBills = waterBills.sort((a, b) =>
                new Date(a.billing_month) - new Date(b.billing_month)
            );

            const months = sortedBills.map(b => b.billing_month.slice(0, 7));
            const amounts = sortedBills.map(b => parseFloat(b.total_amount) || 0);

            return {
                labels: months,
                datasets: [
                    {
                        label: 'ìˆ˜ë„ìš”ê¸ˆ',
                        data: amounts,
                        borderColor: colors[4],
                        backgroundColor: colors[4] + '40',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: colors[4]
                    }
                ]
            };
        }

        // ì „ê¸° ì°¨íŠ¸ ìƒì„±/ì—…ë°ì´íŠ¸
        function updateElectricChart() {
            const ctx = document.getElementById('electricChart').getContext('2d');
            const data = prepareElectricChartData();

            if (electricChart) {
                electricChart.destroy();
            }

            electricChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            onClick: function(e, legendItem, legend) {
                                const index = legendItem.datasetIndex;
                                const chart = legend.chart;
                                const meta = chart.getDatasetMeta(index);

                                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;

                                chart.update();
                            },
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 13
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString() + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ì›';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ìˆ˜ë„ ì°¨íŠ¸ ìƒì„±
        function updateWaterChart() {
            const ctx = document.getElementById('waterChart').getContext('2d');
            const data = prepareWaterChartData();

            if (waterChart) {
                waterChart.destroy();
            }

            waterChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 12 },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString() + 'ì›';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ì›';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ì „ê¸°ìš”ê¸ˆ ëª©ë¡ ë Œë”ë§
        function renderElectric(){
            const el = document.getElementById('electricList');
            if(!electricBills.length){
                el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ì •ì‚°ì›”</th>
          <th style="min-width:220px;">ê³ ì§€ì›” ì •ë³´</th>
          <th>ì¸µ</th>
          <th class="text-right">ì´ì•¡</th>
          <th class="text-right">ë³µì§€í• ì¸</th>
          <th class="text-right">ë°”ìš°ì²˜í• ì¸</th>
          <th class="text-right">TVìˆ˜ì‹ ë£Œ</th>
          <th>ì„¸ëŒ€ìˆ˜</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        ${electricBills.map(b => `
          <tr>
            <td><strong>${b.billing_month.slice(0,7)}</strong></td>
            <td style="min-width:220px;">
              ${formatMonthlyDetails(b)}
            </td>
            <td>${b.floor_name || ''}</td>
            <td class="text-right">${Number(b.total_amount).toLocaleString()}ì›</td>
            <td class="text-right discount-amount">
              ${Number(b.welfare_discount||0) > 0 ? '-' + Number(b.welfare_discount).toLocaleString() + 'ì›' : '-'}
            </td>
            <td class="text-right discount-amount">
              ${Number(b.voucher_discount||0) > 0 ? '-' + Number(b.voucher_discount).toLocaleString() + 'ì›' : '-'}
            </td>
            <td class="text-right tv-fee-amount">
              ${Number(b.tv_fee_total||0) > 0 ? '+' + Number(b.tv_fee_total).toLocaleString() + 'ì›' : '-'}
            </td>
            <td>${b.details.length}ì„¸ëŒ€</td>
            <td>
              <div class="action-buttons">
                <a href="/view/electric/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
                <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('electric', ${b.id})">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
        }

        // ìˆ˜ë„ìš”ê¸ˆ ëª©ë¡ ë Œë”ë§
        function renderWater(){
            const el = document.getElementById('waterList');
            if(!waterBills.length){
                el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ì •ì‚°ì›”</th>
          <th class="text-right">ì´ì•¡</th>
          <th class="text-right">ë³µì§€í• ì¸í•©ê³„</th>
          <th>ì„¸ëŒ€ìˆ˜</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        ${waterBills.map(b=>`
          <tr>
            <td>${b.billing_month.slice(0,7)}</td>
            <td class="text-right">${Number(b.total_amount).toLocaleString()}ì›</td>
            <td class="text-right discount-amount">
              ${Number(b.welfare_discount_total||0) > 0 ? '-' + Number(b.welfare_discount_total).toLocaleString() + 'ì›' : '-'}
            </td>
            <td>${b.unit_count || 0}ì„¸ëŒ€</td>
            <td>
              <div class="action-buttons">
                <a href="/view/water/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
                <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('water', ${b.id})">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
        }

        // ê³µë™ ê³µê³¼ê¸ˆ ëª©ë¡ ë Œë”ë§
        function renderCommon(){
            const el = document.getElementById('commonList');
            if(!commonBills.length){
                el.innerHTML = '<p style="color:#94a3b8;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            el.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ì •ì‚°ì›”</th>
          <th>í•­ëª©</th>
          <th class="text-right">ì´ì•¡</th>
          <th>ë¶„ë°° ë°©ì‹</th>
          <th>ì„¸ëŒ€ìˆ˜</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        ${commonBills.map(b=>`
          <tr>
            <td>${b.billing_month.slice(0,7)}</td>
            <td>${b.description||''}</td>
            <td class="text-right">${Number(b.total_amount).toLocaleString()}ì›</td>
            <td>${b.distribution_method === 'BY_RESIDENTS' ? 'ì¸ì›ìˆ˜ ë¹„ë¡€' : 'ì„¸ëŒ€ ê· ë“±'}</td>
            <td>${b.unit_count || 0}ì„¸ëŒ€</td>
            <td>
              <div class="action-buttons">
                <a href="/view/common/${b.id}" class="btn btn-secondary" style="padding:5px 10px;">ìƒì„¸</a>
                <button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteBill('common', ${b.id})">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
        }

        // ì›”ë³„ ì •ë³´ í¬ë§·íŒ…
        function formatMonthlyDetails(bill) {
            if (!bill.monthly_details || !Array.isArray(bill.monthly_details) || bill.monthly_details.length === 0) {
                return '<span style="color:#94a3b8;">-</span>';
            }

            const months = bill.monthly_details
                .map(m => m.month ? m.month.substring(0, 7) : '-')
                .filter(m => m !== '-');

            if (months.length === 0) {
                return '<span style="color:#94a3b8;">-</span>';
            }

            if (months.length === 1) {
                return `<span style="color:#64748b;">ë‹¨ì¼ ì›”</span>`;
            }

            return `
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
      <span class="badge badge-primary" style="font-size:13px;">${months.length}ê°œì›” ë¬¶ìŒ</span>
      <div style="font-size:12px;color:#64748b;line-height:1.5;">
        ${months.join(', ')}
      </div>
    </div>
  `;
        }

        // ì‚­ì œ í•¨ìˆ˜
        async function deleteBill(type, id) {
            if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const fd = new FormData();
            fd.append('_csrf_token', getCsrfToken());

            const res = await fetch(`/bills/delete/${type}/${id}`, {
                method: 'POST',
                body: fd
            });

            const j = await res.json();
            alert(j.message || (j.success ? 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚­ì œ ì‹¤íŒ¨'));
            if(j.success) location.reload();
        }

        // ì´ˆê¸° ë Œë”ë§
        renderElectric();
        renderWater();
        renderCommon();
        updateElectricChart();
        updateWaterChart();
    </script>
{% endblock %}