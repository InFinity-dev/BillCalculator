{% extends "base.html" %}
{% block title %}ê³„ì‚° - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
<h1>ğŸ§® ê³„ì‚°</h1>

<div class="grid grid-2">
  <div style="background:#f8fafc;padding:16px;border-radius:12px;">
    <h3>ìš”ì•½</h3>
    <ul>
      <li>ì´ ì„¸ëŒ€: <strong>{{ total_units }}</strong></li>
      <li>ì¬ì‹¤ ì„¸ëŒ€: <strong>{{ occupied_units }}</strong></li>
      <li>ê³µì‹¤ ì„¸ëŒ€: <strong>{{ vacant_units }}</strong></li>
      <li>ì´ ê±°ì£¼ ì¸ì›: <strong>{{ total_residents }}</strong></li>
    </ul>
  </div>
  <div style="background:#f8fafc;padding:16px;border-radius:12px;">
    <h3>ë¹ ë¥¸ ì„ íƒ</h3>
    <label>ì¸µ ì„ íƒ</label>
    <select id="floorSelect"></select>
    <small style="display:block;color:#64748b;margin-top:8px;">ì¸µì„ ì„ íƒí•˜ë©´ ì „ê¸° ê²€ì¹¨ ì…ë ¥ í‘œê°€ í•´ë‹¹ ì¸µ ì„¸ëŒ€ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</small>
  </div>
</div>

<!-- ì „ê¸°ìš”ê¸ˆ -->
<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">âš¡ ì „ê¸°ìš”ê¸ˆ ê³„ì‚°</h2>
  <form id="electricForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="month_count" id="month_count" value="0">

    <div class="grid grid-3">
      <div class="form-group">
        <label>ì •ì‚°ì›” (ì‹œì‘ì›”)</label>
        <input type="month" name="billing_month" id="billing_month" required>
      </div>
      <div class="form-group">
        <label>ì¸µ</label>
        <select name="floor_id" id="electric_floor_id" required></select>
      </div>
      <div class="form-group">
        <label>TV ìˆ˜ì‹ ë£Œ ë°°ë¶„</label>
        <select name="tv_distribution_mode" id="tv_mode">
          <option value="INDIVIDUAL">ê°œë³„ ë¶€ê³¼ (TV ë³´ìœ  ì„¸ëŒ€ë§Œ)</option>
          <option value="EQUAL">ê· ë“± ë¶„ë°° (ì¬ì‹¤ ì„¸ëŒ€ ì „ì²´)</option>
        </select>
      </div>
    </div>

    <!-- ì›”ë³„ ìƒì„¸ ì…ë ¥ -->
    <div style="margin-top:20px; background:#f0f4f8; padding:15px; border-radius:8px;">
      <h4>ì›”ë³„ ê³ ì§€ ë‚´ì—­ ì…ë ¥</h4>
      <div id="monthlyBillsContainer"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
        <button type="button" class="btn btn-secondary" onclick="addMonthRow()">+ ì›” ì¶”ê°€</button>
        <button type="button" class="btn" onclick="addConsecutiveMonths(3)">+ 3ê°œì›”</button>
        <button type="button" class="btn" onclick="addConsecutiveMonths(6)">+ 6ê°œì›”</button>
        <button type="button" class="btn" onclick="clearMonthRows()">í–‰ ì§€ìš°ê¸°</button>
      </div>
      <div style="margin-top:15px; padding:10px; background:#e7f3ff; border-radius:5px;">
        <strong>í•©ê³„:</strong>
        ì´ì•¡ <span id="totalAmount">0</span>ì› |
        ë³µì§€í• ì¸ <span id="totalWelfare">0</span>ì› |
        ë°”ìš°ì²˜í• ì¸ <span id="totalVoucher">0</span>ì› |
        TVìˆ˜ì‹ ë£Œ <span id="totalTvFee">0</span>ì›
      </div>
      <small style="color:#64748b;display:block;margin-top:8px;">
        TVìˆ˜ì‹ ë£ŒëŠ” ì›”ë³„ë¡œ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´, í•„ìš” ì‹œ ë°±ì—”ë“œì—ì„œ "TVëŒ€ìˆ˜ Ã— ì„¤ì •ëœ ì„¸ëŒ€ë‹¹ TV ìˆ˜ì‹ ë£Œ"ë¡œ ì‚°ì •ë©ë‹ˆë‹¤.
      </small>
    </div>

    <div class="form-group" style="margin-top:10px;">
      <label class="checkbox-wrapper">
        <input type="checkbox" name="overwrite">
        <span>ê¸°ì¡´ ì •ì‚° ë®ì–´ì“°ê¸°</span>
      </label>
    </div>

    <div id="readingTableWrap" style="margin-top:16px;"></div>

    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
      <button type="button" class="btn" onclick="loadPrevReadings()">ì´ì „ ì •ì‚° í˜„ì›”ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button type="submit" class="btn btn-primary">ì „ê¸°ìš”ê¸ˆ ê³„ì‚° ì €ì¥</button>
    </div>
  </form>
</div>

<!-- ìˆ˜ë„ìš”ê¸ˆ -->
<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ ê³„ì‚°</h2>
  <form id="waterForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>ì •ì‚°ì›”</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>ìˆ˜ë„ ì´ì•¡ (ì£¼íƒ)</label>
        <input type="number" name="total_amount" min="0" required>
      </div>
      <div class="form-group">
        <label>ë³µì§€ í• ì¸ ì´ì•¡</label>
        <input type="number" name="welfare_discount_total" min="0" value="0" required>
      </div>
      <div class="form-group" style="align-self:end;">
        <label style="visibility:hidden;">ì¤‘ë³µ ì²˜ë¦¬</label>
        <label class="checkbox-wrapper"><input type="checkbox" name="overwrite"><span>ê¸°ì¡´ ì •ì‚° ë®ì–´ì“°ê¸°</span></label>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">ìˆ˜ë„ìš”ê¸ˆ ê³„ì‚° ì €ì¥</button>
    </div>
  </form>
</div>

<!-- ê³µë™ ê³µê³¼ê¸ˆ -->
<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</h2>
  <form id="commonForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>ì •ì‚°ì›”</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>í•­ëª© ì„¤ëª…</label>
        <input type="text" name="description" placeholder="ì˜ˆ: ì²­ì†Œë¹„, ì—˜ë¦¬ë² ì´í„° ìœ ì§€ë³´ìˆ˜ ë“±" required>
      </div>
      <div class="form-group">
        <label>ì´ì•¡</label>
        <input type="number" name="total_amount" min="0" required>
      </div>
      <div class="form-group">
        <label>ë¶„ë°° ë°©ì‹</label>
        <select name="distribution_method">
          <option value="BY_RESIDENTS">ì¸ì›ìˆ˜ ë¹„ë¡€</option>
          <option value="BY_UNITS">ì„¸ëŒ€ ê· ë“±</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">ê³µë™ ê³µê³¼ê¸ˆ ì €ì¥</button>
    </div>
  </form>
</div>

{% endblock %}

{% block scripts %}
<script>
const FLOORS = {{ (floors_json|default([]))|tojson }};
const UNITS = {{ (units_json|default([]))|tojson }};

let monthRowCount = 0;

function renderFloorOptions(){
  const sel1 = document.getElementById('floorSelect');
  const sel2 = document.getElementById('electric_floor_id');
  [sel1, sel2].forEach(sel => {
    sel.innerHTML = '<option value="">ì„ íƒ</option>' + FLOORS.map(f => `<option value="${f.id}">${f.name || (f.floor_number < 0 ? 'B' + (-f.floor_number) + 'ì¸µ' : f.floor_number + 'ì¸µ')}</option>`).join('');
  });
}

function monthValuePlus(baseYYYYMM, offset){
  const [y,m] = baseYYYYMM.split('-').map(Number);
  const d = new Date(y, m - 1 + offset, 1);
  return d.toISOString().slice(0,7);
}

function addMonthRow(){
  const container = document.getElementById('monthlyBillsContainer');
  const base = document.getElementById('billing_month').value;
  if(!base){ alert('ë¨¼ì € ì •ì‚°ì›”(ì‹œì‘ì›”)ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

  const rowIndex = monthRowCount;
  const targetMonth = monthValuePlus(base, rowIndex);

  const row = document.createElement('div');
  row.className = 'month-row';
  row.style.cssText = 'display:grid; grid-template-columns: 1fr 2fr 2fr 2fr 2fr 1.5fr 1fr; gap:10px; margin-bottom:10px; padding:10px; background:white; border-radius:5px;';
  row.innerHTML = `
    <input type="month" name="month_${rowIndex}" value="${targetMonth}" readonly style="background:#f0f0f0;">
    <input type="number" name="amount_${rowIndex}" placeholder="ì „ê¸°ìš”ê¸ˆ" min="0" step="0.01" onchange="calculateTotals()">
    <input type="number" name="welfare_${rowIndex}" placeholder="ë³µì§€í• ì¸" min="0" step="0.01" onchange="calculateTotals()">
    <input type="number" name="voucher_${rowIndex}" placeholder="ë°”ìš°ì²˜í• ì¸" min="0" step="0.01" onchange="calculateTotals()">
    <input type="number" name="tv_fee_${rowIndex}" placeholder="TVìˆ˜ì‹ ë£Œ" min="0" step="0.01" onchange="calculateTotals()">
    <input type="number" name="tv_units_${rowIndex}" placeholder="TVëŒ€ìˆ˜" min="0" value="0">
    <button type="button" class="btn btn-danger" onclick="removeMonthRow(this)">ì‚­ì œ</button>
  `;
  container.appendChild(row);

  monthRowCount++;
  document.getElementById('month_count').value = monthRowCount;
  calculateTotals();
}

function addConsecutiveMonths(n){
  for(let i=0;i<n;i++){ addMonthRow(); }
}

function clearMonthRows(){
  document.getElementById('monthlyBillsContainer').innerHTML='';
  monthRowCount = 0;
  document.getElementById('month_count').value = 0;
  calculateTotals();
}

function removeMonthRow(btn){
  btn.parentElement.remove();
  // reindex
  const rows = document.querySelectorAll('#monthlyBillsContainer .month-row');
  rows.forEach((row, idx) => {
    row.querySelectorAll('input').forEach(input => {
      const [key, oldIdx] = input.name.split('_');
      input.name = key + '_' + idx;
    });
  });
  monthRowCount = rows.length;
  document.getElementById('month_count').value = monthRowCount;
  calculateTotals();
}

function calculateTotals(){
  let totalAmount = 0, totalWelfare = 0, totalVoucher = 0, totalTv = 0;
  for(let i=0;i<monthRowCount;i++){
    totalAmount += parseFloat(document.querySelector(`[name="amount_${i}"]`)?.value || 0);
    totalWelfare += parseFloat(document.querySelector(`[name="welfare_${i}"]`)?.value || 0);
    totalVoucher += parseFloat(document.querySelector(`[name="voucher_${i}"]`)?.value || 0);
    totalTv += parseFloat(document.querySelector(`[name="tv_fee_${i}"]`)?.value || 0);
  }
  document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
  document.getElementById('totalWelfare').textContent = totalWelfare.toLocaleString();
  document.getElementById('totalVoucher').textContent = totalVoucher.toLocaleString();
  document.getElementById('totalTvFee').textContent = totalTv.toLocaleString();
}

function renderReadingTable(floorId){
  const wrap = document.getElementById('readingTableWrap');
  const units = UNITS.filter(u => u.floor_id == floorId && !u.is_vacant);
  if(units.length === 0){
    wrap.innerHTML = '<p style="color:#94a3b8;">í•´ë‹¹ ì¸µì˜ ì¬ì‹¤ ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  let html = '<h4>ê²€ì¹¨ ì…ë ¥</h4><table><thead><tr><th>ì„¸ëŒ€</th><th>ì „ì›” ê²€ì¹¨</th><th>í˜„ì›” ê²€ì¹¨</th><th>ì‚¬ìš©ëŸ‰</th></tr></thead><tbody>';
  units.forEach(u => {
    html += `<tr>
      <td><strong>${u.unit_name}</strong></td>
      <td><input type="number" name="prev_${u.id}" step="0.01" value="0" onchange="calcUsage(${u.id})"></td>
      <td><input type="number" name="curr_${u.id}" step="0.01" value="0" onchange="calcUsage(${u.id})"></td>
      <td><span id="usage_${u.id}">0</span></td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function calcUsage(unitId){
  const prev = parseFloat(document.querySelector(`[name="prev_${unitId}"]`).value || 0);
  const curr = parseFloat(document.querySelector(`[name="curr_${unitId}"]`).value || 0);
  document.getElementById(`usage_${unitId}`).textContent = (curr - prev).toFixed(2);
}

// Floor selectors sync
document.getElementById('floorSelect').addEventListener('change', (e)=>{
  const id = e.target.value;
  document.getElementById('electric_floor_id').value = id;
  if(id){ renderReadingTable(id); }
});
document.getElementById('electric_floor_id').addEventListener('change', (e)=>{
  const id = e.target.value;
  document.getElementById('floorSelect').value = id;
  if(id){ renderReadingTable(id); }
});

// ì •ì‚°ì›” ë³€ê²½ì‹œ ì›”ë³„ ì…ë ¥ ì´ˆê¸°í™” í›„ ì²« ë‹¬ ìë™ ì¶”ê°€
document.getElementById('billing_month').addEventListener('change', (e)=>{
  clearMonthRows();
  if(e.target.value) addMonthRow();
});

function loadPrevReadings(){
  const monthInput = document.getElementById('billing_month');
  const floorId = document.getElementById('electric_floor_id').value;
  if(!monthInput.value || !floorId){ alert('ì •ì‚°ì›”ê³¼ ì¸µì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
  fetch(`/get_previous_readings/${floorId}/${monthInput.value}`)
    .then(r=>r.json()).then(j=>{
      if(!j.success){ alert(j.message || 'ì´ì „ ì •ì‚° ê²€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); return; }
      const map = j.readings || {};
      Object.entries(map).forEach(([uid, val])=>{
        const input = document.querySelector(`#readingTableWrap [name="prev_${uid}"]`);
        if(input) {
          input.value = val;
          calcUsage(uid);
        }
      });
      alert('ì´ì „ ì •ì‚°ì˜ í˜„ì›” ê²€ì¹¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    }).catch(()=> alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
}

// Submit handlers
document.getElementById('electricForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');
  const res = await fetch('/calculate/electric', { method:'POST', body: fd });
  const j = await res.json();
  if(j.exists){
    if(confirm('í•´ë‹¹ ì›”ì˜ ì „ê¸°ìš”ê¸ˆì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')){
      fd.set('overwrite','true');
      const res2 = await fetch('/calculate/electric', { method:'POST', body: fd });
      const j2 = await res2.json();
      alert(j2.message || (j2.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
    }
  }else{
    alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
  }
});

document.getElementById('waterForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');
  const res = await fetch('/calculate/water', { method:'POST', body: fd });
  const j = await res.json();
  if(j.exists){
    if(confirm('í•´ë‹¹ ì›”ì˜ ìˆ˜ë„ìš”ê¸ˆì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')){
      fd.set('overwrite','true');
      const res2 = await fetch('/calculate/water', { method:'POST', body: fd });
      const j2 = await res2.json();
      alert(j2.message || (j2.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
    }
  }else{
    alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
  }
});

document.getElementById('commonForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/calculate/common', { method:'POST', body: fd });
  const j = await res.json();
  alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
});

// init
renderFloorOptions();
</script>
{% endblock %}
