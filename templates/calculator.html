{% extends "base.html" %}
{% block title %}계산 - 공과금 정산 시스템{% endblock %}
{% block content %}
    <h1><span class="emoji">🧮</span> 계산</h1>

    <!-- 탭 버튼 -->
    <div class="tabs">
        <button class="tab active" onclick="showCalcTab('electric-tab', event)">⚡ 전기요금</button>
        <button class="tab" onclick="showCalcTab('water-tab', event)">💧 수도요금</button>
        <button class="tab" onclick="showCalcTab('common-tab', event)">🏘️ 공동 공과금</button>
    </div>
    <div class="tabs-container">
        <!-- 전기요금 탭 -->
        <div id="electric-tab" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">⚡ 전기요금 계산</h2>
                {% if electric_bill_url %}
                    <button type="button" class="btn btn-secondary"
                            onclick="window.open('{{ electric_bill_url }}', '_blank')" style="padding:8px 16px;">
                        🔍 요금 조회
                    </button>
                {% endif %}
            </div>

            <form id="electricForm">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="month_count" id="month_count" value="0">

                <div class="grid grid-3">
                    <div class="form-group">
                        <label>정산월</label>
                        <input type="month" name="billing_month" id="billing_month" required>
                    </div>
                    <div class="form-group">
                        <label>층</label>
                        <select name="floor_id" id="electric_floor_id" required></select>
                    </div>
                    <div class="form-group">
                        <label>TV 수신료 배분</label>
                        <select name="tv_distribution_mode" id="tv_mode">
                            <option value="INDIVIDUAL">개별 부과 (TV 보유 세대만)</option>
                            <option value="EQUAL">균등 분배 (재실 세대 전체)</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top:20px; background:white; padding:25px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h4 style="margin:0;color:#334155;font-size:18px;">📋 월별 고지 내역 입력</h4>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addMonthBillRow()">+ 월 추가</button>
                    </div>

                    <div style="background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:15px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                            <tr style="background:#e2e8f0;">
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #cbd5e1;width:140px;">
                                    고지월
                                </th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">전기요금</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">복지할인</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">바우처할인</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">TV수신료 총액</th>
                                <th style="padding:12px;border-bottom:2px solid #cbd5e1;width:80px;text-align:center;">
                                    작업
                                </th>
                            </tr>
                            </thead>
                            <tbody id="monthlyBillsContainer">
                            </tbody>
                        </table>
                    </div>

                    <div style="padding:15px; background:#e0f2fe; border-radius:8px;border-left:4px solid #0284c7;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
                            <div style="color:#0c4a6e;font-weight:600;font-size:15px;">📊 합계</div>
                            <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:14px;color:#0c4a6e;">
                                <span>총액: <strong id="totalAmount">0</strong>원</span>
                                <span>복지할인: <strong id="totalWelfare">0</strong>원</span>
                                <span>바우처할인: <strong id="totalVoucher">0</strong>원</span>
                                <span>TV수신료: <strong id="totalTvFee">0</strong>원</span>
                            </div>
                        </div>
                    </div>

                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-top:15px;font-size:13px;color:#92400e;line-height:1.6;">
                        <strong>💡 TV 수신료 안내:</strong><br>
                        • <strong>개별 부과 모드:</strong> TV 보유 세대만 설정의 TV 단가 × 개월수가 부과됩니다. TV수신료 입력칸은 비활성화됩니다.<br>
                        • <strong>균등 분배 모드:</strong> TV수신료 입력칸에 월별 총 TV 수신료를 입력하면, 공실을 제외한 모든 재실 세대가 균등 분담합니다.
                    </div>
                </div>

                <div id="unitsInfoCardContainer" style="margin-top:20px;"></div>
                <div id="readingTableWrap" style="margin-top:16px;"></div>

                <!-- 저장 영역 (체크박스 + 버튼을 함께 배치) -->
                <div style="margin-top:30px;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap;">
                        <label class="checkbox-wrapper" style="margin:0;cursor:pointer;">
                            <input type="checkbox" name="overwrite" style="cursor:pointer;">
                            <span style="font-size:14px;color:#475569;font-weight:500;">기존 정산 데이터 덮어쓰기</span>
                        </label>
                        <button type="submit" class="btn btn-primary" style="padding:12px 30px;font-size:15px;">
                            전기요금 계산 저장
                        </button>
                    </div>
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
                        <p style="margin:0;font-size:12px;color:#64748b;line-height:1.6;">
                            <strong>안내:</strong> 동일한 층과 정산월에 대한 데이터가 이미 존재하는 경우, 체크박스를 선택하면 기존 데이터를 삭제하고 새로운 데이터로 교체합니다.
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <!-- 수도요금 탭 -->
        <div id="water-tab" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h2 style="margin:0;">💧 수도요금 계산</h2>
                {% if water_bill_url %}
                    <button type="button" class="btn btn-secondary"
                            onclick="window.open('{{ water_bill_url }}', '_blank')" style="padding:8px 16px;">
                        🔍 요금 조회
                    </button>
                {% endif %}
            </div>

            <!-- 세대 선택 섹션 -->
            <div id="waterUnitsSelection"></div>
            <form id="waterForm">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="excluded_units" id="excluded_units" value="[]">

                <div class="grid grid-3">
                    <div class="form-group">
                        <label>정산월</label>
                        <input type="month" name="billing_month" required>
                    </div>
                    <div class="form-group">
                        <label>수도 총액 (주택)</label>
                        <input type="number" name="total_amount" min="0" placeholder="수도요금 (원)" required>
                    </div>
                    <div class="form-group">
                        <label>복지 할인 총액</label>
                        <input type="number" name="welfare_discount_total" min="0" placeholder="복지할인 (원)">
                    </div>
                </div>

                <!-- 저장 영역 (체크박스 + 버튼을 함께 배치) -->
                <div style="margin-top:30px;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap;">
                        <label class="checkbox-wrapper" style="margin:0;cursor:pointer;">
                            <input type="checkbox" name="overwrite" style="cursor:pointer;">
                            <span style="font-size:14px;color:#475569;font-weight:500;">기존 정산 데이터 덮어쓰기</span>
                        </label>
                        <button type="submit" class="btn btn-primary" style="padding:12px 30px;font-size:15px;">
                            수도요금 계산 저장
                        </button>
                    </div>
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
                        <p style="margin:0;font-size:12px;color:#64748b;line-height:1.6;">
                            <strong>안내:</strong> 동일한 정산월에 대한 데이터가 이미 존재하는 경우, 체크박스를 선택하면 기존 데이터를 삭제하고 새로운 데이터로 교체합니다.
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <!-- 공동 공과금 탭 -->
        <div id="common-tab" class="tab-content">
            <h2>🏘️ 공동 공과금 계산</h2>

            <div style="background:#fff3cd;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #f59e0b;">
                <div style="display:flex;align-items:start;gap:10px;">
                    <span style="font-size:20px;">💡</span>
                    <div style="flex:1;">
                        <strong style="color:#92400e;">공동 공과금이란?</strong>
                        <p style="color:#92400e;margin:5px 0 0 0;font-size:14px;line-height:1.6;">
                            청소비, 엘리베이터 유지보수비, 공용 전기세, 정화조 관리비 등 건물 전체에 부과되는 비용을 말합니다.<br>
                            인원수 비례 또는 세대 균등 분배 방식을 선택할 수 있습니다.
                        </p>
                    </div>
                </div>
            </div>

            <form id="commonForm">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <div class="grid grid-4">
                    <div class="form-group">
                        <label>정산월</label>
                        <input type="month" name="billing_month" required>
                    </div>
                    <div class="form-group">
                        <label>항목 설명</label>
                        <input type="text" name="description" placeholder="예: 청소비, 엘리베이터 유지보수 등" required>
                    </div>
                    <div class="form-group">
                        <label>총액</label>
                        <input type="number" name="total_amount" min="0" placeholder="공과금 총액 (원)" required>
                    </div>
                    <div class="form-group">
                        <label>분배 방식</label>
                        <select name="distribution_method">
                            <option value="BY_RESIDENTS">인원수 비례</option>
                            <option value="BY_UNITS">세대 균등</option>
                        </select>
                    </div>
                </div>

                <div style="background:#f8fafc;padding:15px;border-radius:8px;margin:20px 0;">
                    <h4 style="margin:0 0 10px 0;color:#334155;">📊 분배 방식 설명</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <div style="background:white;padding:12px;border-radius:6px;border:1px solid #e2e8f0;">
                            <div style="font-weight:600;color:#667eea;margin-bottom:5px;">👥 인원수 비례</div>
                            <div style="font-size:13px;color:#64748b;line-height:1.5;">
                                각 세대의 거주 인원수에 비례하여 금액을 분배합니다.
                                인원이 많은 세대가 더 많이 부담합니다.
                            </div>
                        </div>
                        <div style="background:white;padding:12px;border-radius:6px;border:1px solid #e2e8f0;">
                            <div style="font-weight:600;color:#667eea;margin-bottom:5px;">🏠 세대 균등</div>
                            <div style="font-size:13px;color:#64748b;line-height:1.5;">
                                재실 세대수로 균등하게 분배합니다.
                                인원수와 관계없이 모든 세대가 동일하게 부담합니다.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 저장 영역 -->
                <div style="margin-top:30px;padding:20px;background:#f8fafc;border-radius:12px;border:1px solid #e2e8f0;text-align:right;">
                    <button type="submit" class="btn btn-primary" style="padding:12px 30px;font-size:15px;">
                        공동 공과금 저장
                    </button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        const FLOORS = {{ (floors_json|default([]))|tojson }};
        const UNITS = {{ (units_json|default([]))|tojson }};

        let monthRowCounter = 0;
        let waterExcludedUnits = new Set(); // 수도세 제외 세대 ID 저장

        // 탭 전환 함수
        function showCalcTab(tabId, event) {
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('#electric-tab, #water-tab, #common-tab').forEach(tab => {
                tab.style.display = 'none';
            });

            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // 선택된 탭 표시
            document.getElementById(tabId).style.display = 'block';
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // 층 옵션 렌더링
        function renderFloorOptions() {
            const sel2 = document.getElementById('electric_floor_id');
            const options = '<option value="">선택</option>' + FLOORS.map(f => {
                const floorLabel = f.floor_number < 0 ? 'B' + (-f.floor_number) + '층' : f.floor_number + '층';
                let displayLabel = f.name ? `${floorLabel} (${f.name})` : floorLabel;
                if (f.electric_contract_number) {
                    displayLabel += ` [${f.electric_contract_number}]`;
                }
                return `<option value="${f.id}">${displayLabel}</option>`;
            }).join('');
            sel2.innerHTML = options;
        }

        // 전기 관련 함수들
        function addMonthBillRow() {
            const container = document.getElementById('monthlyBillsContainer');
            const idx = monthRowCounter;

            const tr = document.createElement('tr');
            tr.className = 'month-bill-row';
            tr.dataset.index = idx;
            tr.style.cssText = 'border-bottom:1px solid #e2e8f0;';

            tr.innerHTML = `
                <td style="padding:12px;">
                    <input type="month" name="month_${idx}" required
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;">
                </td>
                <td style="padding:12px;text-align:right;">
                    <input type="number" name="amount_${idx}" placeholder="0" min="0" step="0.01" class="bill-amount" required
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;text-align:right;">
                </td>
                <td style="padding:12px;text-align:right;">
                    <input type="number" name="welfare_${idx}" placeholder="0" min="0" step="0.01" class="bill-welfare"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;text-align:right;">
                </td>
                <td style="padding:12px;text-align:right;">
                    <input type="number" name="voucher_${idx}" placeholder="0" min="0" step="0.01" class="bill-voucher"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;text-align:right;">
                </td>
                <td style="padding:12px;text-align:right;">
                    <input type="number" name="tv_fee_${idx}" placeholder="0" min="0" step="0.01" class="bill-tvfee"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;text-align:right;">
                </td>
                <td style="padding:12px;text-align:center;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeMonthBillRow(${idx})"
                            style="padding:6px 12px;font-size:12px;">삭제</button>
                </td>
            `;

            container.appendChild(tr);
            monthRowCounter++;
            updateMonthCount();
            attachBillInputListeners();
            updateTvFeeInputs();
        }

        function removeMonthBillRow(idx) {
            const row = document.querySelector(`.month-bill-row[data-index="${idx}"]`);
            if (row) {
                row.remove();
                updateMonthCount();
                calculateBillTotals();
            }
        }

        function updateMonthCount() {
            const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
            document.getElementById('month_count').value = rows.length;
        }

        function attachBillInputListeners() {
            document.querySelectorAll('.bill-amount, .bill-welfare, .bill-voucher, .bill-tvfee').forEach(input => {
                input.removeEventListener('input', calculateBillTotals);
                input.addEventListener('input', calculateBillTotals);
            });
        }

        function calculateBillTotals() {
            let totalAmount = 0, totalWelfare = 0, totalVoucher = 0, totalTv = 0;

            document.querySelectorAll('.bill-amount').forEach(input => {
                totalAmount += parseFloat(input.value || 0);
            });
            document.querySelectorAll('.bill-welfare').forEach(input => {
                totalWelfare += parseFloat(input.value || 0);
            });
            document.querySelectorAll('.bill-voucher').forEach(input => {
                totalVoucher += parseFloat(input.value || 0);
            });
            document.querySelectorAll('.bill-tvfee').forEach(input => {
                totalTv += parseFloat(input.value || 0);
            });

            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
            document.getElementById('totalWelfare').textContent = totalWelfare.toLocaleString();
            document.getElementById('totalVoucher').textContent = totalVoucher.toLocaleString();
            document.getElementById('totalTvFee').textContent = totalTv.toLocaleString();
        }

        function updateTvFeeInputs() {
            const isIndividual = document.getElementById('tv_mode').value === 'INDIVIDUAL';
            document.querySelectorAll('.bill-tvfee').forEach(input => {
                input.disabled = isIndividual;
                if (isIndividual) {
                    input.value = '';
                    input.style.backgroundColor = '#e5e7eb';
                } else {
                    input.style.backgroundColor = '';
                }
            });
            calculateBillTotals();
        }

        function renderUnitsInfoCards(floorId) {
            const container = document.getElementById('unitsInfoCardContainer');
            const units = UNITS.filter(u => u.floor_id == floorId).sort((a, b) => a.unit_name.localeCompare(b.unit_name));

            if (units.length === 0) {
                container.innerHTML = '';
                return;
            }

            const selectedFloor = FLOORS.find(f => f.id == floorId);
            const floorLabel = selectedFloor ?
                (selectedFloor.floor_number < 0 ? 'B' + (-selectedFloor.floor_number) + '층' : selectedFloor.floor_number + '층') : '';
            const floorName = selectedFloor && selectedFloor.name ? selectedFloor.name : '';
            const floorContract = selectedFloor && selectedFloor.electric_contract_number ? selectedFloor.electric_contract_number : '';

            const occupiedCount = units.filter(u => !u.is_vacant).length;
            const vacantCount = units.filter(u => u.is_vacant).length;
            const tvCount = units.filter(u => !u.is_vacant && u.has_tv).length;
            const welfareCount = units.filter(u => !u.is_vacant && u.electric_welfare).length;
            const voucherCount = units.filter(u => !u.is_vacant && u.electric_voucher).length;

            let html = `
        <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0;">
            <!-- 층 정보 헤더 -->
            <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #e2e8f0;">
                <h4 style="margin:0 0 8px 0;color:#1e293b;font-size:16px;font-weight:600;">
                    ${floorLabel}${floorName ? ' (' + floorName + ')' : ''} 세대 정보
                </h4>
                ${floorContract ? `<div style="font-size:13px;color:#64748b;">계약번호: <span style="font-family:monospace;color:#475569;font-weight:500;">${floorContract}</span></div>` : ''}
            </div>

            <!-- 통계 요약 -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-bottom:20px;">
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">재실</div>
                    <div style="font-size:20px;font-weight:700;color:#059669;">${occupiedCount}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">공실</div>
                    <div style="font-size:20px;font-weight:700;color:#dc2626;">${vacantCount}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">TV</div>
                    <div style="font-size:20px;font-weight:700;color:#f59e0b;">${tvCount}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">복지</div>
                    <div style="font-size:20px;font-weight:700;color:#667eea;">${welfareCount}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">바우처</div>
                    <div style="font-size:20px;font-weight:700;color:#667eea;">${voucherCount}</div>
                </div>
            </div>

            <!-- 세대 카드 -->
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
    `;

            units.forEach(u => {
                const badges = [];
                if (u.is_vacant) badges.push('<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">공실</span>');
                else badges.push('<span style="background:#d1fae5;color:#059669;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">재실</span>');

                if (!u.is_vacant) {
                    if (u.has_tv) badges.push('<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">TV</span>');
                    if (u.electric_welfare) badges.push('<span style="background:#ddd6fe;color:#5b21b6;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">복지</span>');
                    if (u.electric_voucher) badges.push('<span style="background:#ddd6fe;color:#5b21b6;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">바우처</span>');
                }

                html += `
            <div style="background:white;padding:12px;border-radius:8px;border:1px solid ${u.is_vacant ? '#fecaca' : '#cbd5e1'};">
                <div style="font-weight:600;font-size:14px;color:#1e293b;margin-bottom:8px;">${u.unit_name}</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                    ${badges.join('')}
                </div>
                ${!u.is_vacant ? `<div style="font-size:12px;color:#64748b;">${u.residents_count}명 거주</div>` : ''}
            </div>
        `;
            });

            html += `
            </div>
        </div>
    `;

            container.innerHTML = html;
        }

        function renderReadingTable(floorId) {
            const wrap = document.getElementById('readingTableWrap');
            const units = UNITS.filter(u => u.floor_id == floorId && !u.is_vacant);

            if (units.length === 0) {
                wrap.innerHTML = '<p style="color:#94a3b8;">해당 층의 재실 세대가 없습니다.</p>';
                return;
            }

            const selectedFloor = FLOORS.find(f => f.id == floorId);
            const floorLabel = selectedFloor ?
                (selectedFloor.floor_number < 0 ? 'B' + (-selectedFloor.floor_number) + '층' : selectedFloor.floor_number + '층') : '';
            const floorName = selectedFloor && selectedFloor.name ? ` (${selectedFloor.name})` : '';

            let html = `
                <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin:0 0 20px 0;color:#334155;font-size:18px;">⚡ 검침 입력 - ${floorLabel}${floorName}</h4>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                        <!-- 전월 검침 테이블 -->
                        <div style="background:#fff7ed;padding:15px;border-radius:8px;border:2px solid #fed7aa;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                                <h5 style="margin:0;color:#9a3412;font-size:16px;">📉 전월 검침</h5>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="loadPreviousReadings()" style="padding:6px 12px;font-size:12px;">
                                    이전 정산 값 불러오기
                                </button>
                            </div>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#ffedd5;">
                                        <th style="padding:10px;text-align:left;border-bottom:2px solid #fed7aa;width:90px;">세대</th>
                                        <th style="padding:10px;text-align:left;border-bottom:2px solid #fed7aa;width:130px;">속성</th>
                                        <th style="padding:10px;text-align:center;border-bottom:2px solid #fed7aa;">검침값</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            units.forEach(u => {
                const badges = [];
                if (u.electric_welfare) badges.push('복지');
                if (u.electric_voucher) badges.push('바우처');
                if (u.has_tv) badges.push('TV');
                const badgeStr = badges.length > 0 ? badges.join(', ') : '-';

                html += `
                    <tr style="border-bottom:1px solid #fed7aa;">
                        <td style="padding:10px;"><strong>${u.unit_name}</strong></td>
                        <td style="padding:10px;font-size:12px;color:#9a3412;">${badgeStr}</td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" name="prev_${u.id}" step="0.01" placeholder="0.00"
                                   class="reading-prev" data-unit="${u.id}"
                                   style="width:130px;padding:8px;border:1px solid #fed7aa;border-radius:6px;text-align:right;font-size:14px;background:white;">
                        </td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>

                        <!-- 현월 검침 테이블 -->
                        <div style="background:#ecfccb;padding:15px;border-radius:8px;border:2px solid #bef264;">
                            <h5 style="margin:0 0 15px 0;color:#365314;font-size:16px;">📈 현월 검침</h5>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#d9f99d;">
                                        <th style="padding:10px;text-align:left;border-bottom:2px solid #bef264;width:90px;">세대</th>
                                        <th style="padding:10px;text-align:center;border-bottom:2px solid #bef264;">검침값</th>
                                        <th style="padding:10px;text-align:center;border-bottom:2px solid #bef264;width:100px;">사용량</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            units.forEach(u => {
                html += `
                    <tr style="border-bottom:1px solid #bef264;">
                        <td style="padding:10px;"><strong>${u.unit_name}</strong></td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" name="curr_${u.id}" step="0.01" placeholder="0.00"
                                   class="reading-curr" data-unit="${u.id}"
                                   style="width:130px;padding:8px;border:1px solid #bef264;border-radius:6px;text-align:right;font-size:14px;background:white;">
                        </td>
                        <td style="padding:10px;text-align:right;">
                            <span id="usage_${u.id}" style="font-weight:bold;font-size:14px;color:#059669;display:inline-block;min-width:80px;">0.00</span>
                        </td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top:20px;padding:15px;background:#e0f2fe;border-radius:8px;border-left:4px solid #0284c7;">
                        <div style="color:#0c4a6e;font-size:14px;line-height:1.6;">
                            <strong>💡 입력 방법:</strong><br>
                            • <strong>전월 검침</strong>을 모두 입력한 후 → <strong>현월 검침</strong>을 입력하세요.<br>
                            • Tab 키를 누르면 전월 검침 → 전월 검침 → ... → 현월 검침 → 현월 검침 순서로 이동합니다.<br>
                            • "이전 정산 값 불러오기" 버튼을 클릭하면 이전 정산의 현월 검침값이 전월 검침에 자동으로 입력됩니다.
                        </div>
                    </div>
                </div>
            `;
            wrap.innerHTML = html;

            // 사용량 계산 및 음수 검증
            document.querySelectorAll('.reading-prev, .reading-curr').forEach(input => {
                input.addEventListener('input', function () {
                    const unitId = this.dataset.unit;
                    const prevInput = document.querySelector(`.reading-prev[data-unit="${unitId}"]`);
                    const currInput = document.querySelector(`.reading-curr[data-unit="${unitId}"]`);
                    const usageSpan = document.getElementById(`usage_${unitId}`);

                    const prev = parseFloat(prevInput.value || 0);
                    const curr = parseFloat(currInput.value || 0);
                    const usage = curr - prev;

                    usageSpan.textContent = usage.toFixed(2);

                    // 음수 검증 및 시각적 피드백
                    if (usage < 0) {
                        usageSpan.style.color = '#dc2626';
                        usageSpan.style.fontWeight = 'bold';
                        currInput.style.borderColor = '#dc2626';
                        currInput.style.borderWidth = '2px';
                        currInput.style.backgroundColor = '#fee2e2';
                        currInput.setAttribute('data-invalid', 'true');
                    } else {
                        usageSpan.style.color = '#059669';
                        usageSpan.style.fontWeight = 'bold';
                        currInput.style.borderColor = '#bef264';
                        currInput.style.borderWidth = '1px';
                        currInput.style.backgroundColor = 'white';
                        currInput.removeAttribute('data-invalid');
                    }
                });
            });
        }

        // 수도 세대 선택 UI 렌더링
        function renderWaterUnitsSelection() {
            const container = document.getElementById('waterUnitsSelection');
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);

            if (occupiedUnits.length === 0) {
                container.innerHTML = '<p style="color:#64748b;margin:0;">재실 세대가 없습니다.</p>';
                return;
            }

            const waterWelfareUnits = occupiedUnits.filter(u => u.water_welfare);
            const totalResidents = occupiedUnits.reduce((sum, u) => sum + (u.residents_count || 1), 0);
            const selectedCount = occupiedUnits.length - waterExcludedUnits.size;

            // 전기요금 unitsInfoCardContainer와 동일한 외곽 컨테이너 디자인
            let html = `
        <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0;">
            <!-- 헤더 (전기요금처럼 고객번호 포함) -->
            <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #e2e8f0;">
                <h4 style="margin:0 0 8px 0;color:#1e293b;font-size:16px;font-weight:600;">
                    정산 대상 세대 선택
                </h4>
    `;

            // 주택 수도 고객번호가 있으면 표시 (전기요금 계약번호와 동일한 스타일)
            const waterCustomerNumber = '{{ water_customer_number }}';
            if (waterCustomerNumber) {
                html += `<div style="color:#64748b;font-size:13px;font-weight:500;margin-top:5px;">주택 수도 고객번호: <span style="font-family:monospace;color:#475569;font-weight:500;">${waterCustomerNumber}</span></div>`;
            }

            html += `
                <p style="color:#64748b;font-size:13px;margin:8px 0 0 0;line-height:1.5;">
                    체크박스를 클릭하여 정산 대상을 선택하세요. 장기 출장 등으로 수도를 사용하지 않은 세대는 선택 해제할 수 있습니다.
                </p>
            </div>

            <!-- 통계 요약 (전기요금과 동일한 스타일) -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-bottom:20px;">
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">전체</div>
                    <div style="font-size:20px;font-weight:700;color:#0284c7;">${occupiedUnits.length}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">선택됨</div>
                    <div style="font-size:20px;font-weight:700;color:#059669;" id="selectedCountDisplay">${selectedCount}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">인원</div>
                    <div style="font-size:20px;font-weight:700;color:#0284c7;">${totalResidents}</div>
                </div>
                <div style="text-align:center;padding:12px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="font-size:11px;color:#64748b;margin-bottom:4px;">복지</div>
                    <div style="font-size:20px;font-weight:700;color:#059669;">${waterWelfareUnits.length}</div>
                </div>
            </div>

            <!-- 세대 카드 (층별 그룹화) -->
    `;

            // 층별 그룹화
            const floorGroups = {};
            occupiedUnits.forEach(unit => {
                if (!floorGroups[unit.floor_id]) {
                    const floor = FLOORS.find(f => f.id === unit.floor_id);
                    floorGroups[unit.floor_id] = {
                        floor_number: floor ? floor.floor_number : 999,
                        floor_name: floor ? floor.name : '',
                        units: []
                    };
                }
                floorGroups[unit.floor_id].units.push(unit);
            });

            Object.keys(floorGroups).sort((a, b) => {
                return floorGroups[a].floor_number - floorGroups[b].floor_number;
            }).forEach(floorId => {
                const group = floorGroups[floorId];
                const floorLabel = group.floor_number < 0 ? `B${-group.floor_number}층` : `${group.floor_number}층`;
                const floorDisplayName = group.floor_name ? `${floorLabel} (${group.floor_name})` : floorLabel;

                html += `
            <div style="margin-bottom:16px;">
                <h5 style="margin:0 0 10px 0;color:#475569;font-size:13px;font-weight:600;">${floorDisplayName}</h5>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
        `;

                group.units.forEach(unit => {
                    const isIncluded = !waterExcludedUnits.has(unit.id);

                    // 배지 생성 (전기요금 카드와 동일한 스타일)
                    const badges = [];
                    if (isIncluded) {
                        badges.push('<span style="background:#d1fae5;color:#059669;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">선택됨</span>');
                    } else {
                        badges.push('<span style="background:#f1f5f9;color:#64748b;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">제외됨</span>');
                    }

                    if (unit.water_welfare) {
                        badges.push('<span style="background:#d1fae5;color:#059669;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">복지</span>');
                    }

                    const borderColor = isIncluded ? '#0891b2' : '#cbd5e1';

                    html += `
                <div class="water-unit-card" data-unit-id="${unit.id}"
                     style="background:white;padding:12px;border-radius:8px;border:1px solid ${borderColor};cursor:pointer;transition:all 0.2s;"
                     onclick="toggleWaterUnit(${unit.id})">
                    <div style="display:flex;align-items:start;gap:8px;margin-bottom:8px;">
                        <input type="checkbox"
                               ${isIncluded ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleWaterUnit(${unit.id});"
                               style="width:16px;height:16px;cursor:pointer;margin-top:2px;accent-color:#0891b2;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;color:#1e293b;margin-bottom:4px;">${unit.unit_name}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                        ${badges.join('')}
                    </div>
                    <div style="font-size:12px;color:#64748b;">${unit.residents_count}명 거주</div>
                </div>
            `;
                });

                html += '</div></div>';
            });

            html += `
        </div>
    `;

            container.innerHTML = html;
        }

        function toggleWaterUnit(unitId) {
            if (waterExcludedUnits.has(unitId)) {
                waterExcludedUnits.delete(unitId);
            } else {
                waterExcludedUnits.add(unitId);
            }

            const excludedArray = Array.from(waterExcludedUnits);
            document.getElementById('excluded_units').value = JSON.stringify(excludedArray);

            // 선택 카운트만 업데이트 (전체 재렌더링 방지)
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);
            const selectedCount = occupiedUnits.length - waterExcludedUnits.size;
            const displayElement = document.getElementById('selectedCountDisplay');
            if (displayElement) {
                displayElement.textContent = selectedCount;
            }

            // 해당 카드만 시각적 업데이트
            const card = document.querySelector(`.water-unit-card[data-unit-id="${unitId}"]`);
            const checkbox = card.querySelector('input[type="checkbox"]');
            const isIncluded = !waterExcludedUnits.has(unitId);

            checkbox.checked = isIncluded;
            card.style.background = isIncluded ? 'white' : '#f8fafc';
            card.style.borderColor = isIncluded ? '#0891b2' : '#cbd5e1';
        }

        function loadPreviousReadings() {
            const monthInput = document.getElementById('billing_month');
            const floorId = document.getElementById('electric_floor_id').value;

            if (!monthInput.value || !floorId) {
                alert('정산월과 층을 먼저 선택하세요.');
                return;
            }

            fetch(`/get_previous_readings/${floorId}/${monthInput.value}`)
                .then(r => r.json())
                .then(j => {
                    if (!j.success) {
                        alert(j.message || '이전 정산 검침 불러오기에 실패했습니다.');
                        return;
                    }

                    const readings = j.readings || {};
                    Object.entries(readings).forEach(([unitId, value]) => {
                        const input = document.querySelector(`.reading-prev[data-unit="${unitId}"]`);
                        if (input) {
                            input.value = value;
                            input.dispatchEvent(new Event('input'));
                        }
                    });

                    alert('이전 정산의 현월 검침을 불러왔습니다.');
                })
                .catch(() => alert('통신 오류가 발생했습니다.'));
        }

        // 층 선택 동기화
        document.getElementById('electric_floor_id').addEventListener('change', (e) => {
            const id = e.target.value;
            if (id) {
                renderReadingTable(id);
                renderUnitsInfoCards(id);
            }
        });

        // TV 모드 변경
        document.getElementById('tv_mode').addEventListener('change', updateTvFeeInputs);

        // 전기요금 폼 제출
        document.getElementById('electricForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
            if (rows.length === 0) {
                alert('월별 고지 내역을 최소 1개 이상 추가해주세요.');
                return;
            }

            const floorId = document.getElementById('electric_floor_id').value;
            if (!floorId) {
                alert('층을 선택해주세요.');
                return;
            }

            // 음수 사용량 검증
            const invalidInputs = document.querySelectorAll('.reading-curr[data-invalid="true"]');
            if (invalidInputs.length > 0) {
                alert('⚠️ 사용량이 음수인 세대가 있습니다.\n\n현월 검침값이 전월 검침값보다 작습니다.\n검침값을 확인해주세요.');
                invalidInputs[0].focus();
                return;
            }

            e.target.querySelectorAll('input[type="number"]:not([disabled])').forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    input.value = '0';
                }
            });

            const fd = new FormData(e.target);
            fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');

            try {
                const res = await fetch('/calculate/electric', {method: 'POST', body: fd});
                const j = await res.json();

                if (j.exists) {
                    if (confirm('해당 월의 전기요금이 이미 존재합니다. 덮어쓸까요?')) {
                        fd.set('overwrite', 'true');
                        const res2 = await fetch('/calculate/electric', {method: 'POST', body: fd});
                        const j2 = await res2.json();
                        alert(j2.message || (j2.success ? '저장되었습니다.' : '실패했습니다.'));
                        if (j2.success) location.reload();
                    }
                } else {
                    if (j.success) {
                        alert('저장되었습니다.');
                        location.reload();
                    } else {
                        alert('오류: ' + (j.message || '알 수 없는 오류'));
                    }
                }
            } catch (error) {
                alert('네트워크 오류가 발생했습니다: ' + error.message);
            }
        });

        // 수도요금 폼 제출
        document.getElementById('waterForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            e.target.querySelectorAll('input[type="number"]').forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    input.value = '0';
                }
            });

            const fd = new FormData(e.target);

            const excludedArray = Array.from(waterExcludedUnits);
            const excludedUnitsValue = JSON.stringify(excludedArray);
            fd.set('excluded_units', excludedUnitsValue);
            fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');

            try {
                const res = await fetch('/calculate/water', {method: 'POST', body: fd});
                const j = await res.json();

                if (j.exists) {
                    if (confirm('해당 월의 수도요금이 이미 존재합니다. 덮어쓸까요?')) {
                        fd.set('overwrite', 'true');
                        const res2 = await fetch('/calculate/water', {method: 'POST', body: fd});
                        const j2 = await res2.json();
                        alert(j2.message || (j2.success ? '저장되었습니다.' : '실패했습니다.'));
                        if (j2.success) location.reload();
                    }
                } else {
                    alert(j.message || (j.success ? '저장되었습니다.' : '실패했습니다.'));
                    if (j.success) location.reload();
                }
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
            }
        });

        // 공동 공과금 폼 제출
        document.getElementById('commonForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            e.target.querySelectorAll('input[type="number"]').forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    input.value = '0';
                }
            });

            const fd = new FormData(e.target);

            try {
                const res = await fetch('/calculate/common', {method: 'POST', body: fd});
                const j = await res.json();
                alert(j.message || (j.success ? '저장되었습니다.' : '실패했습니다.'));
                if (j.success) location.reload();
            } catch (error) {
                alert('오류가 발생했습니다: ' + error.message);
            }
        });

        // 초기화
        renderFloorOptions();
        // 전기요금: 월별 고지 내역 기본 1개 행 추가
        addMonthBillRow();
        renderWaterUnitsSelection();
    </script>
{% endblock %}