{% extends "base.html" %}
{% block title %}ê³„ì‚° - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
<h1>ğŸ§® ê³„ì‚°</h1>

<div class="grid grid-2">
  <div style="background:#f8fafc;padding:16px;border-radius:12px;">
    <h3>ìš”ì•½</h3>
    <ul>
      <li>ì´ ì„¸ëŒ€: <strong>{{ total_units }}</strong></li>
      <li>ì¬ì‹¤ ì„¸ëŒ€: <strong>{{ occupied_units }}</strong></li>
      <li>ê³µì‹¤ ì„¸ëŒ€: <strong>{{ vacant_units }}</strong></li>
      <li>ì´ ê±°ì£¼ ì¸ì›: <strong>{{ total_residents }}</strong></li>
    </ul>
  </div>
  <div style="background:#f8fafc;padding:16px;border-radius:12px;">
    <h3>ë¹ ë¥¸ ì„ íƒ</h3>
    <label>ì¸µ ì„ íƒ</label>
    <select id="floorSelect"></select>
    <small style="display:block;color:#64748b;margin-top:8px;">ì¸µì„ ì„ íƒí•˜ë©´ ì „ê¸° ê²€ì¹¨ ì…ë ¥ í‘œê°€ í•´ë‹¹ ì¸µ ì„¸ëŒ€ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</small>
  </div>
</div>

<!-- ì „ê¸°ìš”ê¸ˆ -->
<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">âš¡ ì „ê¸°ìš”ê¸ˆ ê³„ì‚°</h2>
  <form id="electricForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="month_count" id="month_count" value="0">

    <div class="grid grid-3">
      <div class="form-group">
        <label>ì •ì‚°ì›”</label>
        <input type="month" name="billing_month" id="billing_month" required>
      </div>
      <div class="form-group">
        <label>ì¸µ</label>
        <select name="floor_id" id="electric_floor_id" required></select>
      </div>
      <div class="form-group">
        <label>TV ìˆ˜ì‹ ë£Œ ë°°ë¶„</label>
        <select name="tv_distribution_mode" id="tv_mode">
          <option value="INDIVIDUAL">ê°œë³„ ë¶€ê³¼ (TV ë³´ìœ  ì„¸ëŒ€ë§Œ)</option>
          <option value="EQUAL">ê· ë“± ë¶„ë°° (ì¬ì‹¤ ì„¸ëŒ€ ì „ì²´)</option>
        </select>
      </div>
    </div>

    <!-- ì›”ë³„ ìƒì„¸ ì…ë ¥ -->
    <div style="margin-top:20px; background:#f0f4f8; padding:15px; border-radius:8px;">
      <h4>ì›”ë³„ ê³ ì§€ ë‚´ì—­ ì…ë ¥</h4>
      <div id="monthlyBillsContainer"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
        <button type="button" class="btn btn-secondary" onclick="addMonthBillRow()">+ ì›” ì¶”ê°€</button>
      </div>
      <div style="margin-top:15px; padding:10px; background:#e7f3ff; border-radius:5px;">
        <strong>í•©ê³„:</strong>
        ì´ì•¡ <span id="totalAmount">0</span>ì› |
        ë³µì§€í• ì¸ <span id="totalWelfare">0</span>ì› |
        ë°”ìš°ì²˜í• ì¸ <span id="totalVoucher">0</span>ì› |
        TVìˆ˜ì‹ ë£Œ <span id="totalTvFee">0</span>ì›
      </div>
      <small style="color:#64748b;display:block;margin-top:8px;">
        <strong>ê°œë³„ ë¶€ê³¼ ëª¨ë“œ:</strong> TV ë³´ìœ  ì„¸ëŒ€ë§Œ ì„¤ì •ì˜ TV ë‹¨ê°€ Ã— ê°œì›”ìˆ˜ê°€ ë¶€ê³¼ë©ë‹ˆë‹¤. TVìˆ˜ì‹ ë£Œ ì…ë ¥ì¹¸ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.<br>
        <strong>ê· ë“± ë¶„ë°° ëª¨ë“œ:</strong> TVìˆ˜ì‹ ë£Œ ì…ë ¥ì¹¸ì— ì›”ë³„ ì´ TV ìˆ˜ì‹ ë£Œë¥¼ ì…ë ¥í•˜ë©´, ê³µì‹¤ì„ ì œì™¸í•œ ëª¨ë“  ì¬ì‹¤ ì„¸ëŒ€ê°€ ê· ë“± ë¶„ë‹´í•©ë‹ˆë‹¤.
      </small>
    </div>

    <div class="form-group" style="margin-top:10px;">
      <label class="checkbox-wrapper">
        <input type="checkbox" name="overwrite">
        <span>ê¸°ì¡´ ì •ì‚° ë®ì–´ì“°ê¸°</span>
      </label>
    </div>

    <!-- ì„ íƒëœ ì¸µì˜ ì„¸ëŒ€ ì •ë³´ ì¹´ë“œ -->
    <div id="unitsInfoCardContainer" style="margin-top:20px;"></div>

    <!-- ê²€ì¹¨ ì…ë ¥ í…Œì´ë¸” -->
    <div id="readingTableWrap" style="margin-top:16px;"></div>

    <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;">
      <button type="button" class="btn" onclick="loadPreviousReadings()">ì´ì „ ì •ì‚° í˜„ì›”ê°’ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button type="submit" class="btn btn-primary">ì „ê¸°ìš”ê¸ˆ ê³„ì‚° ì €ì¥</button>
    </div>
  </form>
</div>

<!-- ìˆ˜ë„ìš”ê¸ˆ -->
<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ ê³„ì‚°</h2>

  <!-- ìˆ˜ë„ ê³„ì‚° ë¶„ë°° ìš”ì•½ -->
  <div id="waterSummaryContainer" style="margin-bottom:20px;"></div>

  <form id="waterForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>ì •ì‚°ì›”</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>ìˆ˜ë„ ì´ì•¡ (ì£¼íƒ)</label>
        <input type="number" name="total_amount" min="0" placeholder="ìˆ˜ë„ìš”ê¸ˆ (ì›)" required>
      </div>
      <div class="form-group">
        <label>ë³µì§€ í• ì¸ ì´ì•¡</label>
        <input type="number" name="welfare_discount_total" min="0" placeholder="ë³µì§€í• ì¸ (ì›)">
      </div>
      <div class="form-group" style="align-self:end;">
        <label style="visibility:hidden;">ì¤‘ë³µ ì²˜ë¦¬</label>
        <label class="checkbox-wrapper"><input type="checkbox" name="overwrite"><span>ê¸°ì¡´ ì •ì‚° ë®ì–´ì“°ê¸°</span></label>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">ìˆ˜ë„ìš”ê¸ˆ ê³„ì‚° ì €ì¥</button>
    </div>
  </form>
</div>

<!-- ê³µë™ ê³µê³¼ê¸ˆ -->
<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</h2>
  <form id="commonForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>ì •ì‚°ì›”</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>í•­ëª© ì„¤ëª…</label>
        <input type="text" name="description" placeholder="ì˜ˆ: ì²­ì†Œë¹„, ì—˜ë¦¬ë² ì´í„° ìœ ì§€ë³´ìˆ˜ ë“±" required>
      </div>
      <div class="form-group">
        <label>ì´ì•¡</label>
        <input type="number" name="total_amount" min="0" placeholder="ê³µê³¼ê¸ˆ ì´ì•¡ (ì›)" required>
      </div>
      <div class="form-group">
        <label>ë¶„ë°° ë°©ì‹</label>
        <select name="distribution_method">
          <option value="BY_RESIDENTS">ì¸ì›ìˆ˜ ë¹„ë¡€</option>
          <option value="BY_UNITS">ì„¸ëŒ€ ê· ë“±</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">ê³µë™ ê³µê³¼ê¸ˆ ì €ì¥</button>
    </div>
  </form>
</div>

{% endblock %}

{% block scripts %}
<script>
const FLOORS = {{ (floors_json|default([]))|tojson }};
const UNITS = {{ (units_json|default([]))|tojson }};

let monthRowCounter = 0;

// ì¸µ ì˜µì…˜ ë Œë”ë§
function renderFloorOptions(){
  const sel1 = document.getElementById('floorSelect');
  const sel2 = document.getElementById('electric_floor_id');
  const options = '<option value="">ì„ íƒ</option>' + FLOORS.map(f => {
    const label = f.name || (f.floor_number < 0 ? 'B' + (-f.floor_number) + 'ì¸µ' : f.floor_number + 'ì¸µ');
    return `<option value="${f.id}">${label}</option>`;
  }).join('');
  sel1.innerHTML = options;
  sel2.innerHTML = options;
}

// ì›”ë³„ ê³ ì§€ í–‰ ì¶”ê°€
function addMonthBillRow(){
  const container = document.getElementById('monthlyBillsContainer');
  const idx = monthRowCounter;

  const rowDiv = document.createElement('div');
  rowDiv.className = 'month-bill-row';
  rowDiv.dataset.index = idx;
  rowDiv.style.cssText = 'display:grid; grid-template-columns: 1fr 1.5fr 1.5fr 1.5fr 1.5fr 0.5fr; gap:8px; margin-bottom:10px; padding:10px; background:white; border-radius:5px; align-items:center;';

  rowDiv.innerHTML = `
    <input type="month" name="month_${idx}" placeholder="ê³ ì§€ì›”" required style="font-size:13px;">
    <input type="number" name="amount_${idx}" placeholder="ì „ê¸°ìš”ê¸ˆ (ì›)" min="0" step="0.01" class="bill-amount" required style="font-size:13px;">
    <input type="number" name="welfare_${idx}" placeholder="ë³µì§€í• ì¸ (ì›)" min="0" step="0.01" class="bill-welfare" style="font-size:13px;">
    <input type="number" name="voucher_${idx}" placeholder="ë°”ìš°ì²˜í• ì¸ (ì›)" min="0" step="0.01" class="bill-voucher" style="font-size:13px;">
    <input type="number" name="tv_fee_${idx}" placeholder="TVìˆ˜ì‹ ë£Œ ì´ì•¡ (ì›)" min="0" step="0.01" class="bill-tvfee" style="font-size:13px;">
    <button type="button" class="btn btn-danger" onclick="removeMonthBillRow(${idx})" style="padding:8px;">ì‚­ì œ</button>
  `;

  container.appendChild(rowDiv);
  monthRowCounter++;
  updateMonthCount();
  attachBillInputListeners();
  updateTvFeeInputs();
}

// ì›”ë³„ ê³ ì§€ í–‰ ì‚­ì œ
function removeMonthBillRow(idx){
  const row = document.querySelector(`.month-bill-row[data-index="${idx}"]`);
  if(row){
    row.remove();
    updateMonthCount();
    calculateBillTotals();
  }
}

// ì›” ê°œìˆ˜ ì—…ë°ì´íŠ¸
function updateMonthCount(){
  const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
  document.getElementById('month_count').value = rows.length;
}

// ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
function attachBillInputListeners(){
  document.querySelectorAll('.bill-amount, .bill-welfare, .bill-voucher, .bill-tvfee').forEach(input => {
    input.removeEventListener('input', calculateBillTotals);
    input.addEventListener('input', calculateBillTotals);
  });
}

// í•©ê³„ ê³„ì‚°
function calculateBillTotals(){
  let totalAmount = 0, totalWelfare = 0, totalVoucher = 0, totalTv = 0;

  document.querySelectorAll('.bill-amount').forEach(input => {
    totalAmount += parseFloat(input.value || 0);
  });
  document.querySelectorAll('.bill-welfare').forEach(input => {
    totalWelfare += parseFloat(input.value || 0);
  });
  document.querySelectorAll('.bill-voucher').forEach(input => {
    totalVoucher += parseFloat(input.value || 0);
  });
  document.querySelectorAll('.bill-tvfee').forEach(input => {
    totalTv += parseFloat(input.value || 0);
  });

  document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
  document.getElementById('totalWelfare').textContent = totalWelfare.toLocaleString();
  document.getElementById('totalVoucher').textContent = totalVoucher.toLocaleString();
  document.getElementById('totalTvFee').textContent = totalTv.toLocaleString();
}

// TV ìˆ˜ì‹ ë£Œ ì…ë ¥ë€ í™œì„±/ë¹„í™œì„±
function updateTvFeeInputs(){
  const isIndividual = document.getElementById('tv_mode').value === 'INDIVIDUAL';
  document.querySelectorAll('.bill-tvfee').forEach(input => {
    input.disabled = isIndividual;
    if(isIndividual){
      input.value = '';
      input.style.backgroundColor = '#e5e7eb';
    } else {
      input.style.backgroundColor = '';
    }
  });
  calculateBillTotals();
}

// ì„¸ëŒ€ ì •ë³´ ì¹´ë“œ ë Œë”ë§ (ì „ê¸°)
function renderUnitsInfoCards(floorId){
  const container = document.getElementById('unitsInfoCardContainer');
  const units = UNITS.filter(u => u.floor_id == floorId).sort((a, b) => a.unit_name.localeCompare(b.unit_name));

  if(units.length === 0){
    container.innerHTML = '';
    return;
  }

  let html = '<div style="background:#e0e7ff;padding:16px;border-radius:12px;margin-bottom:16px;border-left:4px solid #667eea;">';
  html += '<h4 style="margin-top:0;color:#4338ca;">ğŸ‘¥ ì„ íƒëœ ì¸µ ì„¸ëŒ€ ì •ë³´</h4>';
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">';

  units.forEach(u => {
    const statusBadge = u.is_vacant
      ? '<span class="badge badge-danger">ê³µì‹¤</span>'
      : '<span class="badge badge-success">ì¬ì‹¤</span>';

    const elecWelfare = u.electric_welfare ? '<span class="badge badge-primary">ì „ê¸°ë³µì§€</span>' : '';
    const elecVoucher = u.electric_voucher ? '<span class="badge badge-primary">ì „ê¸°ë°”ìš°ì²˜</span>' : '';
    const tv = u.has_tv ? '<span class="badge badge-warning">TVë³´ìœ </span>' : '';
    const waterWelfare = u.water_welfare ? '<span class="badge badge-primary">ìˆ˜ë„ë³µì§€</span>' : '';

    html += `
      <div style="background:white;padding:12px;border-radius:8px;border:1px solid #cbd5e1;font-size:13px;">
        <div style="font-weight:bold;margin-bottom:8px;font-size:14px;">${u.unit_name}</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;">
          ${statusBadge}
          ${elecWelfare}
          ${elecVoucher}
          ${tv}
          ${waterWelfare}
        </div>
        <div style="color:#64748b;">ğŸ‘¥ ${u.residents_count}ëª…</div>
      </div>
    `;
  });

  html += '</div></div>';
  container.innerHTML = html;
}

// ê²€ì¹¨í‘œ ë Œë”ë§ (ì„¸ëŒ€ ì •ë³´ í¬í•¨)
function renderReadingTable(floorId){
  const wrap = document.getElementById('readingTableWrap');
  const units = UNITS.filter(u => u.floor_id == floorId && !u.is_vacant);

  if(units.length === 0){
    wrap.innerHTML = '<p style="color:#94a3b8;">í•´ë‹¹ ì¸µì˜ ì¬ì‹¤ ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  let html = '<h4>ê²€ì¹¨ ì…ë ¥</h4><table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#f0f4f8;"><th style="padding:12px;text-align:left;border-bottom:2px solid #e2e8f0;">ì„¸ëŒ€</th><th style="padding:12px;text-align:left;border-bottom:2px solid #e2e8f0;">ì†ì„±</th><th style="padding:12px;text-align:left;border-bottom:2px solid #e2e8f0;">ì „ì›” ê²€ì¹¨</th><th style="padding:12px;text-align:left;border-bottom:2px solid #e2e8f0;">í˜„ì›” ê²€ì¹¨</th><th style="padding:12px;text-align:left;border-bottom:2px solid #e2e8f0;">ì‚¬ìš©ëŸ‰</th></tr></thead><tbody>';

  units.forEach(u => {
    const badges = [];
    if(u.electric_welfare) badges.push('ë³µì§€');
    if(u.electric_voucher) badges.push('ë°”ìš°ì²˜');
    if(u.has_tv) badges.push('TV');
    const badgeStr = badges.length > 0 ? badges.join(', ') : '-';

    html += `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:12px;"><strong>${u.unit_name}</strong></td><td style="padding:12px;font-size:12px;color:#64748b;">${badgeStr}</td><td style="padding:12px;"><input type="number" name="prev_${u.id}" step="0.01" placeholder="ì „ì›”" class="reading-prev" data-unit="${u.id}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></td><td style="padding:12px;"><input type="number" name="curr_${u.id}" step="0.01" placeholder="í˜„ì›”" class="reading-curr" data-unit="${u.id}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></td><td style="padding:12px;font-weight:bold;"><span id="usage_${u.id}" style="font-weight:bold;">0.00</span></td></tr>`;
  });

  html += '</tbody></table>';
  wrap.innerHTML = html;

  // ì‚¬ìš©ëŸ‰ ìë™ ê³„ì‚°
  document.querySelectorAll('.reading-prev, .reading-curr').forEach(input => {
    input.addEventListener('input', function(){
      const unitId = this.dataset.unit;
      const prev = parseFloat(document.querySelector(`.reading-prev[data-unit="${unitId}"]`).value || 0);
      const curr = parseFloat(document.querySelector(`.reading-curr[data-unit="${unitId}"]`).value || 0);
      document.getElementById(`usage_${unitId}`).textContent = (curr - prev).toFixed(2);
    });
  });
}

// ìˆ˜ë„ ê³„ì‚° ìš”ì•½ ë Œë”ë§
function renderWaterSummary(){
  const container = document.getElementById('waterSummaryContainer');
  const occupiedUnits = UNITS.filter(u => !u.is_vacant);
  const waterWelfareUnits = occupiedUnits.filter(u => u.water_welfare);
  const totalResidents = occupiedUnits.reduce((sum, u) => sum + (u.residents_count || 1), 0);

  let html = '<div style="background:#e0f2fe;padding:16px;border-radius:12px;border-left:4px solid #0284c7;margin-bottom:16px;">';
  html += '<h4 style="margin-top:0;color:#0c4a6e;">ğŸ’§ ìˆ˜ë„ ê³„ì‚° ë¶„ë°° ì•ˆë‚´</h4>';
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px;">';

  html += `
    <div style="background:white;padding:12px;border-radius:8px;">
      <div style="font-size:12px;color:#64748b;">ì •ì‚° ì„¸ëŒ€ (ì¬ì‹¤)</div>
      <div style="font-size:18px;font-weight:bold;color:#0284c7;">${occupiedUnits.length}ì„¸ëŒ€</div>
    </div>
    <div style="background:white;padding:12px;border-radius:8px;">
      <div style="font-size:12px;color:#64748b;">ì´ ê±°ì£¼ ì¸ì›</div>
      <div style="font-size:18px;font-weight:bold;color:#0284c7;">${totalResidents}ëª…</div>
    </div>
    <div style="background:white;padding:12px;border-radius:8px;">
      <div style="font-size:12px;color:#64748b;">ìˆ˜ë„ ë³µì§€ ëŒ€ìƒ</div>
      <div style="font-size:18px;font-weight:bold;color:#${waterWelfareUnits.length > 0 ? '059669' : '94a3b8'}">${waterWelfareUnits.length}ì„¸ëŒ€</div>
    </div>
  `;

  html += '</div>';

  // ì„¸ëŒ€ë³„ ìƒì„¸ ì •ë³´
  html += '<details style="background:white;padding:12px;border-radius:8px;border:1px solid #cbd5e1;"><summary style="cursor:pointer;font-weight:600;color:#0284c7;">ì„¸ëŒ€ë³„ ìƒì„¸ ì •ë³´ ë³´ê¸°</summary>';
  html += '<table style="width:100%;font-size:12px;border-collapse:collapse;margin-top:12px;"><thead><tr style="background:#f0f4f8;"><th style="padding:8px;text-align:left;border-bottom:1px solid #cbd5e1;">ì„¸ëŒ€</th><th style="padding:8px;text-align:center;border-bottom:1px solid #cbd5e1;">ì¸ì›ìˆ˜</th><th style="padding:8px;text-align:center;border-bottom:1px solid #cbd5e1;">ìˆ˜ë„ë³µì§€</th><th style="padding:8px;text-align:center;border-bottom:1px solid #cbd5e1;">ìƒíƒœ</th></tr></thead><tbody>';

  occupiedUnits.forEach(u => {
    const welfare = u.water_welfare ? 'âœ“' : '-';
    html += `<tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px;"><strong>${u.unit_name}</strong></td><td style="padding:8px;text-align:center;">${u.residents_count}ëª…</td><td style="padding:8px;text-align:center;color:${u.water_welfare ? '#059669' : '#94a3b8'};">${welfare}</td><td style="padding:8px;text-align:center;"><span class="badge ${u.water_welfare ? 'badge-success' : 'badge-warning'}">${u.water_welfare ? 'í• ì¸ëŒ€ìƒ' : 'ì¼ë°˜'}</span></td></tr>`;
  });

  html += '</tbody></table></details></div>';
  container.innerHTML = html;
}

// ì´ì „ ì •ì‚° í˜„ì›”ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
function loadPreviousReadings(){
  const monthInput = document.getElementById('billing_month');
  const floorId = document.getElementById('electric_floor_id').value;

  if(!monthInput.value || !floorId){
    alert('ì •ì‚°ì›”ê³¼ ì¸µì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  fetch(`/get_previous_readings/${floorId}/${monthInput.value}`)
    .then(r => r.json())
    .then(j => {
      if(!j.success){
        alert(j.message || 'ì´ì „ ì •ì‚° ê²€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const readings = j.readings || {};
      Object.entries(readings).forEach(([unitId, value]) => {
        const input = document.querySelector(`.reading-prev[data-unit="${unitId}"]`);
        if(input){
          input.value = value;
          input.dispatchEvent(new Event('input'));
        }
      });

      alert('ì´ì „ ì •ì‚°ì˜ í˜„ì›” ê²€ì¹¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    })
    .catch(() => alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
}

// ì¸µ ì„ íƒ ë™ê¸°í™”
document.getElementById('floorSelect').addEventListener('change', (e) => {
  const id = e.target.value;
  document.getElementById('electric_floor_id').value = id;
  if(id) {
    renderReadingTable(id);
    renderUnitsInfoCards(id);
  }
});

document.getElementById('electric_floor_id').addEventListener('change', (e) => {
  const id = e.target.value;
  document.getElementById('floorSelect').value = id;
  if(id) {
    renderReadingTable(id);
    renderUnitsInfoCards(id);
  }
});

// TV ëª¨ë“œ ë³€ê²½
document.getElementById('tv_mode').addEventListener('change', updateTvFeeInputs);

// ì „ê¸°ìš”ê¸ˆ í¼ ì œì¶œ
document.getElementById('electricForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
  if(rows.length === 0){
    alert('ì›”ë³„ ê³ ì§€ ë‚´ì—­ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
    return;
  }

  const floorId = document.getElementById('electric_floor_id').value;
  if(!floorId){
    alert('ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }

  e.target.querySelectorAll('input[type="number"]:not([disabled])').forEach(input => {
    if(!input.value || input.value.trim() === ''){
      input.value = '0';
    }
  });

  const fd = new FormData(e.target);
  fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');

  try {
    const res = await fetch('/calculate/electric', { method: 'POST', body: fd });
    const j = await res.json();

    if(j.exists){
      if(confirm('í•´ë‹¹ ì›”ì˜ ì „ê¸°ìš”ê¸ˆì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')){
        fd.set('overwrite', 'true');
        const res2 = await fetch('/calculate/electric', { method: 'POST', body: fd });
        const j2 = await res2.json();
        alert(j2.message || (j2.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        if(j2.success) location.reload();
      }
    } else {
      if(j.success) {
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.reload();
      } else {
        alert('ì˜¤ë¥˜: ' + (j.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    }
  } catch(error) {
    alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
});

// ìˆ˜ë„ìš”ê¸ˆ í¼ ì œì¶œ
document.getElementById('waterForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  e.target.querySelectorAll('input[type="number"]').forEach(input => {
    if(!input.value || input.value.trim() === ''){
      input.value = '0';
    }
  });

  const fd = new FormData(e.target);
  fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');

  try {
    const res = await fetch('/calculate/water', { method: 'POST', body: fd });
    const j = await res.json();

    if(j.exists){
      if(confirm('í•´ë‹¹ ì›”ì˜ ìˆ˜ë„ìš”ê¸ˆì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ë®ì–´ì“¸ê¹Œìš”?')){
        fd.set('overwrite', 'true');
        const res2 = await fetch('/calculate/water', { method: 'POST', body: fd });
        const j2 = await res2.json();
        alert(j2.message || (j2.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
        if(j2.success) location.reload();
      }
    } else {
      alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
      if(j.success) location.reload();
    }
  } catch(error) {
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
});

// ê³µë™ ê³µê³¼ê¸ˆ í¼ ì œì¶œ
document.getElementById('commonForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  e.target.querySelectorAll('input[type="number"]').forEach(input => {
    if(!input.value || input.value.trim() === ''){
      input.value = '0';
    }
  });

  const fd = new FormData(e.target);

  try {
    const res = await fetch('/calculate/common', { method: 'POST', body: fd });
    const j = await res.json();
    alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
    if(j.success) location.reload();
  } catch(error) {
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  }
});

// ì´ˆê¸°í™”
renderFloorOptions();
renderWaterSummary();
</script>
{% endblock %}