{% extends "base.html" %}
{% block title %}계산 - 공과금 정산 시스템{% endblock %}
{% block content %}
<h1>🧮 계산</h1>

<div class="grid grid-2">
  <div style="background:#f8fafc;padding:16px;border-radius:12px;">
    <h3>요약</h3>
    <ul>
      <li>총 세대: <strong>{{ total_units }}</strong></li>
      <li>재실 세대: <strong>{{ occupied_units }}</strong></li>
      <li>공실 세대: <strong>{{ vacant_units }}</strong></li>
      <li>총 거주 인원: <strong>{{ total_residents }}</strong></li>
    </ul>
  </div>
  <div style="background:#f8fafc;padding:16px;border-radius:12px;">
    <h3>빠른 선택</h3>
    <label>층 선택</label>
    <select id="floorSelect"></select>
    <small style="display:block;color:#64748b;margin-top:8px;">층을 선택하면 전기 검침 입력 표가 해당 층 세대로 채워집니다.</small>
  </div>
</div>

<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">⚡ 전기요금 계산</h2>
  <form id="electricForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>정산월</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>층</label>
        <select name="floor_id" id="electric_floor_id" required></select>
      </div>
      <div class="form-group">
        <label>전기 총액</label>
        <input type="number" name="total_amount" min="0" required>
      </div>
      <div class="form-group">
        <label>복지 할인 총액</label>
        <input type="number" name="welfare_discount" min="0" value="0" required>
      </div>
      <div class="form-group">
        <label>바우처 할인 총액</label>
        <input type="number" name="voucher_discount" min="0" value="0" required>
      </div>
      <div class="form-group">
        <label>정산 개월수</label>
        <input type="number" name="billing_months_count" min="1" max="12" value="1" required>
        <small style="color:#64748b;">N개월 묶음 정산시 입력</small>
      </div>
      <div class="form-group">
        <label>TV 수신료 배분</label>
        <select name="tv_distribution_mode">
          <option value="INDIVIDUAL">개별 부과 (TV 보유 세대만)</option>
          <option value="EQUAL">균등 분배 (재실 세대 전체)</option>
        </select>
      </div>
      <div class="form-group" style="align-self:end;">
        <label style="visibility:hidden;">중복 처리</label>
        <label class="checkbox-wrapper"><input type="checkbox" name="overwrite"><span>기존 정산 덮어쓰기</span></label>
      </div>
    </div>

    <div id="readingTableWrap" style="margin-top:16px;"></div>

    <div style="margin-top:12px;display:flex;gap:12px;">
      <button type="button" class="btn" onclick="loadPrevReadings()">이전 정산 현월값 불러오기</button>
      <button type="submit" class="btn btn-primary">전기요금 계산 저장</button>
    </div>
  </form>
</div>

<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">💧 수도요금 계산</h2>
  <form id="waterForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>정산월</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>수도 총액 (주택)</label>
        <input type="number" name="total_amount" min="0" required>
      </div>
      <div class="form-group">
        <label>복지 할인 총액</label>
        <input type="number" name="welfare_discount_total" min="0" value="0" required>
      </div>
      <div class="form-group" style="align-self:end;">
        <label style="visibility:hidden;">중복 처리</label>
        <label class="checkbox-wrapper"><input type="checkbox" name="overwrite"><span>기존 정산 덮어쓰기</span></label>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">수도요금 계산 저장</button>
    </div>
  </form>
</div>

<div style="margin-top:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08)">
  <h2 style="margin-bottom:12px;">🏘️ 공동 공과금</h2>
  <form id="commonForm">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-4">
      <div class="form-group">
        <label>정산월</label>
        <input type="month" name="billing_month" required>
      </div>
      <div class="form-group">
        <label>항목 설명</label>
        <input type="text" name="description" placeholder="예: 청소비, 엘리베이터 유지보수 등" required>
      </div>
      <div class="form-group">
        <label>총액</label>
        <input type="number" name="total_amount" min="0" required>
      </div>
      <div class="form-group">
        <label>분배 방식</label>
        <select name="distribution_method">
          <option value="BY_RESIDENTS">인원수 비례</option>
          <option value="BY_UNITS">세대 균등</option>
        </select>
      </div>
    </div>
    <div style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">공동 공과금 저장</button>
    </div>
  </form>
</div>

{% endblock %}

{% block scripts %}
<script>
const FLOORS = {{ (floors_json|default([]))|tojson }};
const UNITS = {{ (units_json|default([]))|tojson }};

function renderFloorOptions(){
  const sel1 = document.getElementById('floorSelect');
  const sel2 = document.getElementById('electric_floor_id');
  [sel1, sel2].forEach(sel => {
    sel.innerHTML = '<option value="">선택</option>' + FLOORS.map(f => `<option value="${f.id}">${f.name || (f.floor_number < 0 ? 'B' + (-f.floor_number) + '층' : f.floor_number + '층')}</option>`).join('');
  });
}

function renderReadingTable(floorId){
  const wrap = document.getElementById('readingTableWrap');
  const units = UNITS.filter(u => u.floor_id == floorId && !u.is_vacant);
  if(units.length === 0){
    wrap.innerHTML = '<p style="color:#94a3b8;">해당 층의 재실 세대가 없습니다.</p>';
    return;
  }
  let html = '<h4>검침 입력</h4><table><thead><tr><th>세대</th><th>전월 검침</th><th>현월 검침</th><th>사용량</th></tr></thead><tbody>';
  units.forEach(u => {
    html += `<tr>
      <td><strong>${u.unit_name}</strong></td>
      <td><input type="number" name="prev_${u.id}" step="0.01" value="0" onchange="calcUsage(${u.id})"></td>
      <td><input type="number" name="curr_${u.id}" step="0.01" value="0" onchange="calcUsage(${u.id})"></td>
      <td><span id="usage_${u.id}">0</span></td>
    </tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function calcUsage(unitId){
  const prev = parseFloat(document.querySelector(`[name="prev_${unitId}"]`).value || 0);
  const curr = parseFloat(document.querySelector(`[name="curr_${unitId}"]`).value || 0);
  document.getElementById(`usage_${unitId}`).textContent = (curr - prev).toFixed(2);
}

document.getElementById('floorSelect').addEventListener('change', (e)=>{
  const id = e.target.value;
  document.getElementById('electric_floor_id').value = id;
  if(id){ renderReadingTable(id); }
});

document.getElementById('electric_floor_id').addEventListener('change', (e)=>{
  const id = e.target.value;
  document.getElementById('floorSelect').value = id;
  if(id){ renderReadingTable(id); }
});

function loadPrevReadings(){
  const monthInput = document.querySelector('#electricForm [name="billing_month"]');
  const floorId = document.getElementById('electric_floor_id').value;
  if(!monthInput.value || !floorId){ alert('정산월과 층을 먼저 선택하세요.'); return; }
  fetch(`/get_previous_readings/${floorId}/${monthInput.value}`)
    .then(r=>r.json()).then(j=>{
      if(!j.success){ alert(j.message || '이전 정산 검침 불러오기에 실패했습니다.'); return; }
      const map = j.readings || {};
      Object.entries(map).forEach(([uid, val])=>{
        const input = document.querySelector(`#readingTableWrap [name="prev_${uid}"]`);
        if(input) {
          input.value = val;
          calcUsage(uid);
        }
      });
      alert('이전 정산의 현월 검침을 불러왔습니다.');
    }).catch(()=> alert('통신 오류가 발생했습니다.'));
}

document.getElementById('electricForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');
  const res = await fetch('/calculate/electric', { method:'POST', body: fd });
  const j = await res.json();
  if(j.exists){
    if(confirm('해당 월의 전기요금이 이미 존재합니다. 덮어쓸까요?')){
      fd.set('overwrite','true');
      const res2 = await fetch('/calculate/electric', { method:'POST', body: fd });
      const j2 = await res2.json();
      alert(j2.message || (j2.success ? '저장되었습니다.' : '실패했습니다.'));
    }
  }else{
    alert(j.message || (j.success ? '저장되었습니다.' : '실패했습니다.'));
  }
});

document.getElementById('waterForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  fd.set('overwrite', e.target.overwrite.checked ? 'true' : 'false');
  const res = await fetch('/calculate/water', { method:'POST', body: fd });
  const j = await res.json();
  if(j.exists){
    if(confirm('해당 월의 수도요금이 이미 존재합니다. 덮어쓸까요?')){
      fd.set('overwrite','true');
      const res2 = await fetch('/calculate/water', { method:'POST', body: fd });
      const j2 = await res2.json();
      alert(j2.message || (j2.success ? '저장되었습니다.' : '실패했습니다.'));
    }
  }else{
    alert(j.message || (j.success ? '저장되었습니다.' : '실패했습니다.'));
  }
});

document.getElementById('commonForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch('/calculate/common', { method:'POST', body: fd });
  const j = await res.json();
  alert(j.message || (j.success ? '저장되었습니다.' : '실패했습니다.'));
});

// init
renderFloorOptions();
</script>
{% endblock %}