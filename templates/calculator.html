{% extends "base.html" %}
{% block title %}ê³„ì‚° - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
    <h1><span class="emoji">ğŸ§®</span> ê³„ì‚°</h1>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="tabs">
        <button class="tab active" onclick="showCalcTab('electric-tab', event)">âš¡ ì „ê¸°ìš”ê¸ˆ</button>
        <button class="tab" onclick="showCalcTab('water-tab', event)">ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ</button>
        <button class="tab" onclick="showCalcTab('common-tab', event)">ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ</button>
    </div>
    <div class="tabs-container">
        <!-- ì „ê¸°ìš”ê¸ˆ íƒ­ -->
        <div id="electric-tab" class="tab-content">
            <!-- í—¤ë” ì„¹ì…˜ -->
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h2 style="margin:0;color:#1e293b;font-size:22px;font-weight:700;">âš¡ ì „ê¸°ìš”ê¸ˆ ê³„ì‚°</h2>
                    {% if electric_bill_url %}
                        <button type="button" class="btn btn-secondary"
                                onclick="window.open('{{ electric_bill_url }}', '_blank')" style="padding:10px 20px;font-size:14px;">
                            ğŸ” ìš”ê¸ˆ ì¡°íšŒ
                        </button>
                    {% endif %}
                </div>
                <p style="margin:0;color:#64748b;font-size:14px;line-height:1.6;">
                    ì¸µë‹¨ìœ„ ì „ê¸°ìš”ê¸ˆì„ ê° ì„¸ëŒ€ì˜ ê³„ëŸ‰ê¸° ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë¹„ë¡€ ë¶„ë°°í•©ë‹ˆë‹¤. Nê°œì›” ë¬¶ìŒ ì •ì‚°ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>
            </div>

            <form id="electricForm">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="month_count" id="month_count" value="0">

                <!-- ê¸°ë³¸ ì •ë³´ ì…ë ¥ -->
                <div style="background:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin:0 0 20px 0;color:#334155;font-size:16px;font-weight:600;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label>ì •ì‚°ì›”</label>
                            <input type="month" name="billing_month" id="billing_month" required>
                        </div>
                        <div class="form-group">
                            <label>ì¸µ ì„ íƒ</label>
                            <select name="floor_id" id="electric_floor_id" required></select>
                        </div>
                        <div class="form-group">
                            <label>TV ìˆ˜ì‹ ë£Œ ë°°ë¶„</label>
                            <select name="tv_distribution_mode" id="tv_mode">
                                <option value="INDIVIDUAL">ê°œë³„ ë¶€ê³¼ (TV ë³´ìœ  ì„¸ëŒ€ë§Œ)</option>
                                <option value="EQUAL" selected>ê· ë“± ë¶„ë°° (ì¬ì‹¤ ì„¸ëŒ€ ì „ì²´)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ì›”ë³„ ê³ ì§€ ë‚´ì—­ ì…ë ¥ -->
                <div style="background:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h4 style="margin:0;color:#334155;font-size:16px;font-weight:600;">ğŸ“‹ ì›”ë³„ ê³ ì§€ ë‚´ì—­</h4>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addMonthBillRow()" style="padding:8px 16px;font-size:13px;">
                            + ì›” ì¶”ê°€
                        </button>
                    </div>

                    <div style="background:#f8fafc;padding:15px;border-radius:8px;margin-bottom:15px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                            <tr style="background:#e2e8f0;">
                                <th style="padding:12px;text-align:left;border-bottom:2px solid #cbd5e1;width:140px;">
                                    ê³ ì§€ì›”
                                </th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">ì „ê¸°ìš”ê¸ˆ</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">ë³µì§€í• ì¸</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">ë°”ìš°ì²˜í• ì¸</th>
                                <th style="padding:12px;text-align:right;border-bottom:2px solid #cbd5e1;">TVìˆ˜ì‹ ë£Œ ì´ì•¡</th>
                                <th style="padding:12px;text-align:center;border-bottom:2px solid #cbd5e1;width:80px;text-align:center;">
                                    ì‘ì—…
                                </th>
                            </tr>
                            </thead>
                            <tbody id="monthlyBillsContainer">
                            </tbody>
                        </table>
                    </div>

                    <div style="padding:15px; background:#e0f2fe; border-radius:8px;border-left:4px solid #0284c7;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
                            <div style="color:#0c4a6e;font-weight:600;font-size:15px;">ğŸ“Š í•©ê³„</div>
                            <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:14px;color:#0c4a6e;">
                                <span>ì´ì•¡: <strong id="totalAmount">0</strong>ì›</span>
                                <span>ë³µì§€í• ì¸: <strong id="totalWelfare">0</strong>ì›</span>
                                <span>ë°”ìš°ì²˜í• ì¸: <strong id="totalVoucher">0</strong>ì›</span>
                                <span>TVìˆ˜ì‹ ë£Œ: <strong id="totalTvFee">0</strong>ì›</span>
                            </div>
                        </div>
                    </div>

                    <div style="background:#fef3c7;padding:12px;border-radius:8px;margin-top:15px;font-size:13px;color:#92400e;line-height:1.6;">
                        <strong>ğŸ’¡ TV ìˆ˜ì‹ ë£Œ ì•ˆë‚´:</strong><br>
                        â€¢ <strong>ê°œë³„ ë¶€ê³¼ ëª¨ë“œ:</strong> TV ë³´ìœ  ì„¸ëŒ€ë§Œ ì„¤ì •ì˜ TV ë‹¨ê°€ Ã— ê°œì›”ìˆ˜ê°€ ë¶€ê³¼ë©ë‹ˆë‹¤. TVìˆ˜ì‹ ë£Œ ì…ë ¥ì¹¸ì€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.<br>
                        â€¢ <strong>ê· ë“± ë¶„ë°° ëª¨ë“œ:</strong> TVìˆ˜ì‹ ë£Œ ì…ë ¥ì¹¸ì— ì›”ë³„ ì´ TV ìˆ˜ì‹ ë£Œë¥¼ ì…ë ¥í•˜ë©´, ê³µì‹¤ì„ ì œì™¸í•œ ëª¨ë“  ì¬ì‹¤ ì„¸ëŒ€ê°€ ê· ë“± ë¶„ë‹´í•©ë‹ˆë‹¤.
                    </div>
                </div>

                <!-- ê²€ì¹¨ ì…ë ¥ (ë™ì ìœ¼ë¡œ ìƒì„±ë¨) -->
                <div id="unitsInfoCardContainer"></div>
                <div id="readingTableWrap"></div>

                <!-- ì €ì¥ ì˜ì—­ -->
                <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap;">
                        <label class="checkbox-wrapper" style="margin:0;cursor:pointer;">
                            <input type="checkbox" name="overwrite" style="cursor:pointer;">
                            <span style="font-size:14px;color:#475569;font-weight:500;">ê¸°ì¡´ ì •ì‚° ë°ì´í„° ë®ì–´ì“°ê¸°</span>
                        </label>
                        <button type="submit" class="btn btn-primary" style="padding:12px 32px;font-size:15px;font-weight:600;">
                            ì „ê¸°ìš”ê¸ˆ ì €ì¥
                        </button>
                    </div>
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
                        <p style="margin:0;font-size:12px;color:#64748b;line-height:1.6;">
                            ğŸ’¡ ë™ì¼í•œ ì •ì‚°ì›”/ì¸µì— ëŒ€í•œ ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œìš´ ë°ì´í„°ë¡œ êµì²´í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <!-- ìˆ˜ë„ìš”ê¸ˆ íƒ­ -->
        <div id="water-tab" class="tab-content">
            <!-- í—¤ë” ì„¹ì…˜ -->
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h2 style="margin:0;color:#1e293b;font-size:22px;font-weight:700;">ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ ê³„ì‚°</h2>
                    {% if water_bill_url %}
                        <button type="button" class="btn btn-secondary"
                                onclick="window.open('{{ water_bill_url }}', '_blank')" style="padding:10px 20px;font-size:14px;">
                            ğŸ” ìš”ê¸ˆ ì¡°íšŒ
                        </button>
                    {% endif %}
                </div>
                <p style="margin:0;color:#64748b;font-size:14px;line-height:1.6;">
                    ì£¼íƒ ì „ì²´ ìˆ˜ë„ìš”ê¸ˆì„ ê° ì„¸ëŒ€ì˜ ê±°ì£¼ ì¸ì›ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ë¶„ë°°í•©ë‹ˆë‹¤. íŠ¹ì • ì„¸ëŒ€ë¥¼ ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì„¸ëŒ€ ì„ íƒ ì„¹ì…˜ -->
            <div id="waterUnitsSelection" style="margin-bottom:24px;"></div>

            <form id="waterForm">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="excluded_units" id="excluded_units" value="[]">

                <!-- ìš”ê¸ˆ ì •ë³´ ì…ë ¥ -->
                <div style="background:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin:0 0 20px 0;color:#334155;font-size:16px;font-weight:600;">ğŸ’° ìš”ê¸ˆ ì •ë³´</h4>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label>ì •ì‚°ì›”</label>
                            <input type="month" name="billing_month" required>
                        </div>
                        <div class="form-group">
                            <label>ìˆ˜ë„ ì´ì•¡ (ì›)</label>
                            <input type="number" name="total_amount" min="0" placeholder="0" required>
                        </div>
                        <div class="form-group">
                            <label>ë³µì§€ í• ì¸ ì´ì•¡ (ì›)</label>
                            <input type="number" name="welfare_discount_total" min="0" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- ì €ì¥ ì˜ì—­ -->
                <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0;">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap;">
                        <label class="checkbox-wrapper" style="margin:0;cursor:pointer;">
                            <input type="checkbox" name="overwrite" style="cursor:pointer;">
                            <span style="font-size:14px;color:#475569;font-weight:500;">ê¸°ì¡´ ì •ì‚° ë°ì´í„° ë®ì–´ì“°ê¸°</span>
                        </label>
                        <button type="submit" class="btn btn-primary" style="padding:12px 32px;font-size:15px;font-weight:600;">
                            ìˆ˜ë„ìš”ê¸ˆ ì €ì¥
                        </button>
                    </div>
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid #e2e8f0;">
                        <p style="margin:0;font-size:12px;color:#64748b;line-height:1.6;">
                            ğŸ’¡ ë™ì¼í•œ ì •ì‚°ì›”ì— ëŒ€í•œ ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°, ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ìƒˆë¡œìš´ ë°ì´í„°ë¡œ êµì²´í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </form>
        </div>

        <!-- ê³µë™ ê³µê³¼ê¸ˆ íƒ­ -->
        <div id="common-tab" class="tab-content">
            <div style="background:white;padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                <h2 style="margin:0 0 16px 0;color:#1e293b;font-size:22px;font-weight:700;">ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ ê³„ì‚°</h2>
                <p style="margin:0;color:#64748b;font-size:14px;line-height:1.6;">
                    ì¸í„°ë„·, ê´€ë¦¬ë¹„, ê¸°íƒ€ ë“±ì˜ ê³µë™ ê³µê³¼ê¸ˆì„ ì…ë ¥í•©ë‹ˆë‹¤. ë¶„ë°° ë°©ì‹(ì¸ì› ë¹„ë¡€ ë˜ëŠ” ì„¸ëŒ€ ê· ë“±)ì„ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <form id="commonForm">
                <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">

                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div style="background:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin:0 0 20px 0;color:#334155;font-size:16px;font-weight:600;">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h4>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>ì •ì‚°ì›”</label>
                            <input type="month" name="billing_month" required>
                        </div>
                        <div class="form-group">
                            <label>ë¶„ë°° ë°©ì‹</label>
                            <select name="distribution_mode" required>
                                <option value="RESIDENTS">ì¸ì› ë¹„ë¡€ (ê±°ì£¼ ì¸ì›ìˆ˜ì— ë¹„ë¡€)</option>
                                <option value="UNIT">ì„¸ëŒ€ ê· ë“± (ì¬ì‹¤ ì„¸ëŒ€ìˆ˜ë¡œ ê· ë“±)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- í•­ëª©ë³„ ê¸ˆì•¡ -->
                <div style="background:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin:0 0 20px 0;color:#334155;font-size:16px;font-weight:600;">ğŸ’° í•­ëª©ë³„ ê¸ˆì•¡</h4>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label>ì¸í„°ë„· (ì›)</label>
                            <input type="number" name="internet_amount" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>ê´€ë¦¬ë¹„ (ì›)</label>
                            <input type="number" name="management_amount" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>ê¸°íƒ€ (ì›)</label>
                            <input type="number" name="other_amount" min="0" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- ë¶„ë°° ë°©ì‹ ì•ˆë‚´ -->
                <div style="background:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
                    <h4 style="margin:0 0 16px 0;color:#334155;font-size:16px;font-weight:600;">ğŸ“Š ë¶„ë°° ë°©ì‹ ì•ˆë‚´</h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;">
                        <div style="background:#fef3c7;padding:16px;border-radius:8px;border:1px solid #fbbf24;">
                            <div style="font-weight:600;color:#92400e;margin-bottom:8px;font-size:14px;">ğŸ‘¥ ì¸ì› ë¹„ë¡€</div>
                            <div style="font-size:13px;color:#92400e;line-height:1.6;">
                                ê±°ì£¼ ì¸ì›ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ë¶„ë°°í•©ë‹ˆë‹¤. ì¸ì›ì´ ë§ì€ ì„¸ëŒ€ê°€ ë” ë§ì´ ë¶€ë‹´í•©ë‹ˆë‹¤.
                            </div>
                        </div>
                        <div style="background:#e0f2fe;padding:16px;border-radius:8px;border:1px solid #0ea5e9;">
                            <div style="font-weight:600;color:#0c4a6e;margin-bottom:8px;font-size:14px;">ğŸ  ì„¸ëŒ€ ê· ë“±</div>
                            <div style="font-size:13px;color:#0c4a6e;line-height:1.6;">
                                ì¬ì‹¤ ì„¸ëŒ€ìˆ˜ë¡œ ê· ë“±í•˜ê²Œ ë¶„ë°°í•©ë‹ˆë‹¤. ì¸ì›ìˆ˜ì™€ ê´€ê³„ì—†ì´ ëª¨ë“  ì„¸ëŒ€ê°€ ë™ì¼í•˜ê²Œ ë¶€ë‹´í•©ë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì €ì¥ ì˜ì—­ -->
                <div style="background:#f8fafc;padding:20px;border-radius:12px;border:1px solid #e2e8f0;text-align:right;">
                    <button type="submit" class="btn btn-primary" style="padding:12px 32px;font-size:15px;font-weight:600;">
                        ê³µë™ ê³µê³¼ê¸ˆ ì €ì¥
                    </button>
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        const FLOORS = {{ (floors_json|default([]))|tojson }};
        const UNITS = {{ (units_json|default([]))|tojson }};

        let monthRowCounter = 0;
        let waterExcludedUnits = new Set();

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        function showCalcTab(tabId, event) {
            document.querySelectorAll('#electric-tab, #water-tab, #common-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabId).style.display = 'block';
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // ì¸µ ì˜µì…˜ ë Œë”ë§
        function renderFloorOptions() {
            const sel2 = document.getElementById('electric_floor_id');
            const options = '<option value="">ì„ íƒ</option>' + FLOORS.map(f => {
                const floorLabel = f.floor_number < 0 ? 'B' + (-f.floor_number) + 'ì¸µ' : f.floor_number + 'ì¸µ';
                let displayLabel = f.name ? `${floorLabel} (${f.name})` : floorLabel;
                return `<option value="${f.id}">${displayLabel}</option>`;
            }).join('');
            sel2.innerHTML = options;
        }

        // ì›”ë³„ ê³ ì§€ í–‰ ì¶”ê°€
        function addMonthBillRow() {
            const container = document.getElementById('monthlyBillsContainer');
            const rowId = monthRowCounter++;

            const row = document.createElement('tr');
            row.className = 'month-bill-row';
            row.id = `bill-row-${rowId}`;
            row.style.borderBottom = '1px solid #e2e8f0';

            row.innerHTML = `
                <td style="padding:10px;">
                    <input type="month" name="bill_month_${rowId}" required
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;font-size:13px;">
                </td>
                <td style="padding:10px;">
                    <input type="number" name="bill_amount_${rowId}" min="0" placeholder="0" required
                           class="bill-amount"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;text-align:right;font-size:13px;">
                </td>
                <td style="padding:10px;">
                    <input type="number" name="bill_welfare_${rowId}" min="0" placeholder="0"
                           class="bill-welfare"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;text-align:right;font-size:13px;">
                </td>
                <td style="padding:10px;">
                    <input type="number" name="bill_voucher_${rowId}" min="0" placeholder="0"
                           class="bill-voucher"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;text-align:right;font-size:13px;">
                </td>
                <td style="padding:10px;">
                    <input type="number" name="bill_tv_fee_${rowId}" min="0" placeholder="0"
                           class="bill-tv-fee"
                           style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:6px;text-align:right;font-size:13px;">
                </td>
                <td style="padding:10px;text-align:center;">
                    <button type="button" class="btn btn-danger btn-sm"
                            onclick="removeMonthBillRow(${rowId})"
                            style="padding:6px 12px;font-size:12px;">ì‚­ì œ</button>
                </td>
            `;

            container.appendChild(row);

            row.querySelectorAll('.bill-amount, .bill-welfare, .bill-voucher, .bill-tv-fee').forEach(input => {
                input.addEventListener('input', updateTotals);
            });

            updateTotals();
            updateMonthCount();
        }

        function removeMonthBillRow(rowId) {
            const row = document.getElementById(`bill-row-${rowId}`);
            if (row) {
                row.remove();
                updateTotals();
                updateMonthCount();
            }
        }

        function updateMonthCount() {
            const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
            document.getElementById('month_count').value = rows.length;
        }

        function updateTotals() {
            const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
            let totalAmount = 0;
            let totalWelfare = 0;
            let totalVoucher = 0;
            let totalTvFee = 0;

            rows.forEach(row => {
                totalAmount += parseFloat(row.querySelector('.bill-amount').value || 0);
                totalWelfare += parseFloat(row.querySelector('.bill-welfare').value || 0);
                totalVoucher += parseFloat(row.querySelector('.bill-voucher').value || 0);
                totalTvFee += parseFloat(row.querySelector('.bill-tv-fee').value || 0);
            });

            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
            document.getElementById('totalWelfare').textContent = totalWelfare.toLocaleString();
            document.getElementById('totalVoucher').textContent = totalVoucher.toLocaleString();
            document.getElementById('totalTvFee').textContent = totalTvFee.toLocaleString();
        }

        // TV ëª¨ë“œ ë³€ê²½ ì‹œ ì…ë ¥ì¹¸ í™œì„±í™”/ë¹„í™œì„±í™”
        function updateTvFeeInputs() {
            const mode = document.getElementById('tv_mode').value;
            const tvInputs = document.querySelectorAll('.bill-tv-fee');

            tvInputs.forEach(input => {
                if (mode === 'INDIVIDUAL') {
                    input.disabled = true;
                    input.value = '0';
                    input.style.background = '#f1f5f9';
                } else {
                    input.disabled = false;
                    input.style.background = 'white';
                }
            });
            updateTotals();
        }

        // ì„¸ëŒ€ ì •ë³´ ì¹´ë“œ ë Œë”ë§
        function renderUnitsInfoCards(floorId) {
            const container = document.getElementById('unitsInfoCardContainer');
            if (!container) return;

            floorId = parseInt(floorId);
            if (!floorId) {
                container.innerHTML = '';
                return;
            }

            const units = UNITS.filter(u => u.floor_id === floorId);
            if (units.length === 0) {
                container.innerHTML = '<div style="background:#fee2e2;padding:16px;border-radius:8px;border:1px solid #ef4444;color:#991b1b;text-align:center;">í•´ë‹¹ ì¸µì— ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const selectedFloor = FLOORS.find(f => f.id === floorId);
            const floorLabel = selectedFloor ?
                (selectedFloor.floor_number < 0 ? 'B' + (-selectedFloor.floor_number) + 'ì¸µ' : selectedFloor.floor_number + 'ì¸µ') : '';
            const floorName = selectedFloor && selectedFloor.name ? selectedFloor.name : '';
            const floorContract = selectedFloor && selectedFloor.electric_contract_number ?
                selectedFloor.electric_contract_number : null;

            const occupiedCount = units.filter(u => !u.is_vacant).length;
            const vacantCount = units.filter(u => u.is_vacant).length;
            const tvCount = units.filter(u => !u.is_vacant && u.has_tv).length;
            const welfareCount = units.filter(u => !u.is_vacant && u.electric_welfare).length;
            const voucherCount = units.filter(u => !u.is_vacant && u.electric_voucher).length;

            let html = `
        <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:24px;">
            <!-- ì¸µ ì •ë³´ í—¤ë” -->
            <div style="margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #e2e8f0;">
                <h4 style="margin:0 0 8px 0;color:#1e293b;font-size:16px;font-weight:600;">
                    ${floorLabel}${floorName ? ' (' + floorName + ')' : ''} ì„¸ëŒ€ ì •ë³´
                </h4>
                ${floorContract ? `<div style="color:#64748b;font-size:14px;font-weight:500;">ê³„ì•½ë²ˆí˜¸: <span style="font-family:monospace;color:#475569;font-weight:600;">${floorContract}</span></div>` : ''}
            </div>

            <!-- í†µê³„ ìš”ì•½ -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px;margin-bottom:20px;">
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ì¬ì‹¤</div>
                    <div style="font-size:22px;font-weight:700;color:#059669;">${occupiedCount}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ê³µì‹¤</div>
                    <div style="font-size:22px;font-weight:700;color:#dc2626;">${vacantCount}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">TV</div>
                    <div style="font-size:22px;font-weight:700;color:#f59e0b;">${tvCount}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ë³µì§€</div>
                    <div style="font-size:22px;font-weight:700;color:#667eea;">${welfareCount}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ë°”ìš°ì²˜</div>
                    <div style="font-size:22px;font-weight:700;color:#667eea;">${voucherCount}</div>
                </div>
            </div>

            <!-- ì„¸ëŒ€ ì¹´ë“œ -->
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
    `;

            units.forEach(u => {
                const badges = [];
                if (u.is_vacant) badges.push('<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">ê³µì‹¤</span>');
                else badges.push('<span style="background:#d1fae5;color:#059669;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">ì¬ì‹¤</span>');

                if (!u.is_vacant) {
                    if (u.has_tv) badges.push('<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">TV</span>');
                    if (u.electric_welfare) badges.push('<span style="background:#ddd6fe;color:#5b21b6;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">ë³µì§€</span>');
                    if (u.electric_voucher) badges.push('<span style="background:#ddd6fe;color:#5b21b6;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:500;">ë°”ìš°ì²˜</span>');
                }

                html += `
            <div style="background:white;padding:12px;border-radius:8px;border:1px solid ${u.is_vacant ? '#fecaca' : '#cbd5e1'};min-height:110px;display:flex;flex-direction:column;">
                <div style="font-weight:600;font-size:14px;color:#1e293b;margin-bottom:8px;">${u.unit_name}</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                    ${badges.join('')}
                </div>
                <div style="margin-top:auto;">
                    ${!u.is_vacant ? `<div style="font-size:12px;color:#64748b;">${u.residents_count}ëª… ê±°ì£¼</div>` : '<div style="font-size:12px;color:#94a3b8;">ê³µì‹¤</div>'}
                </div>
            </div>
        `;
            });

            html += `
            </div>
        </div>
    `;

            container.innerHTML = html;
        }

        // ê²€ì¹¨ ì…ë ¥ í…Œì´ë¸” ë Œë”ë§
        function renderReadingTable(floorId) {
            const wrap = document.getElementById('readingTableWrap');
            if (!wrap) {
                const altWrap = document.getElementById('unitsInfoCardContainer');
                if (altWrap) {
                    const existingCard = altWrap.querySelector('[style*="ê²€ì¹¨ ì…ë ¥"]');
                    if (existingCard) return;
                }
            }

            const container = wrap || document.getElementById('unitsInfoCardContainer');
            if (!container) return;

            floorId = parseInt(floorId);
            if (!floorId) {
                return;
            }

            const units = UNITS.filter(u => u.floor_id === floorId && !u.is_vacant);
            if (units.length === 0) {
                return;
            }

            const selectedFloor = FLOORS.find(f => f.id === floorId);
            const floorLabel = selectedFloor ?
                (selectedFloor.floor_number < 0 ? 'B' + (-selectedFloor.floor_number) + 'ì¸µ' : selectedFloor.floor_number + 'ì¸µ') : '';
            const floorName = selectedFloor && selectedFloor.name ? ` (${selectedFloor.name})` : '';
            const contractNumber = selectedFloor && selectedFloor.electric_contract_number ? selectedFloor.electric_contract_number : '';

            let html = `
                <div style="background:white;padding:25px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);margin-bottom:24px;">
                    <div style="display:grid;grid-template-columns: 1fr auto;grid-template-rows: auto auto;align-items:center;column-gap:12px;row-gap:8px;margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid #e2e8f0;">
                        <h4 style="margin:0;color:#1e293b;font-size:18px;font-weight:700;">
                          âš¡ ê²€ì¹¨ ì…ë ¥ - ${floorLabel}${floorName}
                        </h4>
                        <button type="button" class="btn btn-secondary" onclick="loadPreviousReadings()"
                                style="padding:10px 16px;font-size:14px;justify-self:end;white-space:nowrap;">
                          ğŸ“¥ ì´ì „ ì •ì‚°ì˜ í˜„ì›” ê²€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        ${contractNumber ? `
                          <div style="color:#64748b;font-size:14px;font-weight:500;">
                            ê³„ì•½ë²ˆí˜¸:
                            <span style="font-family:monospace;color:#475569;font-weight:600;">
                              ${contractNumber}
                            </span>
                          </div>` : '<div></div>'}
                        <p style="margin:0;font-size:12px;color:#64748b;justify-self:end;text-align:right;">
                          ğŸ’¡ ë™ì¼ ì¸µì˜ ê°€ì¥ ìµœê·¼ ì •ì‚° ë°ì´í„°ì—ì„œ í˜„ì›” ê²€ì¹¨ê°’ì„ ë¶ˆëŸ¬ì™€ ì „ì›” ê²€ì¹¨ë€ì— ìë™ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                        <!-- ì „ì›” ê²€ì¹¨ í…Œì´ë¸” -->
                        <div style="background:#fef3c7;padding:15px;border-radius:8px;border:2px solid #fed7aa;">
                            <h5 style="margin:0 0 15px 0;color:#92400e;font-size:16px;">ğŸ“‰ ì „ì›” ê²€ì¹¨</h5>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#fed7aa;">
                                        <th style="padding:10px;text-align:left;border-bottom:2px solid #fed7aa;width:90px;">ì„¸ëŒ€</th>
                                        <th style="padding:10px;text-align:left;border-bottom:2px solid #fed7aa;font-size:11px;">íŠ¹ì„±</th>
                                        <th style="padding:10px;text-align:center;border-bottom:2px solid #fed7aa;">ê²€ì¹¨ê°’</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            units.forEach(u => {
                const badges = [];
                if (u.has_tv) badges.push('TV');
                if (u.electric_welfare) badges.push('ë³µì§€');
                if (u.electric_voucher) badges.push('ë°”ìš°ì²˜');
                const badgeStr = badges.length > 0 ? badges.join(', ') : '-';

                html += `
                    <tr style="border-bottom:1px solid #fed7aa;">
                        <td style="padding:10px;"><strong>${u.unit_name}</strong></td>
                        <td style="padding:10px;font-size:12px;color:#9a3412;">${badgeStr}</td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" name="prev_${u.id}" step="0.01" placeholder="0.00"
                                   class="reading-prev" data-unit="${u.id}"
                                   style="width:130px;padding:8px;border:1px solid #fed7aa;border-radius:6px;text-align:right;font-size:14px;background:white;">
                        </td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>

                        <!-- í˜„ì›” ê²€ì¹¨ í…Œì´ë¸” -->
                        <div style="background:#ecfccb;padding:15px;border-radius:8px;border:2px solid #bef264;">
                            <h5 style="margin:0 0 15px 0;color:#365314;font-size:16px;">ğŸ“ˆ í˜„ì›” ê²€ì¹¨</h5>
                            <table style="width:100%;border-collapse:collapse;">
                                <thead>
                                    <tr style="background:#d9f99d;">
                                        <th style="padding:10px;text-align:left;border-bottom:2px solid #bef264;width:90px;">ì„¸ëŒ€</th>
                                        <th style="padding:10px;text-align:center;border-bottom:2px solid #bef264;">ê²€ì¹¨ê°’</th>
                                        <th style="padding:10px;text-align:center;border-bottom:2px solid #bef264;width:100px;">ì‚¬ìš©ëŸ‰</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            units.forEach(u => {
                html += `
                    <tr style="border-bottom:1px solid #bef264;">
                        <td style="padding:10px;"><strong>${u.unit_name}</strong></td>
                        <td style="padding:10px;text-align:center;">
                            <input type="number" name="curr_${u.id}" step="0.01" placeholder="0.00"
                                   class="reading-curr" data-unit="${u.id}"
                                   style="width:130px;padding:8px;border:1px solid #bef264;border-radius:6px;text-align:right;font-size:14px;background:white;">
                        </td>
                        <td style="padding:10px;text-align:center;">
                            <span class="usage-display" data-unit="${u.id}" style="font-weight:600;font-size:14px;color:#365314;">-</span>
                        </td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="background:#dbeafe;padding:12px;border-radius:8px;margin-top:15px;font-size:13px;color:#1e3a8a;line-height:1.6;">
                        <strong>ğŸ’¡ ì‚¬ìš©ëŸ‰ ê³„ì‚°:</strong> ì‚¬ìš©ëŸ‰ = í˜„ì›” ê²€ì¹¨ - ì „ì›” ê²€ì¹¨<br>
                        ì‚¬ìš©ëŸ‰ì´ ìŒìˆ˜ë¡œ í‘œì‹œë˜ë©´ ê²€ì¹¨ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (í˜„ì›” ê²€ì¹¨ì´ ì „ì›”ë³´ë‹¤ ì‘ì€ ê²½ìš°)
                    </div>
                </div>
            `;

            if (wrap) {
                wrap.innerHTML = html;
            } else {
                container.innerHTML += html;
            }

            document.querySelectorAll('.reading-prev, .reading-curr').forEach(input => {
                input.addEventListener('input', () => {
                    const unitId = input.dataset.unit;
                    const prevInput = document.querySelector(`.reading-prev[data-unit="${unitId}"]`);
                    const currInput = document.querySelector(`.reading-curr[data-unit="${unitId}"]`);
                    const usageSpan = document.querySelector(`.usage-display[data-unit="${unitId}"]`);

                    const prev = parseFloat(prevInput.value) || 0;
                    const curr = parseFloat(currInput.value) || 0;
                    const usage = curr - prev;

                    if (currInput.value && prevInput.value) {
                        usageSpan.textContent = usage.toFixed(2);

                        if (usage < 0) {
                            usageSpan.style.color = '#dc2626';
                            usageSpan.style.fontWeight = 'bold';
                            currInput.style.borderColor = '#dc2626';
                            currInput.style.borderWidth = '2px';
                            currInput.style.backgroundColor = '#fee2e2';
                            currInput.setAttribute('data-invalid', 'true');
                        } else {
                            usageSpan.style.color = '#059669';
                            usageSpan.style.fontWeight = 'bold';
                            currInput.style.borderColor = '#bef264';
                            currInput.style.borderWidth = '1px';
                            currInput.style.backgroundColor = 'white';
                            currInput.removeAttribute('data-invalid');
                        }
                    } else {
                        usageSpan.textContent = '-';
                        currInput.style.borderColor = '#bef264';
                        currInput.style.borderWidth = '1px';
                        currInput.style.backgroundColor = 'white';
                        currInput.removeAttribute('data-invalid');
                    }
                });
            });
        }

        // ìˆ˜ë„ ì„¸ëŒ€ ì„ íƒ UI ë Œë”ë§
        function renderWaterUnitsSelection() {
            const container = document.getElementById('waterUnitsSelection');
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);

            if (occupiedUnits.length === 0) {
                container.innerHTML = '<div style="background:#fee2e2;padding:16px;border-radius:8px;border:1px solid #ef4444;color:#991b1b;text-align:center;">ì¬ì‹¤ ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const waterWelfareUnits = occupiedUnits.filter(u => u.water_welfare);
            const totalResidents = occupiedUnits.reduce((sum, u) => sum + (u.residents_count || 1), 0);
            const selectedCount = occupiedUnits.length - waterExcludedUnits.size;
            const waterCustomerNumber = '{{ water_customer_number }}';

            let html = `
        <div style="background:white;padding:24px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
            <!-- í—¤ë” -->
            <div style="margin-bottom:20px;padding-bottom:20px;border-bottom:2px solid #e2e8f0;">
                <h4 style="margin:0 0 12px 0;color:#1e293b;font-size:18px;font-weight:700;">
                    ì •ì‚° ëŒ€ìƒ ì„¸ëŒ€ ì„ íƒ
                </h4>
                ${waterCustomerNumber ? `<div style="color:#64748b;font-size:14px;font-weight:500;">ì£¼íƒ ìˆ˜ë„ ê³ ê°ë²ˆí˜¸: <span style="font-family:monospace;color:#475569;font-weight:600;">${waterCustomerNumber}</span></div>` : ''}
                <p style="color:#64748b;font-size:13px;margin:8px 0 0 0;line-height:1.5;">
                    ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì •ì‚° ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”. ì¥ê¸° ì¶œì¥ ë“±ìœ¼ë¡œ ìˆ˜ë„ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ì„¸ëŒ€ëŠ” ì„ íƒ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- í†µê³„ ìš”ì•½ -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:12px;margin-bottom:24px;">
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ì „ì²´ ì„¸ëŒ€</div>
                    <div style="font-size:22px;font-weight:700;color:#0284c7;">${occupiedUnits.length}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ì„ íƒë¨</div>
                    <div style="font-size:22px;font-weight:700;color:#059669;" id="selectedCountDisplay">${selectedCount}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ì´ ì¸ì›</div>
                    <div style="font-size:22px;font-weight:700;color:#0284c7;">${totalResidents}</div>
                </div>
                <div style="text-align:center;padding:14px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;min-height:70px;display:flex;flex-direction:column;justify-content:center;">
                    <div style="font-size:11px;color:#64748b;margin-bottom:6px;font-weight:600;">ë³µì§€ í• ì¸</div>
                    <div style="font-size:22px;font-weight:700;color:#059669;">${waterWelfareUnits.length}</div>
                </div>
            </div>

            <!-- ì„¸ëŒ€ ì¹´ë“œ (ì¸µë³„ ê·¸ë£¹í™”) -->
    `;

            const floorGroups = {};
            occupiedUnits.forEach(unit => {
                if (!floorGroups[unit.floor_id]) {
                    const floor = FLOORS.find(f => f.id === unit.floor_id);
                    floorGroups[unit.floor_id] = {
                        floor_number: floor ? floor.floor_number : 999,
                        floor_name: floor ? floor.name : '',
                        units: []
                    };
                }
                floorGroups[unit.floor_id].units.push(unit);
            });

            Object.keys(floorGroups).sort((a, b) => {
                return floorGroups[a].floor_number - floorGroups[b].floor_number;
            }).forEach(floorId => {
                const group = floorGroups[floorId];
                const floorLabel = group.floor_number < 0 ? `B${-group.floor_number}ì¸µ` : `${group.floor_number}ì¸µ`;
                const floorDisplayName = group.floor_name ? `${floorLabel} (${group.floor_name})` : floorLabel;

                html += `<div style="margin-bottom:16px;">
                    <h5 style="margin:0 0 12px 0;color:#334155;font-size:15px;font-weight:600;">${floorDisplayName}</h5>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">`;

                group.units.forEach(unit => {
                    const isIncluded = !waterExcludedUnits.has(unit.id);
                    const badges = [];
                    if (unit.water_welfare) {
                        badges.push('<span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;">ë³µì§€</span>');
                    }
                    const borderColor = isIncluded ? '#0891b2' : '#cbd5e1';

                    html += `
                <div class="water-unit-card" data-unit-id="${unit.id}"
                     style="background:${isIncluded ? 'white' : '#f8fafc'};padding:12px;border-radius:8px;border:1px solid ${borderColor};cursor:pointer;transition:all 0.2s;min-height:110px;display:flex;flex-direction:column;"
                     onclick="toggleWaterUnit(${unit.id})">
                    <div style="display:flex;align-items:start;gap:8px;margin-bottom:8px;">
                        <input type="checkbox"
                               ${isIncluded ? 'checked' : ''}
                               onclick="event.stopPropagation(); toggleWaterUnit(${unit.id});"
                               style="width:16px;height:16px;cursor:pointer;margin-top:2px;accent-color:#0891b2;">
                        <div style="flex:1;">
                            <div style="font-weight:600;font-size:14px;color:#1e293b;margin-bottom:4px;">${unit.unit_name}</div>
                        </div>
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;">
                        ${badges.join('')}
                    </div>
                    <div style="margin-top:auto;">
                        <div style="font-size:12px;color:#64748b;">${unit.residents_count}ëª… ê±°ì£¼</div>
                    </div>
                </div>
            `;
                });

                html += '</div></div>';
            });

            html += `
        </div>
    `;

            container.innerHTML = html;
        }

        function toggleWaterUnit(unitId) {
            if (waterExcludedUnits.has(unitId)) {
                waterExcludedUnits.delete(unitId);
            } else {
                waterExcludedUnits.add(unitId);
            }

            const excludedArray = Array.from(waterExcludedUnits);
            document.getElementById('excluded_units').value = JSON.stringify(excludedArray);

            const occupiedUnits = UNITS.filter(u => !u.is_vacant);
            const selectedCount = occupiedUnits.length - waterExcludedUnits.size;
            const displayElement = document.getElementById('selectedCountDisplay');
            if (displayElement) {
                displayElement.textContent = selectedCount;
            }

            const card = document.querySelector(`.water-unit-card[data-unit-id="${unitId}"]`);
            const checkbox = card.querySelector('input[type="checkbox"]');
            const isIncluded = !waterExcludedUnits.has(unitId);

            checkbox.checked = isIncluded;
            card.style.background = isIncluded ? 'white' : '#f8fafc';
            card.style.borderColor = isIncluded ? '#0891b2' : '#cbd5e1';
        }

        function loadPreviousReadings() {
            const monthInput = document.getElementById('billing_month');
            const floorId = document.getElementById('electric_floor_id').value;

            if (!monthInput.value || !floorId) {
                alert('ì •ì‚°ì›”ê³¼ ì¸µì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            fetch(`/get_previous_readings/${floorId}/${monthInput.value}`)
                .then(r => r.json())
                .then(j => {
                    if (!j.success) {
                        alert(j.message || 'ì´ì „ ì •ì‚° ê²€ì¹¨ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const readings = j.readings || {};
                    Object.entries(readings).forEach(([unitId, value]) => {
                        const input = document.querySelector(`.reading-prev[data-unit="${unitId}"]`);
                        if (input) {
                            input.value = value;
                            input.dispatchEvent(new Event('input'));
                        }
                    });

                    alert('ì´ì „ ì •ì‚°ì˜ í˜„ì›” ê²€ì¹¨ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                })
                .catch(() => alert('í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('electric_floor_id').addEventListener('change', (e) => {
            const id = e.target.value;
            if (id) {
                renderUnitsInfoCards(id);
                renderReadingTable(id);
            } else {
                document.getElementById('unitsInfoCardContainer').innerHTML = '';
                const wrap = document.getElementById('readingTableWrap');
                if (wrap) wrap.innerHTML = '';
            }
        });

        document.getElementById('tv_mode').addEventListener('change', updateTvFeeInputs);

        // ì „ê¸°ìš”ê¸ˆ í¼ ì œì¶œ
        document.getElementById('electricForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const rows = document.querySelectorAll('#monthlyBillsContainer .month-bill-row');
            if (rows.length === 0) {
                alert('ì›”ë³„ ê³ ì§€ ë‚´ì—­ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            const floorId = document.getElementById('electric_floor_id').value;
            if (!floorId) {
                alert('ì¸µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const invalidInputs = document.querySelectorAll('.reading-curr[data-invalid="true"]');
            if (invalidInputs.length > 0) {
                alert('âš ï¸ ì‚¬ìš©ëŸ‰ì´ ìŒìˆ˜ì¸ ì„¸ëŒ€ê°€ ìˆìŠµë‹ˆë‹¤.\n\ní˜„ì›” ê²€ì¹¨ê°’ì´ ì „ì›” ê²€ì¹¨ê°’ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.\nê²€ì¹¨ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            const fd = new FormData(e.target);

            try {
                const res = await fetch('/calculate/electric', {method: 'POST', body: fd});
                const j = await res.json();

                if (j.already_exists) {
                    if (confirm('ì´ë¯¸ í•´ë‹¹ ì •ì‚°ì›”/ì¸µì— ëŒ€í•œ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\nê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ë®ì–´ì“¸ê¹Œìš”?')) {
                        fd.set('overwrite', 'true');
                        const res2 = await fetch('/calculate/electric', {method: 'POST', body: fd});
                        const j2 = await res2.json();
                        alert(j2.message || (j2.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                        if (j2.success) location.reload();
                    }
                } else {
                    alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    if (j.success) location.reload();
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ìˆ˜ë„ìš”ê¸ˆ í¼ ì œì¶œ
        document.getElementById('waterForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fd = new FormData(e.target);
            const overwriteCheckbox = e.target.querySelector('input[name="overwrite"]');
            fd.set('overwrite', overwriteCheckbox && overwriteCheckbox.checked ? 'true' : 'false');

            try {
                const res = await fetch('/calculate/water', {method: 'POST', body: fd});
                const j = await res.json();

                if (j.already_exists) {
                    if (confirm('ì´ë¯¸ í•´ë‹¹ ì •ì‚°ì›”ì— ëŒ€í•œ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\nê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ë®ì–´ì“¸ê¹Œìš”?')) {
                        fd.set('overwrite', 'true');
                        const res2 = await fetch('/calculate/water', {method: 'POST', body: fd});
                        const j2 = await res2.json();
                        alert(j2.message || (j2.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                        if (j2.success) location.reload();
                    }
                } else {
                    alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                    if (j.success) location.reload();
                }
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ê³µë™ ê³µê³¼ê¸ˆ í¼ ì œì¶œ
        document.getElementById('commonForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            e.target.querySelectorAll('input[type="number"]').forEach(input => {
                if (!input.value || input.value.trim() === '') {
                    input.value = '0';
                }
            });

            const fd = new FormData(e.target);

            try {
                const res = await fetch('/calculate/common', {method: 'POST', body: fd});
                const j = await res.json();
                alert(j.message || (j.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'));
                if (j.success) location.reload();
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // ì´ˆê¸°í™”
        renderFloorOptions();
        addMonthBillRow();
        renderWaterUnitsSelection();
    </script>
{% endblock %}