{% extends "base.html" %}
{% block title %}ì „ê¸°ìš”ê¸ˆ ìƒì„¸ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
    <h1><span class="emoji">âš¡</span> ì „ê¸°ìš”ê¸ˆ ìƒì„¸ ë‚´ì—­</h1>

<div style="display:flex; justify-content:space-between; margin-bottom:20px;">
  <div>
    <h2>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }} - {{ bill.floor_ref.name if bill.floor_ref else '' }}</h2>
    <p style="color:#64748b;">
      ì •ì‚° ê°œì›”ìˆ˜: <strong style="color:#667eea;">{{ bill.billing_months_count|default(1) }}ê°œì›”</strong> |
      TV ë°°ë¶„: {% if bill.tv_distribution_mode == 'EQUAL' %}ê· ë“± ë¶„ë°°{% else %}ê°œë³„ ë¶€ê³¼{% endif %}
    </p>
  </div>
  <a href="{{ url_for('view_bills') }}" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
</div>

<!-- ì›”ë³„ ê³ ì§€ ë‚´ì—­ -->
{% if bill.monthly_details and bill.billing_months_count > 1 %}
<div style="background:#e0e7ff; padding:20px; border-radius:12px; margin-bottom:30px; border-left:4px solid #667eea;">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
    <h3 style="margin:0;color:#4338ca;">ğŸ“‹ í¬í•¨ëœ ê³ ì§€ì›” ìƒì„¸</h3>
    <span class="badge badge-primary" style="font-size:14px;">{{ bill.billing_months_count }}ê°œì›” ë¬¶ìŒ ì •ì‚°</span>
  </div>
  <table style="background:white;">
    <thead>
      <tr>
        <th>ê³ ì§€ì›”</th>
        <th>ì „ê¸°ìš”ê¸ˆ</th>
        <th>ë³µì§€í• ì¸</th>
        <th>ë°”ìš°ì²˜í• ì¸</th>
        <th>TVìˆ˜ì‹ ë£Œ</th>
      </tr>
    </thead>
    <tbody>
      {% for detail in bill.monthly_details %}
      <tr>
        <td><strong>{{ detail.month if detail.month else '-' }}</strong></td>
        <td style="text-align:right">{{ "{:,.0f}".format(detail.amount|default(0)) }}ì›</td>
        <td style="text-align:right;color:#059669;">
          {% if detail.welfare|default(0) > 0 %}-{{ "{:,.0f}".format(detail.welfare) }}ì›{% else %}-{% endif %}
        </td>
        <td style="text-align:right;color:#059669;">
          {% if detail.voucher|default(0) > 0 %}-{{ "{:,.0f}".format(detail.voucher) }}ì›{% else %}-{% endif %}
        </td>
        <td style="text-align:right;color:#dc2626;">
          {% if detail.tv_fee|default(0) > 0 %}+{{ "{:,.0f}".format(detail.tv_fee) }}ì›{% else %}-{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr style="background:#f3f4f6;font-weight:bold;">
        <td>í•©ê³„</td>
        <td style="text-align:right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
        <td style="text-align:right;color:#059669;">
          {% if bill.welfare_discount|default(0) > 0 %}-{{ "{:,.0f}".format(bill.welfare_discount) }}ì›{% else %}-{% endif %}
        </td>
        <td style="text-align:right;color:#059669;">
          {% if bill.voucher_discount|default(0) > 0 %}-{{ "{:,.0f}".format(bill.voucher_discount) }}ì›{% else %}-{% endif %}
        </td>
        <td style="text-align:right;color:#dc2626;">
          {% if bill.tv_fee_total|default(0) > 0 %}+{{ "{:,.0f}".format(bill.tv_fee_total) }}ì›{% else %}-{% endif %}
        </td>
      </tr>
    </tfoot>
  </table>
</div>
{% endif %}

<div class="grid grid-2" style="margin-bottom:30px;">
  <div style="background:#f8fafc; padding:20px; border-radius:12px;">
    <h3>ì²­êµ¬ ì •ë³´</h3>
    <table style="width:100%;">
      <tr><td>ì „ê¸°ìš”ê¸ˆ ì´ì•¡:</td><td style="text-align:right"><strong>{{ "{:,.0f}".format(bill.total_amount) }}ì›</strong></td></tr>
      <tr><td>ë³µì§€ í• ì¸ ì´ì•¡:</td><td style="text-align:right;color:#059669;">-{{ "{:,.0f}".format(bill.welfare_discount|default(0)) }}ì›</td></tr>
      <tr><td>ë°”ìš°ì²˜ í• ì¸ ì´ì•¡:</td><td style="text-align:right;color:#059669;">-{{ "{:,.0f}".format(bill.voucher_discount|default(0)) }}ì›</td></tr>
      <tr><td>TV ìˆ˜ì‹ ë£Œ ì´ì•¡:</td><td style="text-align:right;color:#dc2626;">+{{ "{:,.0f}".format(bill.tv_fee_total|default(0)) }}ì›</td></tr>
    </table>
  </div>
  <div style="background:#f8fafc; padding:20px; border-radius:12px;">
    <h3>ì •ì‚° ìš”ì•½</h3>
    <table style="width:100%;">
      <tr><td>ì •ì‚° ì„¸ëŒ€ìˆ˜:</td><td style="text-align:right"><strong>{{ details|length }}ì„¸ëŒ€</strong></td></tr>
      <tr><td>ì´ ì‚¬ìš©ëŸ‰:</td><td style="text-align:right">{{ "{:,.2f}".format(details|sum(attribute='usage_amount')) }}</td></tr>
      <tr><td>ì„¸ëŒ€ë³„ í‰ê· :</td><td style="text-align:right">{{ "{:,.0f}".format((details|sum(attribute='charged_amount')) / (details|length) if details else 0) }}ì›</td></tr>
      <tr><td>ìµœì¢… ì²­êµ¬ ì´ì•¡:</td><td style="text-align:right"><strong>{{ "{:,.0f}".format(details|sum(attribute='charged_amount')) }}ì›</strong></td></tr>
    </table>
  </div>
</div>

<h3>ì„¸ëŒ€ë³„ ìƒì„¸ ë‚´ì—­</h3>
<table>
  <thead>
    <tr style="background:#e2e8f0;">
      <th>ì„¸ëŒ€</th>
      <th>ì „ì›” ê²€ì¹¨</th>
      <th>í˜„ì›” ê²€ì¹¨</th>
      <th>ì‚¬ìš©ëŸ‰</th>
      <th>ê¸°ë³¸ ë°°ë¶„ì•¡</th>
      <th>ë³µì§€ í• ì¸</th>
      <th>ë°”ìš°ì²˜ í• ì¸</th>
      <th>TV ìˆ˜ì‹ ë£Œ</th>
      <th>ìµœì¢… ê¸ˆì•¡</th>
      <th style="background:#fef3c7;">ì²­êµ¬ ê¸ˆì•¡<br>(10ì› ë‹¨ìœ„)</th>
    </tr>
  </thead>
  <tbody>
    {% for detail in details %}
    {% set reading = readings_map.get(detail.unit_id) %}
    <tr>
      <td><strong>{{ detail.unit.unit_name }}</strong></td>
      <td style="text-align:right">{{ "{:,.2f}".format(reading.previous_reading if reading else 0) }}</td>
      <td style="text-align:right">{{ "{:,.2f}".format(reading.current_reading if reading else 0) }}</td>
      <td style="text-align:right; font-weight:bold;">{{ "{:,.2f}".format(detail.usage_amount) }}</td>
      <td style="text-align:right">{{ "{:,.0f}".format(detail.base_amount) }}ì›</td>
      <td style="text-align:right; color:#059669;">
        {% if detail.welfare_discount > 0 %}-{{ "{:,.0f}".format(detail.welfare_discount) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right; color:#059669;">
        {% if detail.voucher_discount > 0 %}-{{ "{:,.0f}".format(detail.voucher_discount) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right; color:#dc2626;">
        {% if detail.tv_fee > 0 %}+{{ "{:,.0f}".format(detail.tv_fee) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right">{{ "{:,.0f}".format(detail.final_amount) }}ì›</td>
      <td style="text-align:right; background:#fef3c7; font-weight:bold; font-size:1.1em;">
        {{ "{:,.0f}".format(detail.charged_amount) }}ì›
      </td>
    </tr>
    {% endfor %}
  </tbody>
  <tfoot>
    <tr style="background:#e2e8f0; font-weight:bold;">
      <td>í•©ê³„</td>
      <td colspan="2"></td>
      <td style="text-align:right">{{ "{:,.2f}".format(details|sum(attribute='usage_amount')) }}</td>
      <td style="text-align:right">{{ "{:,.0f}".format(details|sum(attribute='base_amount')) }}ì›</td>
      <td style="text-align:right; color:#059669;">
        {% set total_welfare = details|sum(attribute='welfare_discount') %}
        {% if total_welfare > 0 %}-{{ "{:,.0f}".format(total_welfare) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right; color:#059669;">
        {% set total_voucher = details|sum(attribute='voucher_discount') %}
        {% if total_voucher > 0 %}-{{ "{:,.0f}".format(total_voucher) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right; color:#dc2626;">
        {% set total_tv = details|sum(attribute='tv_fee') %}
        {% if total_tv > 0 %}+{{ "{:,.0f}".format(total_tv) }}ì›{% else %}-{% endif %}
      </td>
      <td style="text-align:right">{{ "{:,.0f}".format(details|sum(attribute='final_amount')) }}ì›</td>
      <td style="text-align:right; background:#fbbf24; font-size:1.2em;">
        {{ "{:,.0f}".format(details|sum(attribute='charged_amount')) }}ì›
      </td>
    </tr>
  </tfoot>
</table>

<div style="margin-top:30px; padding:20px; background:#dbeafe; border-radius:12px;">
  <p style="color:#1e40af;">
    ğŸ’¡ <strong>ê³„ì‚° ë°©ì‹ ì•ˆë‚´</strong><br>
    â€¢ ê¸°ë³¸ ë°°ë¶„ì•¡ = (ì„¸ëŒ€ ì‚¬ìš©ëŸ‰ Ã· ì´ ì‚¬ìš©ëŸ‰) Ã— (ê³ ì§€ì•¡ + ë³µì§€í• ì¸ + ë°”ìš°ì²˜í• ì¸)<br>
    â€¢ ìµœì¢… ê¸ˆì•¡ = ê¸°ë³¸ ë°°ë¶„ì•¡ - ì„¸ëŒ€ë³„ ë³µì§€í• ì¸ - ì„¸ëŒ€ë³„ ë°”ìš°ì²˜í• ì¸ + TVìˆ˜ì‹ ë£Œ<br>
    â€¢ ì²­êµ¬ ê¸ˆì•¡ = ìµœì¢… ê¸ˆì•¡ì„ 10ì› ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ ì²˜ë¦¬<br>
    {% if bill.tv_distribution_mode == 'EQUAL' %}
    â€¢ TV ìˆ˜ì‹ ë£Œ: ì´ TVìˆ˜ì‹ ë£Œ({{ "{:,.0f}".format(bill.tv_fee_total|default(0)) }}ì›)ë¥¼ ì¬ì‹¤ ì„¸ëŒ€({{ details|length }}ì„¸ëŒ€)ê°€ ê· ë“± ë¶„ë‹´
    {% else %}
    â€¢ TV ìˆ˜ì‹ ë£Œ: TV ë³´ìœ  ì„¸ëŒ€ë§Œ ì„¤ì • ë‹¨ê°€ Ã— {{ bill.billing_months_count|default(1) }}ê°œì›” ë¶€ê³¼
    {% endif %}
    <br><br>
    <strong style="color:#7c3aed;">âœ¨ Nê°œì›” ë¬¶ìŒ ì •ì‚°:</strong> ìœ„ ê¸ˆì•¡ì€ {{ bill.billing_months_count|default(1) }}ê°œì›”ë¶„ ê³ ì§€ë¥¼ í•©ì‚°í•˜ì—¬ í•œ ë²ˆì— ì •ì‚°í•œ ê¸ˆì•¡ì…ë‹ˆë‹¤.
  </p>
</div>

{% endblock %}