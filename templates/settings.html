{% extends "base.html" %}
{% block title %}ì„¤ì • - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
<h1>âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h1>

<div class="tabs">
  <button class="tab active" onclick="showTab('floors-tab', event)">ì¸µ/ì„¸ëŒ€ ê´€ë¦¬</button>
  <button class="tab" onclick="showTab('settings-tab', event)">ìš”ê¸ˆ ì„¤ì •</button>
  <button class="tab" onclick="showTab('import-export-tab', event)">ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°</button>
</div>

<!-- ì¸µ/ì„¸ëŒ€ ê´€ë¦¬ -->
<div id="floors-tab" class="tab-content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h2>ì¸µ ë° ì„¸ëŒ€ ê´€ë¦¬</h2>
    <button class="btn btn-primary" data-open-modal="addFloorModal">+ ì¸µ ì¶”ê°€</button>
  </div>

  {% for floor in floors %}
  <div style="background:#f8fafc;padding:20px;border-radius:12px;margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
      <h3>
        {% set label = ('B' ~ (0 - floor.floor_number) ~ 'ì¸µ') if floor.floor_number < 0 else (floor.floor_number ~ 'ì¸µ') %}
        {{ label }}{% if floor.name %} ({{ floor.name }}){% endif %}
      </h3>
      <div>
        <button class="btn btn-secondary" data-open-add-unit data-floor-id="{{ floor.id }}">+ ì„¸ëŒ€ ì¶”ê°€</button>
        <button class="btn" data-open-rename-floor data-floor-id="{{ floor.id }}" data-floor-number="{{ floor.floor_number }}" data-floor-name="{{ floor.name|default('') }}">ì´ë¦„ ìˆ˜ì •</button>
        <button class="btn btn-danger" data-delete-floor data-floor-id="{{ floor.id }}">ì¸µ ì‚­ì œ</button>
      </div>
    </div>

    {% if floor.units %}
    <table>
      <thead>
      <tr>
        <th>ì„¸ëŒ€ëª…</th><th>ê±°ì£¼ì¸ì›</th><th>ì „ê¸°ë³µì§€</th><th>ì „ê¸°ë°”ìš°ì²˜</th><th>TVë³´ìœ </th><th>ìˆ˜ë„ë³µì§€</th><th>ê³µì‹¤</th><th>ë¹„ê³ </th><th>ì‘ì—…</th>
      </tr>
      </thead>
      <tbody>
      {% for unit in floor.units %}
      <tr>
        <td><strong>{{ unit.unit_name }}</strong></td>
        <td>{{ unit.residents_count }}ëª…</td>
        <td>{% if unit.electric_welfare %}<span class="badge badge-success">ì ìš©</span>{% else %}<span class="badge badge-warning">ë¯¸ì ìš©</span>{% endif %}</td>
        <td>{% if unit.electric_voucher %}<span class="badge badge-success">ì ìš©</span>{% else %}<span class="badge badge-warning">ë¯¸ì ìš©</span>{% endif %}</td>
        <td>{% if unit.has_tv %}<span class="badge badge-primary">ë³´ìœ </span>{% else %}<span class="badge badge-warning">ë¯¸ë³´ìœ </span>{% endif %}</td>
        <td>{% if unit.water_welfare %}<span class="badge badge-success">ì ìš©</span>{% else %}<span class="badge badge-warning">ë¯¸ì ìš©</span>{% endif %}</td>
        <td>{% if unit.is_vacant %}<span class="badge badge-danger">ê³µì‹¤</span>{% else %}<span class="badge badge-success">ì¬ì‹¤</span>{% endif %}</td>
        <td>{{ unit.memo or '-' }}</td>
        <td>
          <button class="btn btn-secondary" style="padding:5px 10px;"
            data-edit-unit
            data-unit-id="{{ unit.id }}"
            data-unit='{{ {
              "unit_name": unit.unit_name,
              "residents_count": unit.residents_count or 0,
              "electric_welfare": unit.electric_welfare,
              "electric_voucher": unit.electric_voucher,
              "has_tv": unit.has_tv,
              "water_welfare": unit.water_welfare,
              "is_vacant": unit.is_vacant,
              "memo": unit.memo or ""
            } | tojson | e }}'
          >ìˆ˜ì •</button>
          <button class="btn btn-danger" style="padding:5px 10px;" data-delete-unit data-unit-id="{{ unit.id }}">ì‚­ì œ</button>
        </td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p style="color:#94a3b8;text-align:center;padding:20px;">ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤. ì„¸ëŒ€ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
    {% endif %}
  </div>
  {% endfor %}

  {% if not floors %}
  <div style="text-align:center;padding:40px;color:#94a3b8;">
    <p>ë“±ë¡ëœ ì¸µì´ ì—†ìŠµë‹ˆë‹¤.</p>
    <button class="btn btn-primary" style="margin-top:20px;" data-open-modal="addFloorModal">ì²« ì¸µ ì¶”ê°€í•˜ê¸°</button>
  </div>
  {% endif %}
</div>

<!-- ìš”ê¸ˆ ì„¤ì • -->
<div id="settings-tab" class="tab-content" style="display:none;">
  <h2>ìš”ê¸ˆ ì„¤ì •</h2>
  <form action="{{ url_for('save_settings') }}" method="POST">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    <div class="grid grid-2">
      <div class="form-group">
        <label>TV ìˆ˜ì‹ ë£Œ (ì„¸ëŒ€ë‹¹)</label>
        <input type="number" name="tv_fee" value="{{ tv_fee }}" required>
        <small style="color:#94a3b8;">ê¸°ë³¸ê°’: 2,500ì›</small>
      </div>
      <div class="form-group">
        <label>ì „ê¸° ë³µì§€ í• ì¸ ê¸ˆì•¡</label>
        <input type="number" name="electric_welfare_amount" value="{{ electric_welfare_amount }}" required>
        <small style="color:#94a3b8;">ê¸°ë³¸ê°’: 0ì›</small>
      </div>
      <div class="form-group">
        <label>ì „ê¸° ë°”ìš°ì²˜ í• ì¸ ê¸ˆì•¡</label>
        <input type="number" name="electric_voucher_amount" value="{{ electric_voucher_amount }}" required>
        <small style="color:#94a3b8;">ê¸°ë³¸ê°’: 0ì›</small>
      </div>
      <div class="form-group">
        <label>ìˆ˜ë„ ë³µì§€ í• ì¸ ê¸ˆì•¡</label>
        <input type="number" name="water_welfare_amount" value="{{ water_welfare_amount }}" required>
        <small style="color:#94a3b8;">ê¸°ë³¸ê°’: 0ì›</small>
      </div>
    </div>
    <button type="submit" class="btn btn-primary">ì„¤ì • ì €ì¥</button>
  </form>
</div>

<!-- ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸° -->
<div id="import-export-tab" class="tab-content" style="display:none;">
  <h2>ë°ì´í„° ê°€ì ¸ì˜¤ê¸°/ë‚´ë³´ë‚´ê¸°</h2>
  <div class="grid grid-2">
    <div style="background:#f8fafc;padding:20px;border-radius:12px;">
      <h3>ğŸ“¤ ë‚´ë³´ë‚´ê¸°</h3>
      <p style="color:#64748b;margin:15px 0;">í˜„ì¬ ì¸µ/ì„¸ëŒ€ ì„¤ì •ì„ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤.</p>
      <button class="btn btn-primary" id="exportBtn">ì„¤ì • ë‚´ë³´ë‚´ê¸°</button>
    </div>
    <div style="background:#f8fafc;padding:20px;border-radius:12px;">
      <h3>ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</h3>
      <p style="color:#64748b;margin:15px 0;">JSON íŒŒì¼ì—ì„œ ì¸µ/ì„¸ëŒ€ ì„¤ì •ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
      <input type="file" id="importFile" accept=".json" style="margin-bottom:15px;">
      <button class="btn btn-success" id="importBtn">ì„¤ì • ê°€ì ¸ì˜¤ê¸°</button>
    </div>
  </div>
</div>

<!-- ì¸µ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addFloorModal" class="modal">
  <div class="modal-content">
    <h2>ì¸µ ì¶”ê°€</h2>
    <form id="addFloorForm">
      <div class="form-group">
        <label>ì¸µ ë²ˆí˜¸</label>
        <input type="number" name="floor_number" required>
      </div>
      <div class="form-group">
        <label>ì¸µ ì´ë¦„ (ì„ íƒ)</label>
        <input type="text" name="name" placeholder="ì˜ˆ: 1ì¸µ">
      </div>
      <div style="display:flex;gap:10px;">
        <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        <button type="button" class="btn btn-secondary" data-close-modal="addFloorModal">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<!-- ì„¸ëŒ€ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addUnitModal" class="modal">
  <div class="modal-content">
    <h2>ì„¸ëŒ€ ì¶”ê°€</h2>
    <form id="addUnitForm">
      <input type="hidden" name="floor_id" id="unit_floor_id">
      <div class="form-group">
        <label>ì„¸ëŒ€ëª…</label>
        <input type="text" name="unit_name" required>
      </div>
      <div class="form-group">
        <label>ê±°ì£¼ ì¸ì›</label>
        <input type="number" name="residents_count" value="1" min="0" required>
      </div>
      <div class="grid grid-2">
        <div class="checkbox-wrapper"><input type="checkbox" name="electric_welfare" id="electric_welfare"><label for="electric_welfare">ì „ê¸° ë³µì§€ ëŒ€ìƒ</label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="electric_voucher" id="electric_voucher"><label for="electric_voucher">ì „ê¸° ë°”ìš°ì²˜ ëŒ€ìƒ</label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="has_tv" id="has_tv" checked><label for="has_tv">TV ë³´ìœ </label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="water_welfare" id="water_welfare"><label for="water_welfare">ìˆ˜ë„ ë³µì§€ ëŒ€ìƒ</label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="is_vacant" id="is_vacant"><label for="is_vacant">ê³µì‹¤</label></div>
      </div>
      <div class="form-group">
        <label>ë¹„ê³ </label>
        <textarea name="memo" rows="2"></textarea>
      </div>
      <div style="display:flex;gap:10px;">
        <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        <button type="button" class="btn btn-secondary" data-close-modal="addUnitModal">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<!-- ì„¸ëŒ€ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editUnitModal" class="modal">
  <div class="modal-content">
    <h2>ì„¸ëŒ€ ìˆ˜ì •</h2>
    <form id="editUnitForm">
      <input type="hidden" name="unit_id" id="edit_unit_id">
      <div class="form-group">
        <label>ì„¸ëŒ€ëª…</label>
        <input type="text" name="unit_name" id="edit_unit_name" required>
      </div>
      <div class="form-group">
        <label>ê±°ì£¼ ì¸ì›</label>
        <input type="number" name="residents_count" id="edit_residents_count" value="1" min="0" required>
      </div>
      <div class="grid grid-2">
        <div class="checkbox-wrapper"><input type="checkbox" name="electric_welfare" id="edit_electric_welfare"><label for="edit_electric_welfare">ì „ê¸° ë³µì§€ ëŒ€ìƒ</label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="electric_voucher" id="edit_electric_voucher"><label for="edit_electric_voucher">ì „ê¸° ë°”ìš°ì²˜ ëŒ€ìƒ</label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="has_tv" id="edit_has_tv"><label for="edit_has_tv">TV ë³´ìœ </label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="water_welfare" id="edit_water_welfare"><label for="edit_water_welfare">ìˆ˜ë„ ë³µì§€ ëŒ€ìƒ</label></div>
        <div class="checkbox-wrapper"><input type="checkbox" name="is_vacant" id="edit_is_vacant"><label for="edit_is_vacant">ê³µì‹¤</label></div>
      </div>
      <div class="form-group">
        <label>ë¹„ê³ </label>
        <textarea name="memo" id="edit_memo" rows="2"></textarea>
      </div>
      <div style="display:flex;gap:10px;">
        <button type="submit" class="btn btn-primary">ìˆ˜ì •</button>
        <button type="button" class="btn btn-secondary" data-close-modal="editUnitModal">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

<!-- ì¸µ ì´ë¦„ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="renameFloorModal" class="modal">
  <div class="modal-content">
    <h2>ì¸µ ì´ë¦„ ìˆ˜ì •</h2>
    <form id="renameFloorForm">
      <input type="hidden" name="floor_id" id="rename_floor_id">
      <div class="form-group">
        <label>ì¸µ ë²ˆí˜¸</label>
        <input type="number" name="floor_number" id="rename_floor_number" required>
      </div>
      <div class="form-group">
        <label>ìƒˆ ì´ë¦„</label>
        <input type="text" name="name" id="rename_floor_name" placeholder="ì˜ˆ: B1ì¸µ" required>
      </div>
      <div style="display:flex;gap:10px;">
        <button type="submit" class="btn btn-primary">ì €ì¥</button>
        <button type="button" class="btn btn-secondary" data-close-modal="renameFloorModal">ì·¨ì†Œ</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function showTab(tabId, ev){
  document.querySelectorAll('.tab-content').forEach(t=>t.style.display='none');
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabId).style.display='block';
  if(ev && ev.target) ev.target.classList.add('active');
}

// Modal helpers
document.addEventListener('click', (e)=>{
  const open = e.target.closest('[data-open-modal]');
  if(open){ openModal(open.getAttribute('data-open-modal')); }

  const close = e.target.closest('[data-close-modal]');
  if(close){ closeModal(close.getAttribute('data-close-modal')); }

  const addUnitBtn = e.target.closest('[data-open-add-unit]');
  if(addUnitBtn){
    document.getElementById('unit_floor_id').value = addUnitBtn.getAttribute('data-floor-id');
    openModal('addUnitModal');
  }

  const renameBtn = e.target.closest('[data-open-rename-floor]');
  if(renameBtn){
    document.getElementById('rename_floor_id').value = renameBtn.getAttribute('data-floor-id');
    document.getElementById('rename_floor_name').value = renameBtn.getAttribute('data-floor-name') || '';
    document.getElementById('rename_floor_number').value = renameBtn.getAttribute('data-floor-number') || '';
    openModal('renameFloorModal');
  }

  const editBtn = e.target.closest('[data-edit-unit]');
  if(editBtn){
    const unitId = editBtn.getAttribute('data-unit-id');
    const data = editBtn.getAttribute('data-unit');
    try{
      const unit = JSON.parse(data);
      document.getElementById('edit_unit_id').value = unitId;
      document.getElementById('edit_unit_name').value = unit.unit_name || '';
      document.getElementById('edit_residents_count').value = unit.residents_count ?? 0;
      document.getElementById('edit_electric_welfare').checked = !!unit.electric_welfare;
      document.getElementById('edit_electric_voucher').checked = !!unit.electric_voucher;
      document.getElementById('edit_has_tv').checked = !!unit.has_tv;
      document.getElementById('edit_water_welfare').checked = !!unit.water_welfare;
      document.getElementById('edit_is_vacant').checked = !!unit.is_vacant;
      document.getElementById('edit_memo').value = unit.memo || '';
      openModal('editUnitModal');
    }catch(err){
      alert('ìˆ˜ì • ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      console.error(err);
    }
  }

  const deleteUnitBtn = e.target.closest('[data-delete-unit]');
  if(deleteUnitBtn){ deleteUnit(deleteUnitBtn.getAttribute('data-unit-id')); }

  const deleteFloorBtn = e.target.closest('[data-delete-floor]');
  if(deleteFloorBtn){ deleteFloor(deleteFloorBtn.getAttribute('data-floor-id')); }
});

// Forms
const addFloorForm = document.getElementById('addFloorForm');
if(addFloorForm){
  addFloorForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target); fd.append('_csrf_token', getCsrfToken());
    const res = await fetch('/floors/add',{method:'POST',body:fd}); const j=await res.json();
    if(j.success) location.reload(); else alert(j.message || 'ì¶”ê°€ ì‹¤íŒ¨');
  });
}

const addUnitForm = document.getElementById('addUnitForm');
if(addUnitForm){
  addUnitForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target); fd.append('_csrf_token', getCsrfToken());
    fd.set('electric_welfare', fd.has('electric_welfare') ? 'true' : 'false');
    fd.set('electric_voucher', fd.has('electric_voucher') ? 'true' : 'false');
    fd.set('has_tv', fd.has('has_tv') ? 'true' : 'false');
    fd.set('water_welfare', fd.has('water_welfare') ? 'true' : 'false');
    fd.set('is_vacant', fd.has('is_vacant') ? 'true' : 'false');
    const res = await fetch('/units/add',{method:'POST',body:fd}); const j=await res.json();
    if(j.success) location.reload(); else alert(j.message || 'ì¶”ê°€ ì‹¤íŒ¨');
  });
}

const editUnitForm = document.getElementById('editUnitForm');
if(editUnitForm){
  editUnitForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('edit_unit_id').value;
    const fd = new FormData(e.target); fd.append('_csrf_token', getCsrfToken());
    fd.set('electric_welfare', fd.has('electric_welfare') ? 'true' : 'false');
    fd.set('electric_voucher', fd.has('electric_voucher') ? 'true' : 'false');
    fd.set('has_tv', fd.has('has_tv') ? 'true' : 'false');
    fd.set('water_welfare', fd.has('water_welfare') ? 'true' : 'false');
    fd.set('is_vacant', fd.has('is_vacant') ? 'true' : 'false');
    const res = await fetch(`/units/${id}/update`, {method:'POST', body:fd}); const j=await res.json();
    if(j.success) location.reload(); else alert(j.message || 'ìˆ˜ì • ì‹¤íŒ¨');
  });
}

const renameFloorForm = document.getElementById('renameFloorForm');
if(renameFloorForm){
  renameFloorForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('rename_floor_id').value;
    const fd = new FormData(e.target); fd.append('_csrf_token', getCsrfToken());
    const res = await fetch(`/floors/${id}/update`, {method:'POST', body: fd}); const j = await res.json();
    if(j.success){ location.reload(); } else { alert(j.message || 'ìˆ˜ì • ì‹¤íŒ¨'); }
  });
}

// Delete helpers
async function deleteUnit(unitId){
  if(!confirm('ì •ë§ ì´ ì„¸ëŒ€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const fd = new FormData(); fd.append('_csrf_token', getCsrfToken());
  const res = await fetch(`/units/${unitId}/delete`, {method:'POST', body:fd}); const j=await res.json();
  if(j.success) location.reload(); else alert(j.message || 'ì‚­ì œ ì‹¤íŒ¨');
}

async function deleteFloor(floorId){
  if(!confirm('ì •ë§ ì´ ì¸µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì„¸ëŒ€ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
  const fd = new FormData(); fd.append('_csrf_token', getCsrfToken());
  const res = await fetch(`/floors/${floorId}/delete`, {method:'POST', body:fd}); const j=await res.json();
  if(j.success) location.reload(); else alert(j.message || 'ì‚­ì œ ì‹¤íŒ¨');
}

// Export / Import
const exportBtn = document.getElementById('exportBtn');
if(exportBtn){
  exportBtn.addEventListener('click', async ()=>{
    const res = await fetch('/settings/export'); const data = await res.json();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`settings_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
}

const importBtn = document.getElementById('importBtn');
if(importBtn){
  importBtn.addEventListener('click', async ()=>{
    const f = document.getElementById('importFile').files[0];
    if(!f){ alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    const text = await f.text();
    try{
      const data = JSON.parse(text);
      if(!confirm('ê¸°ì¡´ ì„¤ì •ì„ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆë¡œìš´ ì„¤ì •ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      data._csrf_token = getCsrfToken();
      const res = await fetch('/settings/import', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
      const j = await res.json();
      if(j.success){ alert('ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.'); location.reload(); } else { alert(j.message || 'ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨'); }
    }catch(e){ alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
  });
}
</script>
{% endblock %}
