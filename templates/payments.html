{% extends "base.html" %}
{% block title %}ë‚©ë¶€ ë‚´ì—­ ê´€ë¦¬ - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}
{% block extra_css %}
    <style>
        .unit-row {
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .unit-row:hover {
            background: var(--gray-50) !important;
            transform: translateX(4px);
        }

        .unit-row.selected {
            background: #e0e7ff !important;
            border-left: 4px solid var(--primary-color);
        }

        .history-month {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            border: 2px solid var(--gray-200);
            transition: var(--transition-fast);
        }

        .history-month:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .balance-positive {
            color: var(--danger-dark);
            font-weight: 700;
        }

        .balance-negative {
            color: var(--success-dark);
            font-weight: 700;
        }

        .balance-zero {
            color: var(--gray-500);
        }

        .payment-record {
            background: var(--gray-50);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-top: var(--space-sm);
            border-left: 3px solid var(--primary-color);
        }

        .summary-card {
            background: var(--primary-gradient);
            color: white;
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
    </style>
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;"><span class="emoji">ğŸ’³</span> ë‚©ë¶€ ë‚´ì—­ ê´€ë¦¬</h1>
        <button class="btn btn-secondary" onclick="validateBalances()" style="padding: 10px 20px;">
            ğŸ” ì”ì•¡ ì •í•©ì„± ê²€ì¦
        </button>
    </div>

    <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
        <p style="margin: 0; font-size: 14px; color: #1e40af;">
            <strong>ğŸ’¡ ì•ˆë‚´:</strong> ì •ì‚°ì„œì— [ì´ì›”] ë¯¸ë‚©ê¸ˆ/ì´ˆê³¼ë‚©ë¶€ í•­ëª©ì´ í¬í•¨ë˜ì–´ë„ ëˆ„ì  ì”ì•¡ì—ëŠ” ì¤‘ë³µ ê³„ì‚°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </div>

    <div class="grid grid-2" style="gap: 20px;">
        <!-- ì¢Œì¸¡: ì„¸ëŒ€ ëª©ë¡ -->
        <div class="content-card">
            <h2 style="margin-bottom: 20px;">ì„¸ëŒ€ ëª©ë¡</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="unitSearch" placeholder="ğŸ” ì„¸ëŒ€ ê²€ìƒ‰..."
                       style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>

            <table id="unitsTable">
                <thead>
                <tr>
                    <th>ì„¸ëŒ€</th>
                    <th class="text-right">ëˆ„ì  ì”ì•¡</th>
                </tr>
                </thead>
                <tbody>
                {% for unit in units %}
                    <tr class="unit-row"
                        onclick="loadUnitHistory({{ unit.id }}, '{{ unit.unit_name }}', '{{ unit.floor.name if unit.floor else '' }}', this)"
                        data-unit-name="{{ unit.unit_name }}">
                        <td>
                            <strong>{{ unit.floor.name if unit.floor else '' }} {{ unit.unit_name }}</strong>
                            {% if unit.memo %}
                                <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ unit.memo }}</div>
                            {% endif %}
                        </td>
                        <td class="text-right balance-cell" id="balance-{{ unit.id }}">
                            <span style="color: #94a3b8;">ë¡œë”©ì¤‘...</span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ìš°ì¸¡: ì„ íƒ ì„¸ëŒ€ì˜ ì •ì‚° ì´ë ¥ -->
        <div class="content-card">
            <div id="historySection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;" id="historyTitle"></h2>
                </div>

                <!-- ìš”ì•½ ì¹´ë“œ -->
                <div class="summary-card" style="margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ì´ ê³ ì§€ì•¡</div>
                            <div style="font-size: 24px; font-weight: bold;" id="summaryBilled">0ì›</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ì´ ì…ê¸ˆì•¡</div>
                            <div style="font-size: 24px; font-weight: bold;" id="summaryPaid">0ì›</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ì”ì•¡</div>
                            <div style="font-size: 28px; font-weight: bold;" id="summaryBalance">0ì›</div>
                        </div>
                    </div>
                </div>

                <!-- ì •ì‚°ì›”ë³„ ì´ë ¥ -->
                <div id="historyList"></div>
            </div>

            <div id="emptyState" style="text-align: center; padding: 80px 20px; color: #94a3b8;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“‹</div>
                <p style="font-size: 16px;">ì„¸ëŒ€ë¥¼ ì„ íƒí•˜ë©´ ì •ì‚° ì´ë ¥ì´ í‘œì‹œë©ë‹ˆë‹¤</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    <!-- ì…ê¸ˆ ë“±ë¡ ëª¨ë‹¬ -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="modalTitle">ì…ê¸ˆ ë“±ë¡</h2>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <input type="hidden" id="modalCombinationId">
                <input type="hidden" id="modalUnitId">

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì…ê¸ˆì¼</label>
                    <input type="date" id="paymentDate" required
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì…ê¸ˆì•¡ (ì›)</label>
                    <input type="number" id="paymentAmount" required min="0"
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ì…ê¸ˆ ë°©ë²•</label>
                    <select id="paymentMethod" required
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="paymentMemo" rows="3"
                              style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì”ì•¡ ê²€ì¦ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="validateModal" class="modal">
        <div class="modal-content"
             style="max-width: 1000px; width: 90%; max-height: 90vh; padding: 0; display: flex; flex-direction: column; overflow: hidden;">
            <!-- í—¤ë” (ê³ ì •) -->
            <div style="padding: 24px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px 16px 0 0; flex-shrink: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 24px; color: white;">ğŸ” ì”ì•¡ ì •í•©ì„± ê²€ì¦ ê²°ê³¼</h2>
                    <button onclick="closeValidateModal()"
                            style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; transition: all 0.2s; line-height: 1;">
                        Ã—
                    </button>
                </div>
                <div id="validateSummary" style="margin-top: 12px; font-size: 14px; opacity: 0.9;"></div>
            </div>

            <!-- ë³¸ë¬¸ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
            <div style="flex: 1; overflow-y: auto; padding: 24px;">
                <div id="validateResults"></div>
            </div>

            <!-- í‘¸í„° (ê³ ì •) -->
            <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0 0 16px 16px; text-align: center; flex-shrink: 0;">
                <div style="font-size: 13px; color: #64748b;">
                    ğŸ’¡ ì½˜ì†”(F12)ì—ì„œ ìƒì„¸ ë°ì´í„°ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        let currentUnitId = null;
        let currentHistory = [];

        function getCsrfToken() {
            return '{{ csrf_token() }}';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ì„¸ëŒ€ì˜ ì”ì•¡ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', async () => {
            const cells = document.querySelectorAll('.balance-cell');

            for (const cell of cells) {
                const unitId = cell.id.split('-')[1];
                try {
                    const res = await fetch(`/payments/balance/${unitId}`);
                    const data = await res.json();

                    if (data.success) {
                        const balance = data.balance;
                        let html = '';
                        let className = '';

                        if (balance > 0) {
                            html = `<span style="color: #dc2626; font-weight: 600;">ë¯¸ë‚© ${balance.toLocaleString()}ì›</span>`;
                        } else if (balance < 0) {
                            html = `<span style="color: #059669; font-weight: 600;">ì´ˆê³¼ ${Math.abs(balance).toLocaleString()}ì›</span>`;
                        } else {
                            html = `<span style="color: #64748b;">ì™„ë‚©</span>`;
                        }

                        cell.innerHTML = html;
                    }
                } catch (error) {
                    console.error(`Error loading balance for unit ${unitId}:`, error);
                    cell.innerHTML = `<span style="color: #dc2626;">ì˜¤ë¥˜</span>`;
                }
            }
        });

        // ì„¸ëŒ€ ê²€ìƒ‰
        document.getElementById('unitSearch').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.unit-row');

            rows.forEach(row => {
                const unitName = row.dataset.unitName.toLowerCase();
                row.style.display = unitName.includes(keyword) ? '' : 'none';
            });
        });

        // ì„¸ëŒ€ ì •ì‚° ì´ë ¥ ë¡œë“œ
        async function loadUnitHistory(unitId, unitName, floorName, eventTarget) {
            currentUnitId = unitId;

            // ì„ íƒëœ í–‰ í‘œì‹œ
            document.querySelectorAll('.unit-row').forEach(row => row.classList.remove('selected'));
            if (eventTarget) {
                eventTarget.classList.add('selected');
            }

            try {
                const res = await fetch(`/payments/unit_history/${unitId}`);
                const data = await res.json();

                if (!data.success) {
                    alert(data.message);
                    return;
                }

                currentHistory = data.history;

                // ì œëª© ì—…ë°ì´íŠ¸
                document.getElementById('historyTitle').textContent = `${floorName} ${unitName} ì •ì‚° ì´ë ¥`;

                // ìš”ì•½ ì •ë³´ ì—…ë°ì´íŠ¸ (ë°±ì—”ë“œì—ì„œ ì´ì›” í•­ëª© ì œì™¸ëœ ê¸ˆì•¡ ì „ë‹¬)
                const totalBilled = currentHistory.reduce((sum, h) => sum + h.billed_amount, 0);
                const totalPaid = currentHistory.reduce((sum, h) => sum + h.paid_amount, 0);
                const totalBalance = totalBilled - totalPaid;

                document.getElementById('summaryBilled').textContent = totalBilled.toLocaleString() + 'ì›';
                document.getElementById('summaryPaid').textContent = totalPaid.toLocaleString() + 'ì›';

                const balanceEl = document.getElementById('summaryBalance');
                balanceEl.textContent = Math.abs(totalBalance).toLocaleString() + 'ì›';
                if (totalBalance > 0) {
                    balanceEl.style.color = '#fca5a5';
                    balanceEl.textContent = 'ë¯¸ë‚© ' + balanceEl.textContent;
                } else if (totalBalance < 0) {
                    balanceEl.style.color = '#86efac';
                    balanceEl.textContent = 'ì´ˆê³¼ ' + balanceEl.textContent;
                } else {
                    balanceEl.style.color = 'white';
                }

                // ì´ë ¥ ë Œë”ë§
                renderHistory();

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('historySection').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('ì •ì‚° ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì´ë ¥ ë Œë”ë§
        function renderHistory() {
            const container = document.getElementById('historyList');

            if (currentHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px 0;">ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = currentHistory.map(history => {
                const balance = history.balance;
                let balanceHtml = '';
                let balanceClass = '';

                if (balance > 0) {
                    balanceHtml = `ë¯¸ë‚© ${balance.toLocaleString()}ì›`;
                    balanceClass = 'balance-positive';
                } else if (balance < 0) {
                    balanceHtml = `ì´ˆê³¼ë‚©ë¶€ ${Math.abs(balance).toLocaleString()}ì›`;
                    balanceClass = 'balance-negative';
                } else {
                    balanceHtml = 'ì™„ë‚©';
                    balanceClass = 'balance-zero';
                }

                const paymentsHtml = history.payments.length > 0
                    ? history.payments.map(p => `
          <div class="payment-record">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                  ${p.payment_amount.toLocaleString()}ì›
                </div>
                <div style="font-size: 13px; color: #64748b;">
                  ğŸ“… ${p.payment_date} | ğŸ’³ ${p.payment_method}
                </div>
                ${p.memo ? `<div style="font-size: 13px; color: #475569; margin-top: 4px;">${p.memo}</div>` : ''}
              </div>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-secondary btn-sm" onclick='editPayment(${JSON.stringify(p)}, ${history.combination_id})'>ìˆ˜ì •</button>
                <button class="btn btn-danger btn-sm" onclick="deletePayment(${p.id})">ì‚­ì œ</button>
              </div>
            </div>
          </div>
        `).join('')
                    : '<p style="color: #94a3b8; font-size: 14px; margin-top: 8px;">ì…ê¸ˆ ë‚´ì—­ ì—†ìŒ</p>';

                return `
      <div class="history-month">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
          <div>
            <h3 style="margin: 0 0 8px 0; color: #1e293b;">${history.invoice_name}</h3>
            <div style="font-size: 14px; color: #64748b;">${history.created_at}</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="showAddPaymentModal(${history.combination_id})">
            + ì…ê¸ˆ ë“±ë¡
          </button>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px;">
          <div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">ê³ ì§€ì•¡</div>
            <div style="font-size: 18px; font-weight: 600; color: #1e293b;">${history.billed_amount.toLocaleString()}ì›</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">ì…ê¸ˆì•¡</div>
            <div style="font-size: 18px; font-weight: 600; color: #667eea;">${history.paid_amount.toLocaleString()}ì›</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">ì”ì•¡</div>
            <div style="font-size: 18px; font-weight: 600;" class="${balanceClass}">${balanceHtml}</div>
          </div>
        </div>

        ${paymentsHtml}
      </div>
    `;
            }).join('');
        }

        // ì…ê¸ˆ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
        function showAddPaymentModal(combinationId) {
            document.getElementById('modalTitle').textContent = 'ì…ê¸ˆ ë“±ë¡';
            document.getElementById('paymentId').value = '';
            document.getElementById('modalCombinationId').value = combinationId;
            document.getElementById('modalUnitId').value = currentUnitId;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = 'ê³„ì¢Œì´ì²´';
            document.getElementById('paymentMemo').value = '';
            document.getElementById('paymentModal').style.display = 'flex';
        }

        // ì…ê¸ˆ ìˆ˜ì •
        function editPayment(payment, combinationId) {
            document.getElementById('modalTitle').textContent = 'ì…ê¸ˆ ìˆ˜ì •';
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('modalCombinationId').value = combinationId;
            document.getElementById('modalUnitId').value = currentUnitId;
            document.getElementById('paymentDate').value = payment.payment_date;
            document.getElementById('paymentAmount').value = payment.payment_amount;
            document.getElementById('paymentMethod').value = payment.payment_method;
            document.getElementById('paymentMemo').value = payment.memo;
            document.getElementById('paymentModal').style.display = 'flex';
        }

        // ì…ê¸ˆ ì‚­ì œ
        async function deletePayment(id) {
            if (!confirm('ì´ ì…ê¸ˆ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const res = await fetch(`/payments/delete/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({_csrf_token: getCsrfToken()})
                });

                const data = await res.json();
                alert(data.message);

                if (data.success) {
                    const titleText = document.getElementById('historyTitle').textContent;
                    const parts = titleText.split(' ');
                    const floorName = parts[0] || '';
                    const name = parts[1] || '';
                    await loadUnitHistory(currentUnitId, name, floorName, null);

                    // ì”ì•¡ ì—…ë°ì´íŠ¸
                    const balanceRes = await fetch(`/payments/balance/${currentUnitId}`);
                    const balanceData = await balanceRes.json();
                    if (balanceData.success) {
                        const cell = document.getElementById(`balance-${currentUnitId}`);
                        const balance = balanceData.balance;
                        if (balance > 0) {
                            cell.innerHTML = `<span style="color: #dc2626; font-weight: 600;">ë¯¸ë‚© ${balance.toLocaleString()}ì›</span>`;
                        } else if (balance < 0) {
                            cell.innerHTML = `<span style="color: #059669; font-weight: 600;">ì´ˆê³¼ ${Math.abs(balance).toLocaleString()}ì›</span>`;
                        } else {
                            cell.innerHTML = `<span style="color: #64748b;">ì™„ë‚©</span>`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        // í¼ ì œì¶œ
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const paymentId = document.getElementById('paymentId').value;
            const data = {
                combination_id: parseInt(document.getElementById('modalCombinationId').value),
                unit_id: parseInt(document.getElementById('modalUnitId').value),
                payment_date: document.getElementById('paymentDate').value,
                payment_amount: parseFloat(document.getElementById('paymentAmount').value),
                payment_method: document.getElementById('paymentMethod').value,
                memo: document.getElementById('paymentMemo').value,
                _csrf_token: getCsrfToken()
            };

            const url = paymentId ? `/payments/update/${paymentId}` : '/payments/add';

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                alert(result.message);

                if (result.success) {
                    closePaymentModal();

                    const titleText = document.getElementById('historyTitle').textContent;
                    const parts = titleText.split(' ');
                    const floorName = parts[0] || '';
                    const name = parts[1] || '';
                    await loadUnitHistory(currentUnitId, name, floorName, null);

                    // ì”ì•¡ ì—…ë°ì´íŠ¸
                    const balanceRes = await fetch(`/payments/balance/${currentUnitId}`);
                    const balanceData = await balanceRes.json();
                    if (balanceData.success) {
                        const cell = document.getElementById(`balance-${currentUnitId}`);
                        const balance = balanceData.balance;
                        if (balance > 0) {
                            cell.innerHTML = `<span style="color: #dc2626; font-weight: 600;">ë¯¸ë‚© ${balance.toLocaleString()}ì›</span>`;
                        } else if (balance < 0) {
                            cell.innerHTML = `<span style="color: #059669; font-weight: 600;">ì´ˆê³¼ ${Math.abs(balance).toLocaleString()}ì›</span>`;
                        } else {
                            cell.innerHTML = `<span style="color: #64748b;">ì™„ë‚©</span>`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('paymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'paymentModal') closePaymentModal();
        });

        // ì”ì•¡ ì •í•©ì„± ê²€ì¦
        async function validateBalances() {
            try {
                // ë¡œë”© í‘œì‹œ
                const modal = document.getElementById('validateModal');
                const resultsDiv = document.getElementById('validateResults');
                const summaryDiv = document.getElementById('validateSummary');

                resultsDiv.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;"><div style="font-size:48px; margin-bottom:16px;">â³</div><div>ì”ì•¡ì„ ê²€ì¦í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div></div>';
                summaryDiv.innerHTML = '';
                modal.style.display = 'flex';

                const res = await fetch('/admin/validate_balances');
                const data = await res.json();

                if (!data.success) {
                    resultsDiv.innerHTML = `<div style="text-align:center; padding:40px; color:#dc2626;"><div style="font-size:48px; margin-bottom:16px;">âŒ</div><div>ê²€ì¦ ì‹¤íŒ¨: ${data.message}</div></div>`;
                    return;
                }

                const report = data.report;

                // í†µê³„ ê³„ì‚°
                let totalUnpaid = 0;
                let totalOverpaid = 0;
                let unpaidCount = 0;
                let overpaidCount = 0;
                let completedCount = 0;

                report.forEach(item => {
                    if (item.balance > 0) {
                        totalUnpaid += item.balance;
                        unpaidCount++;
                    } else if (item.balance < 0) {
                        totalOverpaid += Math.abs(item.balance);
                        overpaidCount++;
                    } else {
                        completedCount++;
                    }
                });

                // ìš”ì•½ ì •ë³´ í‘œì‹œ
                summaryDiv.innerHTML = `
      ì´ ${report.length}ì„¸ëŒ€ |
      âœ… ì™„ë‚© ${completedCount}ì„¸ëŒ€ |
      âš ï¸ ë¯¸ë‚© ${unpaidCount}ì„¸ëŒ€ (${totalUnpaid.toLocaleString()}ì›) |
      ğŸ’° ì´ˆê³¼ë‚©ë¶€ ${overpaidCount}ì„¸ëŒ€ (${totalOverpaid.toLocaleString()}ì›)
    `;

                // ê²°ê³¼ í…Œì´ë¸” ìƒì„±
                let html = '<table style="width:100%; border-collapse:collapse;">';
                html += `
      <thead>
        <tr style="background:#f1f5f9; border-bottom:2px solid #cbd5e1;">
          <th style="padding:12px; text-align:left;">ì„¸ëŒ€</th>
          <th style="padding:12px; text-align:right;">ê³ ì§€ì•¡</th>
          <th style="padding:12px; text-align:right;">ë‚©ë¶€ì•¡</th>
          <th style="padding:12px; text-align:right;">ì”ì•¡</th>
          <th style="padding:12px; text-align:center;">ì •ì‚°ê±´ìˆ˜</th>
          <th style="padding:12px; text-align:center;">ì´ì›”ì°¸ê³ </th>
        </tr>
      </thead>
      <tbody>
    `;

                // ë¯¸ë‚© ë¨¼ì €, ê·¸ ë‹¤ìŒ ì´ˆê³¼ë‚©ë¶€, ë§ˆì§€ë§‰ ì™„ë‚© ìˆœìœ¼ë¡œ ì •ë ¬
                const sortedReport = [...report].sort((a, b) => {
                    if (a.balance > 0 && b.balance <= 0) return -1;
                    if (a.balance <= 0 && b.balance > 0) return 1;
                    if (a.balance < 0 && b.balance >= 0) return -1;
                    if (a.balance >= 0 && b.balance < 0) return 1;
                    return Math.abs(b.balance) - Math.abs(a.balance);
                });

                sortedReport.forEach((item, index) => {
                    let statusIcon = '';
                    let statusText = '';
                    let statusColor = '';
                    let rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';

                    if (item.balance > 0) {
                        statusIcon = 'âš ï¸';
                        statusText = `ë¯¸ë‚© ${item.balance.toLocaleString()}ì›`;
                        statusColor = '#dc2626';
                        rowBg = '#fef2f2';
                    } else if (item.balance < 0) {
                        statusIcon = 'ğŸ’°';
                        statusText = `ì´ˆê³¼ ${Math.abs(item.balance).toLocaleString()}ì›`;
                        statusColor = '#059669';
                        rowBg = '#f0fdf4';
                    } else {
                        statusIcon = 'âœ…';
                        statusText = 'ì™„ë‚©';
                        statusColor = '#64748b';
                    }

                    html += `
        <tr style="background:${rowBg}; border-bottom:1px solid #e2e8f0;">
          <td style="padding:12px;">
            <strong>${item.floor_name} ${item.unit_name}</strong>
          </td>
          <td style="padding:12px; text-align:right; font-family:'Courier New', monospace;">
            ${item.total_billed.toLocaleString()}ì›
          </td>
          <td style="padding:12px; text-align:right; font-family:'Courier New', monospace; color:#667eea;">
            ${item.total_paid.toLocaleString()}ì›
          </td>
          <td style="padding:12px; text-align:right; font-weight:600; color:${statusColor};">
            ${statusIcon} ${statusText}
          </td>
          <td style="padding:12px; text-align:center; color:#64748b;">
            ${item.invoice_count}ê±´
          </td>
          <td style="padding:12px; text-align:center; font-size:12px; color:#92400e;">
            ${item.carryover_total !== 0 ? item.carryover_total.toLocaleString() + 'ì›' : '-'}
          </td>
        </tr>
      `;
                });

                html += '</tbody></table>';

                // ë¬¸ì œ ì„¸ëŒ€ë§Œ ê°•ì¡° í‘œì‹œ ì˜µì…˜
                if (unpaidCount > 0 || overpaidCount > 0) {
                    html += `
        <div style="margin-top:20px; padding:16px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:8px;">
          <strong style="color:#78350f;">ğŸ’¡ ì¡°ì¹˜ í•„ìš”</strong>
          <div style="font-size:14px; color:#92400e; margin-top:8px;">
            ${unpaidCount > 0 ? `â€¢ ${unpaidCount}ê°œ ì„¸ëŒ€ì— ì´ ${totalUnpaid.toLocaleString()}ì›ì˜ ë¯¸ë‚©ê¸ˆì´ ìˆìŠµë‹ˆë‹¤.<br>` : ''}
            ${overpaidCount > 0 ? `â€¢ ${overpaidCount}ê°œ ì„¸ëŒ€ì— ì´ ${totalOverpaid.toLocaleString()}ì›ì˜ ì´ˆê³¼ë‚©ë¶€ê°€ ìˆìŠµë‹ˆë‹¤.` : ''}
          </div>
        </div>
      `;
                } else {
                    html += `
        <div style="margin-top:20px; padding:16px; background:#dcfce7; border-left:4px solid #22c55e; border-radius:8px; text-align:center;">
          <div style="font-size:48px; margin-bottom:8px;">ğŸ‰</div>
          <strong style="color:#166534; font-size:18px;">ëª¨ë“  ì„¸ëŒ€ê°€ ì™„ë‚© ìƒíƒœì…ë‹ˆë‹¤!</strong>
        </div>
      `;
                }

                resultsDiv.innerHTML = html;

                // ì½˜ì†”ì—ë„ ìƒì„¸ ì •ë³´ ì¶œë ¥
                console.log('=== ì”ì•¡ ì •í•©ì„± ê²€ì¦ ê²°ê³¼ ===');
                console.table(report);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('validateResults').innerHTML = `
      <div style="text-align:center; padding:40px; color:#dc2626;">
        <div style="font-size:48px; margin-bottom:16px;">âš ï¸</div>
        <div>ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>
        <div style="font-size:14px; color:#64748b; margin-top:8px;">${error.message}</div>
      </div>
    `;
            }
        }

        function closeValidateModal() {
            document.getElementById('validateModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('validateModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target.id === 'validateModal') {
                        closeValidateModal();
                    }
                });
            }
        });
    </script>
{% endblock %}