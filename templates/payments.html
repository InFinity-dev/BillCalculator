{% extends "base.html" %}
{% block title %}납부 내역 관리 - 공과금 정산 시스템{% endblock %}
{% block extra_css %}
    <style>
        .unit-row {
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .unit-row:hover {
            background: var(--gray-50) !important;
            transform: translateX(4px);
        }

        .unit-row.selected {
            background: #e0e7ff !important;
            border-left: 4px solid var(--primary-color);
        }

        .history-month {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            border: 2px solid var(--gray-200);
            transition: var(--transition-fast);
        }

        .history-month:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .balance-positive {
            color: var(--danger-dark);
            font-weight: 700;
        }

        .balance-negative {
            color: var(--success-dark);
            font-weight: 700;
        }

        .balance-zero {
            color: var(--gray-500);
        }

        .payment-record {
            background: var(--gray-50);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            margin-top: var(--space-sm);
            border-left: 3px solid var(--primary-color);
        }

        .summary-card {
            background: var(--primary-gradient);
            color: white;
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
    </style>
{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;"><span class="emoji">💳</span> 납부 내역 관리</h1>
        <button class="btn btn-secondary" onclick="validateBalances()" style="padding: 10px 20px;">
            🔍 잔액 정합성 검증
        </button>
    </div>

    <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
        <p style="margin: 0; font-size: 14px; color: #1e40af;">
            <strong>💡 안내:</strong> 정산서에 [이월] 미납금/초과납부 항목이 포함되어도 누적 잔액에는 중복 계산되지 않습니다.
        </p>
    </div>

    <div class="grid grid-2" style="gap: 20px;">
        <!-- 좌측: 세대 목록 -->
        <div class="content-card">
            <h2 style="margin-bottom: 20px;">세대 목록</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="unitSearch" placeholder="🔍 세대 검색..."
                       style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;">
            </div>

            <table id="unitsTable">
                <thead>
                <tr>
                    <th>세대</th>
                    <th class="text-right">누적 잔액</th>
                </tr>
                </thead>
                <tbody>
                {% for unit in units %}
                    <tr class="unit-row"
                        onclick="loadUnitHistory({{ unit.id }}, '{{ unit.unit_name }}', '{{ unit.floor.name if unit.floor else '' }}', this)"
                        data-unit-name="{{ unit.unit_name }}">
                        <td>
                            <strong>{{ unit.floor.name if unit.floor else '' }} {{ unit.unit_name }}</strong>
                            {% if unit.memo %}
                                <div style="font-size: 12px; color: #64748b; margin-top: 4px;">{{ unit.memo }}</div>
                            {% endif %}
                        </td>
                        <td class="text-right balance-cell" id="balance-{{ unit.id }}">
                            <span style="color: #94a3b8;">로딩중...</span>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 우측: 선택 세대의 정산 이력 -->
        <div class="content-card">
            <div id="historySection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;" id="historyTitle"></h2>
                </div>

                <!-- 요약 카드 -->
                <div class="summary-card" style="margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">총 고지액</div>
                            <div style="font-size: 24px; font-weight: bold;" id="summaryBilled">0원</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">총 입금액</div>
                            <div style="font-size: 24px; font-weight: bold;" id="summaryPaid">0원</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">잔액</div>
                            <div style="font-size: 28px; font-weight: bold;" id="summaryBalance">0원</div>
                        </div>
                    </div>
                </div>

                <!-- 정산월별 이력 -->
                <div id="historyList"></div>
            </div>

            <div id="emptyState" style="text-align: center; padding: 80px 20px; color: #94a3b8;">
                <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                <p style="font-size: 16px;">세대를 선택하면 정산 이력이 표시됩니다</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    <!-- 입금 등록 모달 -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="modalTitle">입금 등록</h2>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <input type="hidden" id="modalCombinationId">
                <input type="hidden" id="modalUnitId">

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">입금일</label>
                    <input type="date" id="paymentDate" required
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">입금액 (원)</label>
                    <input type="number" id="paymentAmount" required min="0"
                           style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">입금 방법</label>
                    <select id="paymentMethod" required
                            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                        <option value="현금">현금</option>
                        <option value="계좌이체">계좌이체</option>
                        <option value="카드">카드</option>
                        <option value="기타">기타</option>
                    </select>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">메모 (선택)</label>
                    <textarea id="paymentMemo" rows="3"
                              style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">취소</button>
                    <button type="submit" class="btn btn-primary">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 잔액 검증 결과 모달 -->
    <div id="validateModal" class="modal">
        <div class="modal-content"
             style="max-width: 1000px; width: 90%; max-height: 90vh; padding: 0; display: flex; flex-direction: column; overflow: hidden;">
            <!-- 헤더 (고정) -->
            <div style="padding: 24px; border-bottom: 2px solid #e2e8f0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px 16px 0 0; flex-shrink: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 24px; color: white;">🔍 잔액 정합성 검증 결과</h2>
                    <button onclick="closeValidateModal()"
                            style="background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 20px; transition: all 0.2s; line-height: 1;">
                        ×
                    </button>
                </div>
                <div id="validateSummary" style="margin-top: 12px; font-size: 14px; opacity: 0.9;"></div>
            </div>

            <!-- 본문 (스크롤 가능) -->
            <div style="flex: 1; overflow-y: auto; padding: 24px;">
                <div id="validateResults"></div>
            </div>

            <!-- 푸터 (고정) -->
            <div style="padding: 16px 24px; border-top: 1px solid #e2e8f0; background: #f8fafc; border-radius: 0 0 16px 16px; text-align: center; flex-shrink: 0;">
                <div style="font-size: 13px; color: #64748b;">
                    💡 콘솔(F12)에서 상세 데이터를 확인할 수 있습니다.
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        let currentUnitId = null;
        let currentHistory = [];

        function getCsrfToken() {
            return '{{ csrf_token() }}';
        }

        // 페이지 로드 시 모든 세대의 잔액 로드
        window.addEventListener('DOMContentLoaded', async () => {
            const cells = document.querySelectorAll('.balance-cell');

            for (const cell of cells) {
                const unitId = cell.id.split('-')[1];
                try {
                    const res = await fetch(`/payments/balance/${unitId}`);
                    const data = await res.json();

                    if (data.success) {
                        const balance = data.balance;
                        let html = '';
                        let className = '';

                        if (balance > 0) {
                            html = `<span style="color: #dc2626; font-weight: 600;">미납 ${balance.toLocaleString()}원</span>`;
                        } else if (balance < 0) {
                            html = `<span style="color: #059669; font-weight: 600;">초과 ${Math.abs(balance).toLocaleString()}원</span>`;
                        } else {
                            html = `<span style="color: #64748b;">완납</span>`;
                        }

                        cell.innerHTML = html;
                    }
                } catch (error) {
                    console.error(`Error loading balance for unit ${unitId}:`, error);
                    cell.innerHTML = `<span style="color: #dc2626;">오류</span>`;
                }
            }
        });

        // 세대 검색
        document.getElementById('unitSearch').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.unit-row');

            rows.forEach(row => {
                const unitName = row.dataset.unitName.toLowerCase();
                row.style.display = unitName.includes(keyword) ? '' : 'none';
            });
        });

        // 세대 정산 이력 로드
        async function loadUnitHistory(unitId, unitName, floorName, eventTarget) {
            currentUnitId = unitId;

            // 선택된 행 표시
            document.querySelectorAll('.unit-row').forEach(row => row.classList.remove('selected'));
            if (eventTarget) {
                eventTarget.classList.add('selected');
            }

            try {
                const res = await fetch(`/payments/unit_history/${unitId}`);
                const data = await res.json();

                if (!data.success) {
                    alert(data.message);
                    return;
                }

                currentHistory = data.history;

                // 제목 업데이트
                document.getElementById('historyTitle').textContent = `${floorName} ${unitName} 정산 이력`;

                // 요약 정보 업데이트 (백엔드에서 이월 항목 제외된 금액 전달)
                const totalBilled = currentHistory.reduce((sum, h) => sum + h.billed_amount, 0);
                const totalPaid = currentHistory.reduce((sum, h) => sum + h.paid_amount, 0);
                const totalBalance = totalBilled - totalPaid;

                document.getElementById('summaryBilled').textContent = totalBilled.toLocaleString() + '원';
                document.getElementById('summaryPaid').textContent = totalPaid.toLocaleString() + '원';

                const balanceEl = document.getElementById('summaryBalance');
                balanceEl.textContent = Math.abs(totalBalance).toLocaleString() + '원';
                if (totalBalance > 0) {
                    balanceEl.style.color = '#fca5a5';
                    balanceEl.textContent = '미납 ' + balanceEl.textContent;
                } else if (totalBalance < 0) {
                    balanceEl.style.color = '#86efac';
                    balanceEl.textContent = '초과 ' + balanceEl.textContent;
                } else {
                    balanceEl.style.color = 'white';
                }

                // 이력 렌더링
                renderHistory();

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('historySection').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('정산 이력을 불러오는데 실패했습니다.');
            }
        }

        // 이력 렌더링
        function renderHistory() {
            const container = document.getElementById('historyList');

            if (currentHistory.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 40px 0;">정산 내역이 없습니다.</p>';
                return;
            }

            container.innerHTML = currentHistory.map(history => {
                const balance = history.balance;
                let balanceHtml = '';
                let balanceClass = '';

                if (balance > 0) {
                    balanceHtml = `미납 ${balance.toLocaleString()}원`;
                    balanceClass = 'balance-positive';
                } else if (balance < 0) {
                    balanceHtml = `초과납부 ${Math.abs(balance).toLocaleString()}원`;
                    balanceClass = 'balance-negative';
                } else {
                    balanceHtml = '완납';
                    balanceClass = 'balance-zero';
                }

                const paymentsHtml = history.payments.length > 0
                    ? history.payments.map(p => `
          <div class="payment-record">
            <div style="display: flex; justify-content: space-between; align-items: start;">
              <div style="flex: 1;">
                <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                  ${p.payment_amount.toLocaleString()}원
                </div>
                <div style="font-size: 13px; color: #64748b;">
                  📅 ${p.payment_date} | 💳 ${p.payment_method}
                </div>
                ${p.memo ? `<div style="font-size: 13px; color: #475569; margin-top: 4px;">${p.memo}</div>` : ''}
              </div>
              <div style="display: flex; gap: 5px;">
                <button class="btn btn-secondary btn-sm" onclick='editPayment(${JSON.stringify(p)}, ${history.combination_id})'>수정</button>
                <button class="btn btn-danger btn-sm" onclick="deletePayment(${p.id})">삭제</button>
              </div>
            </div>
          </div>
        `).join('')
                    : '<p style="color: #94a3b8; font-size: 14px; margin-top: 8px;">입금 내역 없음</p>';

                return `
      <div class="history-month">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
          <div>
            <h3 style="margin: 0 0 8px 0; color: #1e293b;">${history.invoice_name}</h3>
            <div style="font-size: 14px; color: #64748b;">${history.created_at}</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="showAddPaymentModal(${history.combination_id})">
            + 입금 등록
          </button>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 16px; background: #f8fafc; border-radius: 8px; margin-bottom: 12px;">
          <div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">고지액</div>
            <div style="font-size: 18px; font-weight: 600; color: #1e293b;">${history.billed_amount.toLocaleString()}원</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">입금액</div>
            <div style="font-size: 18px; font-weight: 600; color: #667eea;">${history.paid_amount.toLocaleString()}원</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">잔액</div>
            <div style="font-size: 18px; font-weight: 600;" class="${balanceClass}">${balanceHtml}</div>
          </div>
        </div>

        ${paymentsHtml}
      </div>
    `;
            }).join('');
        }

        // 입금 등록 모달 열기
        function showAddPaymentModal(combinationId) {
            document.getElementById('modalTitle').textContent = '입금 등록';
            document.getElementById('paymentId').value = '';
            document.getElementById('modalCombinationId').value = combinationId;
            document.getElementById('modalUnitId').value = currentUnitId;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentMethod').value = '계좌이체';
            document.getElementById('paymentMemo').value = '';
            document.getElementById('paymentModal').style.display = 'flex';
        }

        // 입금 수정
        function editPayment(payment, combinationId) {
            document.getElementById('modalTitle').textContent = '입금 수정';
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('modalCombinationId').value = combinationId;
            document.getElementById('modalUnitId').value = currentUnitId;
            document.getElementById('paymentDate').value = payment.payment_date;
            document.getElementById('paymentAmount').value = payment.payment_amount;
            document.getElementById('paymentMethod').value = payment.payment_method;
            document.getElementById('paymentMemo').value = payment.memo;
            document.getElementById('paymentModal').style.display = 'flex';
        }

        // 입금 삭제
        async function deletePayment(id) {
            if (!confirm('이 입금 내역을 삭제하시겠습니까?')) return;

            try {
                const res = await fetch(`/payments/delete/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({_csrf_token: getCsrfToken()})
                });

                const data = await res.json();
                alert(data.message);

                if (data.success) {
                    const titleText = document.getElementById('historyTitle').textContent;
                    const parts = titleText.split(' ');
                    const floorName = parts[0] || '';
                    const name = parts[1] || '';
                    await loadUnitHistory(currentUnitId, name, floorName, null);

                    // 잔액 업데이트
                    const balanceRes = await fetch(`/payments/balance/${currentUnitId}`);
                    const balanceData = await balanceRes.json();
                    if (balanceData.success) {
                        const cell = document.getElementById(`balance-${currentUnitId}`);
                        const balance = balanceData.balance;
                        if (balance > 0) {
                            cell.innerHTML = `<span style="color: #dc2626; font-weight: 600;">미납 ${balance.toLocaleString()}원</span>`;
                        } else if (balance < 0) {
                            cell.innerHTML = `<span style="color: #059669; font-weight: 600;">초과 ${Math.abs(balance).toLocaleString()}원</span>`;
                        } else {
                            cell.innerHTML = `<span style="color: #64748b;">완납</span>`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('삭제에 실패했습니다.');
            }
        }

        // 모달 닫기
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        // 폼 제출
        document.getElementById('paymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const paymentId = document.getElementById('paymentId').value;
            const data = {
                combination_id: parseInt(document.getElementById('modalCombinationId').value),
                unit_id: parseInt(document.getElementById('modalUnitId').value),
                payment_date: document.getElementById('paymentDate').value,
                payment_amount: parseFloat(document.getElementById('paymentAmount').value),
                payment_method: document.getElementById('paymentMethod').value,
                memo: document.getElementById('paymentMemo').value,
                _csrf_token: getCsrfToken()
            };

            const url = paymentId ? `/payments/update/${paymentId}` : '/payments/add';

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                alert(result.message);

                if (result.success) {
                    closePaymentModal();

                    const titleText = document.getElementById('historyTitle').textContent;
                    const parts = titleText.split(' ');
                    const floorName = parts[0] || '';
                    const name = parts[1] || '';
                    await loadUnitHistory(currentUnitId, name, floorName, null);

                    // 잔액 업데이트
                    const balanceRes = await fetch(`/payments/balance/${currentUnitId}`);
                    const balanceData = await balanceRes.json();
                    if (balanceData.success) {
                        const cell = document.getElementById(`balance-${currentUnitId}`);
                        const balance = balanceData.balance;
                        if (balance > 0) {
                            cell.innerHTML = `<span style="color: #dc2626; font-weight: 600;">미납 ${balance.toLocaleString()}원</span>`;
                        } else if (balance < 0) {
                            cell.innerHTML = `<span style="color: #059669; font-weight: 600;">초과 ${Math.abs(balance).toLocaleString()}원</span>`;
                        } else {
                            cell.innerHTML = `<span style="color: #64748b;">완납</span>`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('저장에 실패했습니다.');
            }
        });

        // 모달 외부 클릭 시 닫기
        document.getElementById('paymentModal').addEventListener('click', (e) => {
            if (e.target.id === 'paymentModal') closePaymentModal();
        });

        // 잔액 정합성 검증
        async function validateBalances() {
            try {
                // 로딩 표시
                const modal = document.getElementById('validateModal');
                const resultsDiv = document.getElementById('validateResults');
                const summaryDiv = document.getElementById('validateSummary');

                resultsDiv.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;"><div style="font-size:48px; margin-bottom:16px;">⏳</div><div>잔액을 검증하는 중입니다...</div></div>';
                summaryDiv.innerHTML = '';
                modal.style.display = 'flex';

                const res = await fetch('/admin/validate_balances');
                const data = await res.json();

                if (!data.success) {
                    resultsDiv.innerHTML = `<div style="text-align:center; padding:40px; color:#dc2626;"><div style="font-size:48px; margin-bottom:16px;">❌</div><div>검증 실패: ${data.message}</div></div>`;
                    return;
                }

                const report = data.report;

                // 통계 계산
                let totalUnpaid = 0;
                let totalOverpaid = 0;
                let unpaidCount = 0;
                let overpaidCount = 0;
                let completedCount = 0;

                report.forEach(item => {
                    if (item.balance > 0) {
                        totalUnpaid += item.balance;
                        unpaidCount++;
                    } else if (item.balance < 0) {
                        totalOverpaid += Math.abs(item.balance);
                        overpaidCount++;
                    } else {
                        completedCount++;
                    }
                });

                // 요약 정보 표시
                summaryDiv.innerHTML = `
      총 ${report.length}세대 |
      ✅ 완납 ${completedCount}세대 |
      ⚠️ 미납 ${unpaidCount}세대 (${totalUnpaid.toLocaleString()}원) |
      💰 초과납부 ${overpaidCount}세대 (${totalOverpaid.toLocaleString()}원)
    `;

                // 결과 테이블 생성
                let html = '<table style="width:100%; border-collapse:collapse;">';
                html += `
      <thead>
        <tr style="background:#f1f5f9; border-bottom:2px solid #cbd5e1;">
          <th style="padding:12px; text-align:left;">세대</th>
          <th style="padding:12px; text-align:right;">고지액</th>
          <th style="padding:12px; text-align:right;">납부액</th>
          <th style="padding:12px; text-align:right;">잔액</th>
          <th style="padding:12px; text-align:center;">정산건수</th>
          <th style="padding:12px; text-align:center;">이월참고</th>
        </tr>
      </thead>
      <tbody>
    `;

                // 미납 먼저, 그 다음 초과납부, 마지막 완납 순으로 정렬
                const sortedReport = [...report].sort((a, b) => {
                    if (a.balance > 0 && b.balance <= 0) return -1;
                    if (a.balance <= 0 && b.balance > 0) return 1;
                    if (a.balance < 0 && b.balance >= 0) return -1;
                    if (a.balance >= 0 && b.balance < 0) return 1;
                    return Math.abs(b.balance) - Math.abs(a.balance);
                });

                sortedReport.forEach((item, index) => {
                    let statusIcon = '';
                    let statusText = '';
                    let statusColor = '';
                    let rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';

                    if (item.balance > 0) {
                        statusIcon = '⚠️';
                        statusText = `미납 ${item.balance.toLocaleString()}원`;
                        statusColor = '#dc2626';
                        rowBg = '#fef2f2';
                    } else if (item.balance < 0) {
                        statusIcon = '💰';
                        statusText = `초과 ${Math.abs(item.balance).toLocaleString()}원`;
                        statusColor = '#059669';
                        rowBg = '#f0fdf4';
                    } else {
                        statusIcon = '✅';
                        statusText = '완납';
                        statusColor = '#64748b';
                    }

                    html += `
        <tr style="background:${rowBg}; border-bottom:1px solid #e2e8f0;">
          <td style="padding:12px;">
            <strong>${item.floor_name} ${item.unit_name}</strong>
          </td>
          <td style="padding:12px; text-align:right; font-family:'Courier New', monospace;">
            ${item.total_billed.toLocaleString()}원
          </td>
          <td style="padding:12px; text-align:right; font-family:'Courier New', monospace; color:#667eea;">
            ${item.total_paid.toLocaleString()}원
          </td>
          <td style="padding:12px; text-align:right; font-weight:600; color:${statusColor};">
            ${statusIcon} ${statusText}
          </td>
          <td style="padding:12px; text-align:center; color:#64748b;">
            ${item.invoice_count}건
          </td>
          <td style="padding:12px; text-align:center; font-size:12px; color:#92400e;">
            ${item.carryover_total !== 0 ? item.carryover_total.toLocaleString() + '원' : '-'}
          </td>
        </tr>
      `;
                });

                html += '</tbody></table>';

                // 문제 세대만 강조 표시 옵션
                if (unpaidCount > 0 || overpaidCount > 0) {
                    html += `
        <div style="margin-top:20px; padding:16px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:8px;">
          <strong style="color:#78350f;">💡 조치 필요</strong>
          <div style="font-size:14px; color:#92400e; margin-top:8px;">
            ${unpaidCount > 0 ? `• ${unpaidCount}개 세대에 총 ${totalUnpaid.toLocaleString()}원의 미납금이 있습니다.<br>` : ''}
            ${overpaidCount > 0 ? `• ${overpaidCount}개 세대에 총 ${totalOverpaid.toLocaleString()}원의 초과납부가 있습니다.` : ''}
          </div>
        </div>
      `;
                } else {
                    html += `
        <div style="margin-top:20px; padding:16px; background:#dcfce7; border-left:4px solid #22c55e; border-radius:8px; text-align:center;">
          <div style="font-size:48px; margin-bottom:8px;">🎉</div>
          <strong style="color:#166534; font-size:18px;">모든 세대가 완납 상태입니다!</strong>
        </div>
      `;
                }

                resultsDiv.innerHTML = html;

                // 콘솔에도 상세 정보 출력
                console.log('=== 잔액 정합성 검증 결과 ===');
                console.table(report);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('validateResults').innerHTML = `
      <div style="text-align:center; padding:40px; color:#dc2626;">
        <div style="font-size:48px; margin-bottom:16px;">⚠️</div>
        <div>검증 중 오류가 발생했습니다.</div>
        <div style="font-size:14px; color:#64748b; margin-top:8px;">${error.message}</div>
      </div>
    `;
            }
        }

        function closeValidateModal() {
            document.getElementById('validateModal').style.display = 'none';
        }

        // 모달 외부 클릭 시 닫기
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('validateModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target.id === 'validateModal') {
                        closeValidateModal();
                    }
                });
            }
        });
    </script>
{% endblock %}