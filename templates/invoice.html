{% extends "base.html" %}

{% block title %}ì •ì‚° ì¡°í•© - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
<style>
.step-indicator {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 30px 0;
}

.step {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  background: #e2e8f0;
  border-radius: 25px;
  transition: all 0.3s;
}

.step.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

.step.completed {
  background: #10b981;
  color: white;
}

.step-number {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: white;
  color: #334155;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.step.active .step-number,
.step.completed .step-number {
  background: rgba(255,255,255,0.3);
  color: white;
}

.unit-card {
  background: #ffffff;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  transition: all 0.3s ease;
}

.unit-card:hover {
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.unit-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid #f1f5f9;
}

.unit-name {
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
}

.unit-memo-tag {
  font-size: 13px;
  color: #64748b;
  background: #f1f5f9;
  padding: 4px 12px;
  border-radius: 12px;
  font-weight: 500;
  margin-left: 8px;
}

.additional-charge-row {
  display: grid;
  grid-template-columns: 100px 1fr 150px 80px;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: #475569;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.confirm-section {
  background: #f8fafc;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border-left: 4px solid #667eea;
}

.confirm-section h3 {
  color: #334155;
  margin-top: 0;
  margin-bottom: 16px;
  font-size: 16px;
}

.confirm-item {
  background: white;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  border: 1px solid #e2e8f0;
}

.confirm-item-icon {
  font-size: 18px;
}

.confirm-item-text {
  flex: 1;
  font-size: 14px;
  color: #475569;
}

.unit-summary-card {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
}

.unit-summary-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.unit-summary-name {
  font-size: 16px;
  font-weight: 600;
  color: #1e293b;
}

.unit-summary-memo {
  font-size: 12px;
  color: #64748b;
  background: #f8fafc;
  padding: 3px 10px;
  border-radius: 10px;
}

.unit-summary-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  font-size: 13px;
}

.unit-summary-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  color: #64748b;
}

.unit-summary-row strong {
  color: #334155;
}

/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
table th.text-right {
  text-align: right !important;
}

table td.text-right {
  text-align: right !important;
  font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<h1>ğŸ“„ ì •ì‚° ì¡°í•©</h1>

<div class="tabs">
    <button class="tab active" onclick="showTab('create-tab')">â• ìƒˆ ì •ì‚° ìƒì„±</button>
    <button class="tab" onclick="showTab('history-tab')">ğŸ“‹ ì •ì‚° ë‚´ì—­</button>
</div>

<!-- ìƒˆ ì •ì‚° ìƒì„± íƒ­ -->
<div id="create-tab" class="tab-content">
    <div class="step-indicator">
        <div class="step active" id="step1-indicator">
            <div class="step-number">1</div>
            <span>í•­ëª© ì„ íƒ</span>
        </div>
        <div class="step" id="step2-indicator">
            <div class="step-number">2</div>
            <span>ê¸°íƒ€ê¸ˆì•¡/ë©”ëª¨</span>
        </div>
        <div class="step" id="step3-indicator">
            <div class="step-number">3</div>
            <span>ìµœì¢… í™•ì¸</span>
        </div>
    </div>

    <!-- Step 1: í•­ëª© ì„ íƒ -->
    <div id="step1" class="step-content">
        <h2>Step 1: ì²­êµ¬ í•­ëª© ì„ íƒ</h2>

        <div class="form-group">
            <label>ì •ì‚°ì„œ ì´ë¦„</label>
            <input type="text" id="invoiceName" placeholder="ì˜ˆ: 2024ë…„ 3ì›” ì •ì‚°" required>
        </div>

        <div class="form-group">
            <label>ì¶”ê°€ ë©”ëª¨ (ì„ íƒ)</label>
            <textarea id="invoiceMemo" rows="3" placeholder="ê³ ì • ë©”ëª¨ ì™¸ì— ì¶”ê°€ë¡œ ì•ˆë‚´í•  ë‚´ìš©ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            <small style="color:#64748b;">
                ğŸ’¡ ì„¤ì •ì—ì„œ ë“±ë¡í•œ ê³ ì • ë©”ëª¨ê°€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤. ì—¬ê¸°ì— ì…ë ¥í•œ ë‚´ìš©ì€ ê³ ì • ë©”ëª¨ ë’¤ì— ì¶”ê°€ë©ë‹ˆë‹¤.
            </small>
        </div>

        <!-- ì „ê¸°ìš”ê¸ˆ ì„ íƒ -->
        <div style="margin: 30px 0;">
            <h3>âš¡ ì „ê¸°ìš”ê¸ˆ ì„ íƒ</h3>
            {% if electric_bills %}
            <table>
                <thead>
                    <tr>
                        <th width="50">ì„ íƒ</th>
                        <th>ì •ì‚°ì›”</th>
                        <th>í¬í•¨ ê³ ì§€ì›”</th>
                        <th>ì¸µ</th>
                        <th class="text-right">ì´ì•¡</th>
                        <th class="text-right">ë³µì§€í• ì¸</th>
                        <th class="text-right">ë°”ìš°ì²˜í• ì¸</th>
                        <th class="text-right">TVìˆ˜ì‹ ë£Œ</th>
                        <th>ì„¸ëŒ€ìˆ˜</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in electric_bills %}
                    <tr>
                        <td>
                            <input type="checkbox" class="electric-item"
                                   data-id="{{ bill.id }}"
                                   data-month="{{ bill.billing_month }}"
                                   data-desc="{{ bill.billing_month.strftime('%Yë…„ %mì›”') }} {{ bill.floor_ref.name }} ì „ê¸°ìš”ê¸ˆ">
                        </td>
                        <td>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</td>
                        <td style="min-width:200px;">
                            {% if bill.monthly_details %}
                                {% set months = bill.monthly_details | map(attribute='month') | select | list %}
                                {% if months|length > 1 %}
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <span class="badge badge-primary">{{ months|length }}ê°œì›” ë¬¶ìŒ</span>
                                        <span style="font-size:12px;color:#64748b;">
                                            {% for detail in bill.monthly_details %}
                                                {% if detail.month %}
                                                    {{ detail.month[:7] }}{% if not loop.last %}, {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </span>
                                    </div>
                                {% else %}
                                    <span style="color:#64748b;">ë‹¨ì¼ ì›”</span>
                                {% endif %}
                            {% else %}
                                <span style="color:#94a3b8;">-</span>
                            {% endif %}
                        </td>
                        <td>{{ bill.floor_ref.name }}</td>
                        <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
                        <td class="text-right" style="color:#059669;">
                            {% if bill.welfare_discount > 0 %}
                                -{{ "{:,.0f}".format(bill.welfare_discount) }}ì›
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-right" style="color:#059669;">
                            {% if bill.voucher_discount > 0 %}
                                -{{ "{:,.0f}".format(bill.voucher_discount) }}ì›
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-right" style="color:#dc2626;">
                            {% if bill.tv_fee_total > 0 %}
                                +{{ "{:,.0f}".format(bill.tv_fee_total) }}ì›
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ bill.details|length }}ì„¸ëŒ€</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #94a3b8;">ì„ íƒ ê°€ëŠ¥í•œ ì „ê¸°ìš”ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>

        <!-- ìˆ˜ë„ìš”ê¸ˆ ì„ íƒ -->
        <div style="margin: 30px 0;">
            <h3>ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ ì„ íƒ</h3>
            {% if water_bills %}
            <table>
                <thead>
                    <tr>
                        <th width="50">ì„ íƒ</th>
                        <th>ì •ì‚°ì›”</th>
                        <th class="text-right">ì´ì•¡</th>
                        <th class="text-right">ë³µì§€í• ì¸í•©ê³„</th>
                        <th>ì„¸ëŒ€ìˆ˜</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in water_bills %}
                    <tr>
                        <td>
                            <input type="checkbox" class="water-item"
                                   data-id="{{ bill.id }}"
                                   data-month="{{ bill.billing_month }}"
                                   data-desc="{{ bill.billing_month.strftime('%Yë…„ %mì›”') }} ìˆ˜ë„ìš”ê¸ˆ">
                        </td>
                        <td>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</td>
                        <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
                        <td class="text-right" style="color:#059669;">
                            {% if bill.welfare_discount_total > 0 %}
                                -{{ "{:,.0f}".format(bill.welfare_discount_total) }}ì›
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ bill.details|length }}ì„¸ëŒ€</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #94a3b8;">ì„ íƒ ê°€ëŠ¥í•œ ìˆ˜ë„ìš”ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>

        <!-- ê³µë™ ê³µê³¼ê¸ˆ ì„ íƒ -->
        <div style="margin: 30px 0;">
            <h3>ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ ì„ íƒ</h3>
            {% if common_bills %}
            <table>
                <thead>
                    <tr>
                        <th width="50">ì„ íƒ</th>
                        <th>ì •ì‚°ì›”</th>
                        <th>í•­ëª©</th>
                        <th class="text-right">ì´ì•¡</th>
                        <th>ë¶„ë°°ë°©ì‹</th>
                        <th>ì„¸ëŒ€ìˆ˜</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in common_bills %}
                    <tr>
                        <td>
                            <input type="checkbox" class="common-item"
                                   data-id="{{ bill.id }}"
                                   data-month="{{ bill.billing_month }}"
                                   data-desc="{{ bill.description }}">
                        </td>
                        <td>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</td>
                        <td>{{ bill.description }}</td>
                        <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
                        <td>
                            {% if bill.distribution_method == 'BY_RESIDENTS' %}
                                ì¸ì›ìˆ˜ ë¹„ë¡€
                            {% else %}
                                ì„¸ëŒ€ ê· ë“±
                            {% endif %}
                        </td>
                        <td>{{ bill.details|length }}ì„¸ëŒ€</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color: #94a3b8;">ì„ íƒ ê°€ëŠ¥í•œ ê³µë™ ê³µê³¼ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>

        <div style="margin-top: 30px;">
            <button class="btn btn-primary" onclick="goToStep2()">ë‹¤ìŒ ë‹¨ê³„: ì„¸ëŒ€ë³„ ì„¤ì •</button>
        </div>
    </div>

    <!-- Step 2: ì„¸ëŒ€ë³„ ê¸°íƒ€ê¸ˆì•¡ ë° ë©”ëª¨ -->
    <div id="step2" class="step-content" style="display:none;">
        <h2>Step 2: ì„¸ëŒ€ë³„ ê¸°íƒ€ê¸ˆì•¡ ë° ë©”ëª¨</h2>
        <p style="color:#64748b;margin-bottom:20px;">
            ğŸ’¡ íŠ¹ì • ì„¸ëŒ€ì—ë§Œ ë¶€ê³¼ë˜ëŠ” ê¸°íƒ€ í•­ëª©(ë¯¸ë‚©ê¸ˆ, ìˆ˜ë¦¬ë¹„ ë“±) ë˜ëŠ” í™˜ê¸‰ì•¡ê³¼ ì„¸ëŒ€ë³„ íŠ¹ë³„ ì•ˆë‚´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”.
        </p>

        <div id="unitsAdditionalContainer"></div>

        <div style="margin-top: 30px;display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="goToStep1()">ì´ì „: í•­ëª© ì„ íƒ</button>
            <button class="btn btn-primary" onclick="goToStep3()">ë‹¤ìŒ: ìµœì¢… í™•ì¸</button>
            <button class="btn" onclick="skipToFinal()">ê¸°íƒ€ê¸ˆì•¡ ì—†ì´ ë°”ë¡œ ìƒì„±</button>
        </div>
    </div>

    <!-- Step 3: ìµœì¢… í™•ì¸ -->
    <div id="step3" class="step-content" style="display:none;">
        <h2>Step 3: ìµœì¢… í™•ì¸</h2>
        <div id="finalConfirmation"></div>

        <div style="margin-top: 30px;display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="goToStep2()">ì´ì „: ì„¸ëŒ€ë³„ ì„¤ì •</button>
            <button class="btn btn-primary" onclick="createInvoiceFinal()">âœ… ì •ì‚°ì„œ ìƒì„±</button>
        </div>
    </div>
</div>

<!-- ì •ì‚° ë‚´ì—­ íƒ­ -->
<div id="history-tab" class="tab-content" style="display: none;">
    <h2>ì •ì‚° ë‚´ì—­</h2>

    {% if combinations %}
    <table>
        <thead>
            <tr>
                <th>ìƒì„±ì¼</th>
                <th>ì •ì‚°ì„œëª…</th>
                <th>ë©”ëª¨</th>
                <th>í¬í•¨ í•­ëª©ìˆ˜</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for combo in combinations %}
            <tr>
                <td>{{ combo.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td><strong>{{ combo.invoice_name }}</strong></td>
                <td>{{ combo.memo[:50] if combo.memo else '-' }}{% if combo.memo and combo.memo|length > 50 %}...{% endif %}</td>
                <td>{{ combo.items|length }}ê°œ</td>
                <td>
                    <a href="{{ url_for('view_invoice', combination_id=combo.id) }}" class="btn btn-secondary" style="padding: 5px 10px;">ì¡°íšŒ</a>
                    <a href="{{ url_for('print_invoice', combination_id=combo.id) }}" target="_blank" class="btn btn-primary" style="padding: 5px 10px;">ì¸ì‡„</a>
                    <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteInvoice({{ combo.id }})">ì‚­ì œ</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #94a3b8; text-align: center; padding: 40px;">ìƒì„±ëœ ì •ì‚°ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
const UNITS = {{ (units|default([]))|tojson }};
const FLOORS = {{ (floors|default([]))|tojson }};
let selectedItems = [];
let unitAdditionalData = {};

// íƒ­ ì „í™˜
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    document.querySelectorAll('.tab').forEach(btn => {
        btn.classList.remove('active');
    });

    document.getElementById(tabId).style.display = 'block';
    event.target.classList.add('active');
}

// Step ê´€ë¦¬
function updateStepIndicators(currentStep) {
    for(let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        const content = document.getElementById(`step${i}`);

        if(i < currentStep) {
            indicator.className = 'step completed';
        } else if(i === currentStep) {
            indicator.className = 'step active';
        } else {
            indicator.className = 'step';
        }

        content.style.display = (i === currentStep) ? 'block' : 'none';
    }
}

function goToStep1() {
    updateStepIndicators(1);
}

function goToStep2() {
    const name = document.getElementById('invoiceName').value;
    if (!name) {
        alert('ì •ì‚°ì„œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // ì„ íƒëœ í•­ëª© ìˆ˜ì§‘
    selectedItems = [];

    document.querySelectorAll('.electric-item:checked').forEach(el => {
        selectedItems.push({
            type: 'ELECTRIC',
            id: parseInt(el.dataset.id),
            month: el.dataset.month,
            description: el.dataset.desc
        });
    });

    document.querySelectorAll('.water-item:checked').forEach(el => {
        selectedItems.push({
            type: 'WATER',
            id: parseInt(el.dataset.id),
            month: el.dataset.month,
            description: el.dataset.desc
        });
    });

    document.querySelectorAll('.common-item:checked').forEach(el => {
        selectedItems.push({
            type: 'COMMON',
            id: parseInt(el.dataset.id),
            month: el.dataset.month,
            description: el.dataset.desc
        });
    });

    if (selectedItems.length === 0) {
        alert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    renderStep2();
    updateStepIndicators(2);
}

function renderStep2() {
    const container = document.getElementById('unitsAdditionalContainer');
    const occupiedUnits = UNITS.filter(u => !u.is_vacant);

    // ì¸µë³„ë¡œ ê·¸ë£¹í™”
    const floorGroups = {};
    occupiedUnits.forEach(unit => {
        if (!floorGroups[unit.floor_id]) {
            const floor = FLOORS.find(f => f.id === unit.floor_id);
            floorGroups[unit.floor_id] = {
                floor_name: floor ? floor.name : '',
                units: []
            };
        }
        floorGroups[unit.floor_id].units.push(unit);
    });

    let html = '';

    // ì¸µë³„ë¡œ ë Œë”ë§
    Object.keys(floorGroups).sort((a, b) => {
        const floorA = FLOORS.find(f => f.id == a);
        const floorB = FLOORS.find(f => f.id == b);
        return (floorA?.floor_number || 0) - (floorB?.floor_number || 0);
    }).forEach(floorId => {
        const group = floorGroups[floorId];

        html += `<h3 style="margin-top:30px;margin-bottom:16px;color:#334155;font-size:18px;">${group.floor_name}</h3>`;

        group.units.forEach(unit => {
            const unitMemo = unit.memo ? `<span class="unit-memo-tag">${unit.memo}</span>` : '';

            html += `
                <div class="unit-card">
                    <div class="unit-card-header">
                        <div>
                            <span class="unit-name">${unit.unit_name}</span>
                            ${unitMemo}
                        </div>
                    </div>

                    <div style="margin-bottom:16px;">
                        <div class="section-title">ğŸ’° ê¸°íƒ€ í•­ëª© (ë¶€ê³¼ / í™˜ê¸‰)</div>
                        <div id="charges-${unit.id}"></div>
                        <button type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:13px;margin-top:8px;"
                                onclick="addChargeRow(${unit.id})">+ í•­ëª© ì¶”ê°€</button>
                    </div>

                    <div>
                        <div class="section-title">ğŸ“ ì„¸ëŒ€ë³„ ë©”ëª¨</div>
                        <textarea id="memo-${unit.id}" rows="2" placeholder="ì´ ì„¸ëŒ€ì—ë§Œ ì•ˆë‚´í•  íŠ¹ë³„ ì‚¬í•­"
                                  style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;"></textarea>
                    </div>
                </div>
            `;
        });
    });

    container.innerHTML = html;
}

let chargeCounter = 0;

function addChargeRow(unitId) {
    const container = document.getElementById(`charges-${unitId}`);
    const rowId = `charge-${unitId}-${chargeCounter++}`;

    const row = document.createElement('div');
    row.className = 'additional-charge-row';
    row.id = rowId;
    row.innerHTML = `
        <select class="charge-type" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
            <option value="charge">ë¶€ê³¼ (+)</option>
            <option value="refund">í™˜ê¸‰ (-)</option>
        </select>
        <input type="text" placeholder="í•­ëª©ëª… (ì˜ˆ: ì „ì›” ë¯¸ë‚©ê¸ˆ)" class="charge-desc" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
        <input type="number" placeholder="ê¸ˆì•¡" class="charge-amount" min="0" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
        <button type="button" class="btn btn-danger" style="padding:6px 12px;font-size:12px;"
                onclick="removeChargeRow('${rowId}')">ì‚­ì œ</button>
    `;

    container.appendChild(row);
}

function removeChargeRow(rowId) {
    document.getElementById(rowId).remove();
}

function goToStep3() {
    // ì„¸ëŒ€ë³„ ì¶”ê°€ ë°ì´í„° ìˆ˜ì§‘
    unitAdditionalData = {};
    const occupiedUnits = UNITS.filter(u => !u.is_vacant);

    occupiedUnits.forEach(unit => {
        const charges = [];
        const chargesContainer = document.getElementById(`charges-${unit.id}`);

        if(chargesContainer) {
            chargesContainer.querySelectorAll('.additional-charge-row').forEach(row => {
                const type = row.querySelector('.charge-type').value;
                const desc = row.querySelector('.charge-desc').value;
                let amount = parseFloat(row.querySelector('.charge-amount').value) || 0;

                if(desc && amount > 0) {
                    // í™˜ê¸‰ì¸ ê²½ìš° ìŒìˆ˜ë¡œ ë³€í™˜
                    if(type === 'refund') {
                        amount = -Math.abs(amount);
                    }
                    charges.push({ description: desc, amount: amount });
                }
            });
        }

        const memo = document.getElementById(`memo-${unit.id}`)?.value || '';

        if(charges.length > 0 || memo) {
            unitAdditionalData[unit.id] = { charges, memo };
        }
    });

    renderStep3();
    updateStepIndicators(3);
}

function renderStep3() {
    const container = document.getElementById('finalConfirmation');

    let html = '<div class="confirm-section">';
    html += '<h3>ğŸ“‹ ì„ íƒí•œ í•­ëª©</h3>';

    selectedItems.forEach(item => {
        html += `
            <div class="confirm-item">
                <span class="confirm-item-icon">
                    ${item.type === 'ELECTRIC' ? 'âš¡' : item.type === 'WATER' ? 'ğŸ’§' : 'ğŸ˜ï¸'}
                </span>
                <span class="confirm-item-text">${item.description}</span>
            </div>
        `;
    });
    html += '</div>';

    // ê¸°íƒ€ê¸ˆì•¡/ë©”ëª¨ê°€ ìˆëŠ” ì„¸ëŒ€ ë˜ëŠ” ì„¤ì • ë¹„ê³ ê°€ ìˆëŠ” ì„¸ëŒ€ ì°¾ê¸°
    const occupiedUnits = UNITS.filter(u => !u.is_vacant);
    const unitsToShow = occupiedUnits.filter(unit => {
        const hasAdditional = unitAdditionalData[unit.id];
        const hasSettingMemo = unit.memo && unit.memo.trim() !== '';
        return hasAdditional || hasSettingMemo;
    });

    if(unitsToShow.length > 0) {
        html += '<div class="confirm-section">';
        html += '<h3>ğŸ’° ê¸°íƒ€ê¸ˆì•¡ ë° ë©”ëª¨ ì„¤ì •</h3>';

        unitsToShow.forEach(unit => {
            const data = unitAdditionalData[unit.id] || { charges: [], memo: '' };

            html += '<div class="unit-summary-card">';
            html += '<div class="unit-summary-header">';
            html += `<span class="unit-summary-name">${unit.unit_name}</span>`;

            // ì„¸ëŒ€ ì„¤ì • ë¹„ê³  í‘œì‹œ (unit.memo)
            if(unit.memo) {
                html += `<span class="unit-summary-memo">${unit.memo}</span>`;
            }

            html += '</div>';

            html += '<div class="unit-summary-details">';

            // ê¸°íƒ€ í•­ëª©
            if(data.charges && data.charges.length > 0) {
                html += '<div style="grid-column: 1 / -1;">';
                html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">ê¸°íƒ€ í•­ëª©:</div>';
                data.charges.forEach(c => {
                    const isRefund = c.amount < 0;
                    const displayAmount = Math.abs(c.amount).toLocaleString();
                    const color = isRefund ? '#059669' : '#dc2626';
                    const prefix = isRefund ? 'í™˜ê¸‰ -' : 'ë¶€ê³¼ +';

                    html += `
                        <div style="padding:6px 12px;background:#f8fafc;border-radius:6px;margin-bottom:4px;">
                            <span style="color:#475569;">${c.description}</span>
                            <span style="color:${color};font-weight:600;margin-left:8px;">${prefix}${displayAmount}ì›</span>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // ì„¸ëŒ€ ë©”ëª¨
            if(data.memo) {
                html += '<div style="grid-column: 1 / -1;">';
                html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">ì„¸ëŒ€ ë©”ëª¨:</div>';
                html += `<div style="padding:8px 12px;background:#fff3cd;border-radius:6px;color:#78350f;font-size:13px;white-space:pre-wrap;">${data.memo}</div>`;
                html += '</div>';
            }

            // ê¸°íƒ€ í•­ëª©ì´ë‚˜ ì„¸ëŒ€ ë©”ëª¨ê°€ ì—†ì§€ë§Œ ì„¤ì • ë¹„ê³ ë§Œ ìˆëŠ” ê²½ìš°
            if((!data.charges || data.charges.length === 0) && !data.memo && unit.memo) {
                html += '<div style="grid-column: 1 / -1;color:#64748b;font-size:13px;font-style:italic;">';
                html += '(ì„¤ì •ì— ë¹„ê³ ë§Œ ë“±ë¡ëœ ì„¸ëŒ€ì…ë‹ˆë‹¤)';
                html += '</div>';
            }

            html += '</div>'; // unit-summary-details
            html += '</div>'; // unit-summary-card
        });

        html += '</div>';
    } else {
        html += '<div class="confirm-section">';
        html += '<p style="color:#64748b;margin:0;">ê¸°íƒ€ê¸ˆì•¡ ë° ì„¸ëŒ€ë³„ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        html += '</div>';
    }

    container.innerHTML = html;
}

function skipToFinal() {
    unitAdditionalData = {};
    renderStep3();
    updateStepIndicators(3);
}

// ì •ì‚°ì„œ ìµœì¢… ìƒì„±
async function createInvoiceFinal() {
    const name = document.getElementById('invoiceName').value;

    const data = {
        name: name,
        memo: document.getElementById('invoiceMemo').value,
        items: selectedItems,
        unit_additional_data: unitAdditionalData,
        _csrf_token: getCsrfToken()
    };

    const response = await fetch('/invoice/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    });

    const result = await response.json();
    if (result.success) {
        alert('ì •ì‚°ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = `/invoice/view/${result.id}`;
    } else {
        alert(result.message);
    }
}

// ì •ì‚°ì„œ ì‚­ì œ
async function deleteInvoice(id) {
    if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ëœ ëª¨ë“  ì²­êµ¬ ë‚´ì—­ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

    const fd = new FormData();
    fd.append('_csrf_token', getCsrfToken());

    const res = await fetch(`/invoice/delete/${id}`, {
        method: 'POST',
        body: fd
    });

    const j = await res.json();
    alert(j.message || (j.success ? 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚­ì œ ì‹¤íŒ¨'));
    if(j.success) location.reload();
}
</script>
{% endblock %}