{% extends "base.html" %}

{% block title %}정산 조합 - 공과금 정산 시스템{% endblock %}

{% block extra_css %}
    <style>
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin: var(--space-2xl) 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-xl);
            background: var(--gray-200);
            border-radius: 25px;
            transition: var(--transition-base);
        }

        .step.active {
            background: var(--primary-gradient);
            color: white;
        }

        .step.completed {
            background: var(--success-color);
            color: white;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            background: white;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .unit-card {
            background: #ffffff;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            transition: var(--transition-base);
        }

        .unit-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .unit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--gray-100);
        }

        .unit-name {
            font-size: var(--font-large);
            font-weight: 700;
            color: var(--gray-800);
        }

        .unit-memo-tag {
            font-size: var(--font-small);
            color: var(--gray-600);
            background: var(--gray-100);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-lg);
            font-weight: 500;
            margin-left: var(--space-sm);
        }

        .section-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-sm);
            font-size: var(--font-base);
        }

        .additional-charge-row {
            display: grid;
            grid-template-columns: minmax(100px, 120px) 1fr minmax(120px, 150px) minmax(70px, 80px);
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            align-items: center;
        }

        .unit-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            font-size: var(--font-small);
            color: var(--gray-600);
        }

        .unit-summary-row strong {
            color: var(--gray-700);
        }
    </style>
{% endblock %}

{% block content %}
    <h1><span class="emoji">📄</span> 정산 조합</h1>

    <div class="tabs">
        <button class="tab active" onclick="showTab('create-tab')">➕ 새 정산 생성</button>
        <button class="tab" onclick="showTab('history-tab')">📋 정산 내역</button>
    </div>
    <div class="tabs-container">
        <!-- 새 정산 생성 탭 -->
        <div id="create-tab" class="tab-content">
            <div class="step-indicator">
                <div class="step active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <span>항목 선택</span>
                </div>
                <div class="step" id="step2-indicator">
                    <div class="step-number">2</div>
                    <span>기타금액/메모</span>
                </div>
                <div class="step" id="step3-indicator">
                    <div class="step-number">3</div>
                    <span>최종 확인</span>
                </div>
            </div>

            <!-- Step 1: 항목 선택 -->
            <div id="step1" class="step-content">
                <h2>Step 1: 청구 항목 선택</h2>

                <div class="form-group">
                    <label>정산서 이름</label>
                    <input type="text" id="invoiceName" placeholder="예: 2024년 3월 정산" required>
                </div>

                <div class="form-group">
                    <label>추가 메모 (선택)</label>
                    <textarea id="invoiceMemo" rows="3" placeholder="고정 메모 외에 추가로 안내할 내용이 있으면 입력하세요"></textarea>
                    <small style="color:#64748b;">
                        💡 설정에서 등록한 고정 메모가 자동으로 포함됩니다. 여기에 입력한 내용은 고정 메모 뒤에 추가됩니다.
                    </small>
                </div>

                <!-- 전기요금 선택 -->
                <div style="margin: 30px 0;">
                    <h3>⚡ 전기요금 선택</h3>
                    {% if electric_bills %}
                        <table>
                            <thead>
                            <tr>
                                <th width="50">선택</th>
                                <th>정산월</th>
                                <th>포함 고지월</th>
                                <th>층</th>
                                <th class="text-right">총액</th>
                                <th class="text-right">복지할인</th>
                                <th class="text-right">바우처할인</th>
                                <th class="text-right">TV수신료</th>
                                <th>세대수</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for bill in electric_bills %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="electric-item"
                                               data-id="{{ bill.id }}"
                                               data-month="{{ bill.billing_month }}"
                                               data-desc="{{ bill.billing_month.strftime('%Y년 %m월') }} {{ bill.floor_ref.name }} 전기요금">
                                    </td>
                                    <td>{{ bill.billing_month.strftime('%Y년 %m월') }}</td>
                                    <td style="min-width:200px;">
                                        {% if bill.monthly_details %}
                                            {% set months = bill.monthly_details | map(attribute='month') | select | list %}
                                            {% if months|length > 1 %}
                                                <div style="display:flex;align-items:center;gap:8px;">
                                                    <span class="badge badge-primary">{{ months|length }}개월 묶음</span>
                                                    <span style="font-size:12px;color:#64748b;">
                                                {% for detail in bill.monthly_details %}
                                                    {% if detail.month %}
                                                        {{ detail.month[:7] }}
                                                        {% if not loop.last %}, {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            </span>
                                                </div>
                                            {% else %}
                                                {# 단일 고지월인 경우 명확한 월 표시 #}
                                                {% set first_month = months[0] if months|length > 0 else '' %}
                                                {% if first_month %}
                                                    <span style="font-size:13px;color:#64748b;">{{ first_month[:7] }}</span>
                                                {% else %}
                                                    <span style="font-size:13px;color:#64748b;">{{ bill.billing_month.strftime('%Y-%m') }}</span>
                                                {% endif %}
                                            {% endif %}
                                        {% else %}
                                            <span style="font-size:13px;color:#64748b;">{{ bill.billing_month.strftime('%Y-%m') }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ bill.floor_ref.name }}</td>
                                    <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}원</td>
                                    <td class="text-right" style="color:#059669;">
                                        {% if bill.welfare_discount > 0 %}
                                            -{{ "{:,.0f}".format(bill.welfare_discount) }}원
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-right" style="color:#059669;">
                                        {% if bill.voucher_discount > 0 %}
                                            -{{ "{:,.0f}".format(bill.voucher_discount) }}원
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-right" style="color:#dc2626;">
                                        {% if bill.tv_fee_total > 0 %}
                                            +{{ "{:,.0f}".format(bill.tv_fee_total) }}원
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ bill.details|length }}세대</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="color: #94a3b8;">선택 가능한 전기요금이 없습니다.</p>
                    {% endif %}
                </div>

                <!-- 수도요금 선택 -->
                <div style="margin: 30px 0;">
                    <h3>💧 수도요금 선택</h3>
                    {% if water_bills %}
                        <table>
                            <thead>
                            <tr>
                                <th width="50">선택</th>
                                <th>정산월</th>
                                <th class="text-right">총액</th>
                                <th class="text-right">복지할인합계</th>
                                <th>세대수</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for bill in water_bills %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="water-item"
                                               data-id="{{ bill.id }}"
                                               data-month="{{ bill.billing_month }}"
                                               data-desc="{{ bill.billing_month.strftime('%Y년 %m월') }} 수도요금">
                                    </td>
                                    <td>{{ bill.billing_month.strftime('%Y년 %m월') }}</td>
                                    <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}원</td>
                                    <td class="text-right" style="color:#059669;">
                                        {% if bill.welfare_discount_total > 0 %}
                                            -{{ "{:,.0f}".format(bill.welfare_discount_total) }}원
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ bill.details|length }}세대</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="color: #94a3b8;">선택 가능한 수도요금이 없습니다.</p>
                    {% endif %}
                </div>

                <!-- 공동 공과금 선택 -->
                <div style="margin: 30px 0;">
                    <h3>🏘️ 공동 공과금 선택</h3>
                    {% if common_bills %}
                        <table>
                            <thead>
                            <tr>
                                <th width="50">선택</th>
                                <th>정산월</th>
                                <th>항목</th>
                                <th class="text-right">총액</th>
                                <th>분배방식</th>
                                <th>세대수</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for bill in common_bills %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="common-item"
                                               data-id="{{ bill.id }}"
                                               data-month="{{ bill.billing_month }}"
                                               data-desc="{{ bill.description }}">
                                    </td>
                                    <td>{{ bill.billing_month.strftime('%Y년 %m월') }}</td>
                                    <td>{{ bill.description }}</td>
                                    <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}원</td>
                                    <td>
                                        {% if bill.distribution_method == 'BY_RESIDENTS' %}
                                            인원수 비례
                                        {% else %}
                                            세대 균등
                                        {% endif %}
                                    </td>
                                    <td>{{ bill.details|length }}세대</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p style="color: #94a3b8;">선택 가능한 공동 공과금이 없습니다.</p>
                    {% endif %}
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="goToStep2()">다음 단계: 세대별 설정</button>
                </div>
            </div>

            <!-- Step 2: 세대별 기타금액 및 메모 -->
            <div id="step2" class="step-content" style="display:none;">
                <h2>Step 2: 세대별 기타금액 및 메모</h2>
                <p style="color:#64748b;margin-bottom:20px;">
                    💡 특정 세대에만 부과되는 기타 항목(미납금, 수리비 등) 또는 환급액과 세대별 특별 안내사항을 입력하세요.
                </p>

                <div id="unitsAdditionalContainer"></div>

                <div style="margin-top: 30px;display:flex;gap:10px;">
                    <button class="btn btn-secondary" onclick="goToStep1()">이전: 항목 선택</button>
                    <button class="btn btn-primary" onclick="goToStep3()">다음: 최종 확인</button>
                    <button class="btn" onclick="skipToFinal()">기타금액 없이 바로 생성</button>
                </div>
            </div>

            <!-- Step 3: 최종 확인 -->
            <div id="step3" class="step-content" style="display:none;">
                <h2>Step 3: 최종 확인</h2>
                <div id="finalConfirmation"></div>

                <div style="margin-top: 30px;display:flex;gap:10px;">
                    <button class="btn btn-secondary" onclick="goToStep2()">이전: 세대별 설정</button>
                    <button class="btn btn-primary" onclick="createInvoiceFinal()">✅ 정산서 생성</button>
                </div>
            </div>
        </div>

        <!-- 정산 내역 탭 -->
        <div id="history-tab" class="tab-content">
            <h2>정산 내역</h2>

            {% if combinations %}
                <table>
                    <thead>
                    <tr>
                        <th>생성일</th>
                        <th>정산서명</th>
                        <th>메모</th>
                        <th>포함 항목수</th>
                        <th>작업</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for combo in combinations %}
                        <tr>
                            <td>{{ combo.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><strong>{{ combo.invoice_name }}</strong></td>
                            <td>{{ combo.memo[:50] if combo.memo else '-' }}
                                    {% if combo.memo and combo.memo|length > 50 %}...{% endif %}</td>
                            <td>{{ combo.items|length }}개</td>
                            <td>
                                <a href="{{ url_for('view_invoice', combination_id=combo.id) }}"
                                   class="btn btn-secondary" style="padding: 5px 10px;">조회</a>
                                <a href="{{ url_for('print_invoice', combination_id=combo.id) }}" target="_blank"
                                   class="btn btn-primary" style="padding: 5px 10px;">인쇄</a>
                                <button class="btn btn-danger" style="padding: 5px 10px;"
                                        onclick="deleteInvoice({{ combo.id }})">삭제
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p style="color: #94a3b8; text-align: center; padding: 40px;">생성된 정산서가 없습니다.</p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        const UNITS = {{ (units|default([]))|tojson }};
        const FLOORS = {{ (floors|default([]))|tojson }};
        let selectedItems = [];
        let unitAdditionalData = {};

        // 탭 전환
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).style.display = 'block';
            event.target.classList.add('active');
        }

        // Step 관리
        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const content = document.getElementById(`step${i}`);

                if (i < currentStep) {
                    indicator.className = 'step completed';
                } else if (i === currentStep) {
                    indicator.className = 'step active';
                } else {
                    indicator.className = 'step';
                }

                content.style.display = (i === currentStep) ? 'block' : 'none';
            }
        }

        function goToStep1() {
            updateStepIndicators(1);
        }

        function goToStep2() {
            const name = document.getElementById('invoiceName').value;
            if (!name) {
                alert('정산서 이름을 입력해주세요.');
                return;
            }

            // 선택된 항목 수집
            selectedItems = [];

            document.querySelectorAll('.electric-item:checked').forEach(el => {
                selectedItems.push({
                    type: 'ELECTRIC',
                    id: parseInt(el.dataset.id),
                    month: el.dataset.month,
                    description: el.dataset.desc
                });
            });

            document.querySelectorAll('.water-item:checked').forEach(el => {
                selectedItems.push({
                    type: 'WATER',
                    id: parseInt(el.dataset.id),
                    month: el.dataset.month,
                    description: el.dataset.desc
                });
            });

            document.querySelectorAll('.common-item:checked').forEach(el => {
                selectedItems.push({
                    type: 'COMMON',
                    id: parseInt(el.dataset.id),
                    month: el.dataset.month,
                    description: el.dataset.desc
                });
            });

            if (selectedItems.length === 0) {
                alert('최소 하나 이상의 항목을 선택해주세요.');
                return;
            }

            renderStep2();
            updateStepIndicators(2);
        }

        async function renderStep2() {
            const container = document.getElementById('unitsAdditionalContainer');
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);

            // 전체 세대 잔액 가져오기
            let balances = {};
            try {
                const res = await fetch('/payments/all_units_balance');
                const data = await res.json();
                if (data.success) {
                    balances = data.balances;
                }
            } catch (error) {
                console.error('잔액 조회 실패:', error);
            }

            // 층별로 그룹화
            const floorGroups = {};
            occupiedUnits.forEach(unit => {
                if (!floorGroups[unit.floor_id]) {
                    const floor = FLOORS.find(f => f.id === unit.floor_id);
                    floorGroups[unit.floor_id] = {
                        floor_name: floor ? floor.name : '',
                        units: []
                    };
                }
                floorGroups[unit.floor_id].units.push(unit);
            });

            let html = '';

            // 층별로 렌더링
            Object.keys(floorGroups).sort((a, b) => {
                const floorA = FLOORS.find(f => f.id == a);
                const floorB = FLOORS.find(f => f.id == b);
                return (floorA?.floor_number || 0) - (floorB?.floor_number || 0);
            }).forEach(floorId => {
                const group = floorGroups[floorId];

                html += `<h3 style="margin-top:30px;margin-bottom:16px;color:#334155;font-size:18px;">${group.floor_name}</h3>`;

                group.units.forEach(unit => {
                    const unitMemo = unit.memo ? `<span class="unit-memo-tag">${unit.memo}</span>` : '';

                    // 해당 세대의 잔액 확인
                    const balance = balances[unit.id];
                    let balanceAlert = '';

                    if (balance && balance.balance !== 0) {
                        const balanceAmount = Math.abs(balance.balance);
                        const balanceType = balance.balance > 0 ? '미납' : '초과납부';
                        const balanceColor = balance.balance > 0 ? '#dc2626' : '#059669';

                        balanceAlert = `
                    <div style="background: ${balance.balance > 0 ? '#fef2f2' : '#f0fdf4'};
                                border-left: 4px solid ${balance.balance > 0 ? '#dc2626' : '#059669'};
                                padding: 12px; margin-top: 10px; border-radius: 6px;">
                        <strong style="color: ${balance.balance > 0 ? '#dc2626' : '#059669'};">
                            ${balanceType} ${balanceAmount.toLocaleString()}원
                        </strong>
                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #64748b;">
                            💡 이 금액은 참고용이며, "잔액 자동 적용" 버튼을 누르면 <strong>[이월]</strong> 항목으로 추가됩니다.<br>
                            실제 청구 금액 계산 시 이월 항목은 <strong>중복 계산되지 않습니다</strong>.
                        </p>
                        <button type="button" class="btn btn-primary"
                                style="margin-top: 10px; padding: 6px 12px; font-size: 13px;"
                                onclick="applyBalance(${unit.id}, ${balance.balance})">
                            잔액 자동 적용
                        </button>
                    </div>
                `;
                    }

                    html += `
                <div class="unit-card">
                    <div class="unit-card-header">
                        <div>
                            <span class="unit-name">${unit.unit_name}</span>
                            ${unitMemo}
                        </div>
                    </div>

                    ${balanceAlert}

                    <div style="margin-bottom:16px;">
                        <div class="section-title">💰 기타 항목 (부과 / 환급)</div>
                        <div id="charges-${unit.id}"></div>
                        <button type="button" class="btn btn-secondary" style="padding:6px 12px;font-size:13px;margin-top:8px;"
                                onclick="addChargeRow(${unit.id})">+ 항목 추가</button>
                    </div>

                    <div>
                        <div class="section-title">📝 세대별 메모</div>
                        <textarea id="memo-${unit.id}" rows="2" placeholder="이 세대에만 안내할 특별 사항"
                                  style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;"></textarea>
                    </div>
                </div>
            `;
                });
            });

            container.innerHTML = html;
        }

        let chargeCounter = 0;

        function addChargeRow(unitId) {
            const container = document.getElementById(`charges-${unitId}`);
            const rowId = `charge-${unitId}-${chargeCounter++}`;

            const row = document.createElement('div');
            row.className = 'additional-charge-row';
            row.id = rowId;
            row.innerHTML = `
        <select class="charge-type" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
            <option value="charge">부과 (+)</option>
            <option value="refund">환급 (-)</option>
        </select>
        <input type="text" placeholder="항목명 (예: 전월 미납금)" class="charge-desc" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
        <input type="number" placeholder="금액" class="charge-amount" min="0" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
        <button type="button" class="btn btn-danger" style="padding:6px 12px;font-size:12px;"
                onclick="removeChargeRow('${rowId}')">삭제</button>
    `;

            container.appendChild(row);
        }

        function removeChargeRow(rowId) {
            document.getElementById(rowId).remove();
        }

        // 잔액 자동 적용 함수
        function applyBalance(unitId, balance) {
            const container = document.getElementById(`charges-${unitId}`);
            const rowId = `charge-${unitId}-${chargeCounter++}`;

            const row = document.createElement('div');
            row.className = 'additional-charge-row';
            row.id = rowId;

            const type = balance > 0 ? 'charge' : 'refund';
            const amount = Math.abs(balance);
            const description = balance > 0 ? '[이월] 전월 미납금' : '[이월] 전월 초과납부 환급';

            row.innerHTML = `
        <select class="charge-type" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
            <option value="charge" ${type === 'charge' ? 'selected' : ''}>부과 (+)</option>
            <option value="refund" ${type === 'refund' ? 'selected' : ''}>환급 (-)</option>
        </select>
        <input type="text" placeholder="항목명" class="charge-desc" value="${description}" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
        <input type="number" placeholder="금액" class="charge-amount" value="${amount}" min="0" style="font-size:13px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
        <button type="button" class="btn btn-danger" style="padding:6px 12px;font-size:12px;"
                onclick="removeChargeRow('${rowId}')">삭제</button>
    `;

            container.appendChild(row);

            alert(`${description} ${amount.toLocaleString()}원이 자동으로 추가되었습니다.\n필요시 수정 또는 삭제할 수 있습니다.`);
        }

        function goToStep3() {
            // 세대별 추가 데이터 수집
            unitAdditionalData = {};
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);

            occupiedUnits.forEach(unit => {
                const charges = [];
                const chargesContainer = document.getElementById(`charges-${unit.id}`);

                if (chargesContainer) {
                    chargesContainer.querySelectorAll('.additional-charge-row').forEach(row => {
                        const type = row.querySelector('.charge-type').value;
                        const desc = row.querySelector('.charge-desc').value;
                        let amount = parseFloat(row.querySelector('.charge-amount').value) || 0;

                        if (desc && amount > 0) {
                            // 환급인 경우 음수로 변환
                            if (type === 'refund') {
                                amount = -Math.abs(amount);
                            }
                            charges.push({description: desc, amount: amount});
                        }
                    });
                }

                const memo = document.getElementById(`memo-${unit.id}`)?.value || '';

                if (charges.length > 0 || memo) {
                    unitAdditionalData[unit.id] = {charges, memo};
                }
            });

            renderStep3();
            updateStepIndicators(3);
        }

        function renderStep3() {
            const container = document.getElementById('finalConfirmation');

            let html = '<div class="confirm-section">';
            html += '<h3>📋 선택한 항목</h3>';

            selectedItems.forEach(item => {
                html += `
            <div class="confirm-item">
                <span class="confirm-item-icon">
                    ${item.type === 'ELECTRIC' ? '⚡' : item.type === 'WATER' ? '💧' : '🏘️'}
                </span>
                <span class="confirm-item-text">${item.description}</span>
            </div>
        `;
            });
            html += '</div>';

            // 기타금액/메모가 있는 세대 또는 설정 비고가 있는 세대 찾기
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);
            const unitsToShow = occupiedUnits.filter(unit => {
                const hasAdditional = unitAdditionalData[unit.id];
                const hasSettingMemo = unit.memo && unit.memo.trim() !== '';
                return hasAdditional || hasSettingMemo;
            });

            if (unitsToShow.length > 0) {
                html += '<div class="confirm-section">';
                html += '<h3>💰 기타금액 및 메모 설정</h3>';

                unitsToShow.forEach(unit => {
                    const data = unitAdditionalData[unit.id] || {charges: [], memo: ''};

                    html += '<div class="unit-summary-card">';
                    html += '<div class="unit-summary-header">';
                    html += `<span class="unit-summary-name">${unit.unit_name}</span>`;

                    // 세대 설정 비고 표시 (unit.memo)
                    if (unit.memo) {
                        html += `<span class="unit-summary-memo">${unit.memo}</span>`;
                    }

                    html += '</div>';

                    html += '<div class="unit-summary-details">';

                    // 기타 항목
                    if (data.charges && data.charges.length > 0) {
                        html += '<div style="margin-top:8px;">';
                        html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">기타 항목:</div>';
                        data.charges.forEach(c => {
                            const isRefund = c.type === 'refund';
                            const isCarryover = c.description.includes('[이월]');
                            const displayAmount = Math.abs(c.amount).toLocaleString();
                            const color = isRefund ? '#059669' : '#dc2626';
                            const prefix = isRefund ? '환급 -' : '부과 +';
                            const bgColor = isCarryover ? '#fef3c7' : '#f8fafc';

                            html += `
                        <div style="padding:6px 12px;background:${bgColor};border-radius:6px;margin-bottom:4px;${isCarryover ? 'border-left:3px solid #fbbf24;' : ''}">
                            <span style="color:#475569;">${c.description}</span>
                            <span style="color:${color};font-weight:600;margin-left:8px;">${prefix}${displayAmount}원</span>
                            ${isCarryover ? '<span style="font-size:10px;color:#92400e;margin-left:4px;">(참고용, 중복계산 안됨)</span>' : ''}
                        </div>
                    `;
                        });
                        html += '</div>';
                    }

                    // 세대 메모
                    if (data.memo) {
                        html += '<div style="grid-column: 1 / -1;">';
                        html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">세대 메모:</div>';
                        html += `<div style="padding:8px 12px;background:#fff3cd;border-radius:6px;color:#78350f;font-size:13px;white-space:pre-wrap;">${data.memo}</div>`;
                        html += '</div>';
                    }

                    // 기타 항목이나 세대 메모가 없지만 설정 비고만 있는 경우
                    if ((!data.charges || data.charges.length === 0) && !data.memo && unit.memo) {
                        html += '<div style="grid-column: 1 / -1;color:#64748b;font-size:13px;font-style:italic;">';
                        html += '(설정에 비고만 등록된 세대입니다)';
                        html += '</div>';
                    }

                    html += '</div>'; // unit-summary-details
                    html += '</div>'; // unit-summary-card
                });

                html += '</div>';
            } else {
                html += '<div class="confirm-section">';
                html += '<p style="color:#64748b;margin:0;">기타금액 및 세대별 메모가 없습니다.</p>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function skipToFinal() {
            unitAdditionalData = {};
            renderStep3();
            updateStepIndicators(3);
        }

        // 정산서 최종 생성
        async function createInvoiceFinal() {
            const name = document.getElementById('invoiceName').value;

            const data = {
                name: name,
                memo: document.getElementById('invoiceMemo').value,
                items: selectedItems,
                unit_additional_data: unitAdditionalData,
                _csrf_token: getCsrfToken()
            };

            const response = await fetch('/invoice/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('정산서가 생성되었습니다.');
                window.location.href = `/invoice/view/${result.id}`;
            } else {
                alert(result.message);
            }
        }

        // 정산서 삭제
        async function deleteInvoice(id) {
            if (!confirm('정말 삭제하시겠습니까? 관련된 모든 청구 내역도 함께 삭제됩니다.')) return;

            const fd = new FormData();
            fd.append('_csrf_token', getCsrfToken());

            const res = await fetch(`/invoice/delete/${id}`, {
                method: 'POST',
                body: fd
            });

            const j = await res.json();
            alert(j.message || (j.success ? '삭제되었습니다.' : '삭제 실패'));
            if (j.success) location.reload();
        }
    </script>
{% endblock %}