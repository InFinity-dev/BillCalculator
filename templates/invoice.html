{% extends "base.html" %}

{% block title %}ì •ì‚° ì¡°í•© - ê³µê³¼ê¸ˆ ì •ì‚° ì‹œìŠ¤í…œ{% endblock %}

{% block extra_css %}
    <style>
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin: var(--space-2xl) 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-xl);
            background: var(--gray-200);
            border-radius: 25px;
            transition: var(--transition-base);
        }

        .step.active {
            background: var(--primary-gradient);
            color: white;
        }

        .step.completed {
            background: var(--success-color);
            color: white;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: var(--radius-full);
            background: white;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .unit-card {
            background: #ffffff;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
            transition: var(--transition-base);
        }

        .unit-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .unit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--gray-100);
        }

        .unit-name {
            font-size: var(--font-large);
            font-weight: 700;
            color: var(--gray-800);
        }

        .unit-memo-tag {
            font-size: var(--font-small);
            color: var(--gray-600);
            background: var(--gray-100);
            padding: var(--space-xs) var(--space-md);
            border-radius: var(--radius-lg);
            font-weight: 500;
            margin-left: var(--space-sm);
        }

        .section-title {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: var(--space-sm);
            font-size: var(--font-base);
        }

        .additional-charge-row {
            display: grid;
            grid-template-columns: minmax(100px, 120px) 1fr minmax(120px, 150px) minmax(70px, 80px);
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            align-items: center;
        }

        .unit-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            font-size: var(--font-small);
            color: var(--gray-600);
        }

        .unit-summary-row strong {
            color: var(--gray-700);
        }

        /* ì„¸ëŒ€ ì¼ê´„ ê´€ë¦¬ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        /*
        .units-table-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }*/

        .units-table {
            width: 100%;
            border-collapse: collapse;
        }

        .units-table thead {
            /*background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);*/
            color: white;
        }

        .units-table th {
            padding: var(--space-md) var(--space-lg);
            text-align: left;
            font-weight: 600;
            font-size: var(--font-small);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            background: inherit;
        }

        .units-table tbody tr {
            border-bottom: 1px solid var(--gray-200);
            transition: var(--transition-fast);
        }

        .units-table tbody tr:hover {
            background: var(--gray-50);
        }

        .units-table tbody tr.floor-separator {
            background: #f8fafc;
            border-top: 2px solid var(--gray-300);
            border-bottom: 2px solid var(--gray-300);
        }

        .units-table tbody tr.floor-separator td {
            padding: var(--space-sm) var(--space-lg);
            font-weight: 700;
            color: var(--gray-700);
            background: linear-gradient(90deg, #f1f5f9 0%, #f8fafc 100%);
        }

        .units-table td {
            padding: var(--space-sm) var(--space-lg);
            vertical-align: top;
        }

        .unit-name-cell {
            font-weight: 600;
            color: var(--gray-800);
            white-space: nowrap;
        }

        .unit-memo-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            background: var(--gray-100);
            color: var(--gray-600);
            border-radius: var(--radius-md);
            margin-left: var(--space-xs);
        }

        .balance-cell {
            min-width: 180px;
        }

        .balance-info-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }

        .balance-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-md);
            font-size: var(--font-small);
            font-weight: 600;
        }

        .balance-badge.unpaid {
            background: #fef2f2;
            color: var(--danger-dark);
            border: 1px solid #fecaca;
        }

        .balance-badge.overpaid {
            background: #f0fdf4;
            color: var(--success-dark);
            border: 1px solid #bbf7d0;
        }

        .balance-badge.none {
            background: var(--gray-100);
            color: var(--gray-500);
        }

        .balance-apply-btn {
            font-size: 11px;
            padding: 8px;
            white-space: nowrap;
            width: fit-content;
        }

        .charges-cell {
            min-width: 280px;
        }

        .charge-inline-container {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .charge-inline-row {
            display: flex;
            padding-left: 11px;
            gap: 6px;
            align-items: center;
        }

        .charge-inline-row select,
        .charge-inline-row input {
            font-size: 12px;
            padding: 4px 6px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
        }

        .charge-inline-row select {
            width: 70px;
        }

        .charge-inline-row .charge-desc {
            flex: 1;
            min-width: 100px;
        }

        .charge-inline-row .charge-amount {
            width: 80px;
        }

        .charge-inline-row button {
            padding: 2px 6px;
            font-size: 11px;
            min-width: 35px;
        }

        /* ì´ì›” í•­ëª© ìŠ¤íƒ€ì¼ */
        .charge-inline-row.carryover-row {
            background: linear-gradient(90deg, #fef3c7 0%, #fef9e7 100%);
            border-left: 3px solid #fbbf24;
            padding-left: 8px;
            border-radius: var(--radius-sm);
            position: relative;
            animation: highlightFade 0.5s ease;
        }

        @keyframes highlightFade {
            0% {
                background: linear-gradient(90deg, #fde68a 0%, #fef3c7 100%);
                transform: translateX(-3px);
            }
            100% {
                background: linear-gradient(90deg, #fef3c7 0%, #fef9e7 100%);
                transform: translateX(0);
            }
        }

        /*
        .charge-inline-row.carryover-row::before {
            content: "ìë™";
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            background: #fbbf24;
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);
        }*/

        .charge-inline-row.carryover-row .charge-type,
        .charge-inline-row.carryover-row .charge-desc,
        .charge-inline-row.carryover-row .charge-amount {
            background: rgba(255, 255, 255, 0.8);
            border-color: #fbbf24;
        }

        .charge-inline-row.carryover-row .charge-desc {
            font-weight: 600;
            color: #92400e;
        }

        /* ì´ì›” í•­ëª© hover íš¨ê³¼ */
        .charge-inline-row.carryover-row:hover {
            background: linear-gradient(90deg, #fed7aa 0%, #fef3c7 100%);
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.2);
        }

        /* ì´ì›” í•­ëª© íˆ´íŒ */
        .carryover-tooltip {
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: #fbbf24;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            z-index: 1;
        }

        .carryover-tooltip:hover::after {
            content: "ì „ì›” ì”ì•¡ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ëœ í•­ëª©ì…ë‹ˆë‹¤";
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: #1f2937;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            font-weight: normal;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .carryover-tooltip:hover::before {
            content: "";
            position: absolute;
            right: 22px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 5px solid #1f2937;
        }

        /* ì»¨í…Œì´ë„ˆ ì—¬ë°± ì¡°ì • (ìë™ ë ˆì´ë¸” ê³µê°„ í™•ë³´) */
        .charge-inline-container {
        /*    padding-left: 40px;*/
            position: relative;
        }

        .add-charge-btn {
            font-size: 11px;
            padding: 3px 8px;
            margin-top: 4px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px dashed var(--gray-400);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .add-charge-btn:hover {
            background: var(--primary-color);
            color: white;
            border-style: solid;
        }

        .memo-cell textarea {
            width: 100%;
            min-width: 200px;
            font-size: 12px;
            padding: 6px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            resize: vertical;
        }

        /* í…Œì´ë¸” ìƒë‹¨ ìš”ì•½ ì •ë³´ */
        .table-summary {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .summary-item {
            flex: 1;
        }

        .summary-label {
            font-size: var(--font-small);
            color: var(--gray-600);
            margin-bottom: var(--space-xs);
        }

        .summary-value {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--gray-800);
        }

        .summary-value.highlight {
            color: var(--danger-dark);
        }

        /* ë°˜ì‘í˜• ìŠ¤í¬ë¡¤ */
        @media (max-width: 1024px) {
            .units-table-container {
                overflow-x: auto;
            }

            .units-table {
                min-width: 800px;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <h1><span class="emoji">ğŸ“„</span> ì •ì‚° ì¡°í•©</h1>

    <div class="tabs">
        <button class="tab active" onclick="showTab('create-tab')">â• ìƒˆ ì •ì‚° ìƒì„±</button>
        <button class="tab" onclick="showTab('history-tab')">ğŸ“‹ ì •ì‚° ë‚´ì—­</button>
    </div>
    <div class="tabs-container">
        <!-- ìƒˆ ì •ì‚° ìƒì„± íƒ­ -->
        <div id="create-tab" class="tab-content">
            <div class="step-indicator">
                <div class="step active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <span>í•­ëª© ì„ íƒ</span>
                </div>
                <div class="step" id="step2-indicator">
                    <div class="step-number">2</div>
                    <span>ê¸°íƒ€ê¸ˆì•¡/ë©”ëª¨</span>
                </div>
                <div class="step" id="step3-indicator">
                    <div class="step-number">3</div>
                    <span>ìµœì¢… í™•ì¸</span>
                </div>
            </div>
            <div class="content-card" style="margin-bottom:20px;">
                <!-- Step 1: í•­ëª© ì„ íƒ -->
                <div id="step1" class="step-content">
                    <div style="margin-bottom: 20px;">
                        <h2 style="margin: 0px;">Step 1. ì²­êµ¬ í•­ëª© ì„ íƒ</h2>
                        <small style="color:#64748b;">
                            ì´ë²ˆë‹¬ ì •ì‚°ì„œ ë°œê¸‰ì— ë°˜ì˜í•  í•­ëª©ë³„ ì •ì‚°ì›”ì„ ì„ íƒí•©ë‹ˆë‹¤.
                        </small>
                    </div>

                    <div class="form-group">
                        <label>ì •ì‚°ì„œ ì´ë¦„</label>
                        <input type="text" id="invoiceName" placeholder="ì˜ˆ: 2024ë…„ 3ì›” ì •ì‚°" required>
                    </div>

                    <div class="form-group">
                        <label>ì¶”ê°€ ë©”ëª¨ (ì„ íƒ)</label>
                        <textarea id="invoiceMemo" rows="3" placeholder="ê³ ì • ë©”ëª¨ ì™¸ì— ì¶”ê°€ë¡œ ì•ˆë‚´í•  ë‚´ìš©ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        <small style="color:#64748b;">
                            ğŸ’¡ ì„¤ì •ì—ì„œ ë“±ë¡í•œ ê³ ì • ë©”ëª¨ê°€ ìë™ìœ¼ë¡œ í¬í•¨ë©ë‹ˆë‹¤. ì—¬ê¸°ì— ì…ë ¥í•œ ë‚´ìš©ì€ ê³ ì • ë©”ëª¨ ë’¤ì— ì¶”ê°€ë©ë‹ˆë‹¤.
                        </small>
                    </div>

                    <!-- ì „ê¸°ìš”ê¸ˆ ì„ íƒ -->
                    <div style="margin: 30px 0;">
                        <h3>âš¡ ì „ê¸°ìš”ê¸ˆ ì„ íƒ</h3>
                        {% if electric_bills %}
                            <table>
                                <thead>
                                <tr>
                                    <th width="50">ì„ íƒ</th>
                                    <th>ì •ì‚°ì›”</th>
                                    <th>í¬í•¨ ê³ ì§€ì›”</th>
                                    <th>ì¸µ</th>
                                    <th class="text-right">ì´ì•¡</th>
                                    <th class="text-right">ë³µì§€í• ì¸</th>
                                    <th class="text-right">ë°”ìš°ì²˜í• ì¸</th>
                                    <th class="text-right">TVìˆ˜ì‹ ë£Œ</th>
                                    <th>ì„¸ëŒ€ìˆ˜</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for bill in electric_bills %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="electric-item"
                                                   data-id="{{ bill.id }}"
                                                   data-month="{{ bill.billing_month }}"
                                                   data-desc="{{ bill.billing_month.strftime('%Yë…„ %mì›”') }} {{ bill.floor_ref.name }} ì „ê¸°ìš”ê¸ˆ">
                                        </td>
                                        <td>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</td>
                                        <td style="min-width:200px;">
                                            {% if bill.monthly_details %}
                                                {% set months = bill.monthly_details | map(attribute='month') | select | list %}
                                                {% if months|length > 1 %}
                                                    <div style="display:flex;align-items:center;gap:8px;">
                                                        <span class="badge badge-primary">{{ months|length }}ê°œì›” ë¬¶ìŒ</span>
                                                        <span style="font-size:12px;color:#64748b;">
                                                    {% for detail in bill.monthly_details %}
                                                        {% if detail.month %}
                                                            {{ detail.month[:7] }}
                                                            {% if not loop.last %}, {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </span>
                                                    </div>
                                                {% else %}
                                                    {# ë‹¨ì¼ ê³ ì§€ì›”ì¸ ê²½ìš° ëª…í™•í•œ ì›” í‘œì‹œ #}
                                                    {% set first_month = months[0] if months|length > 0 else '' %}
                                                    {% if first_month %}
                                                        <span style="font-size:13px;color:#64748b;">{{ first_month[:7] }}</span>
                                                    {% else %}
                                                        <span style="font-size:13px;color:#64748b;">{{ bill.billing_month.strftime('%Y-%m') }}</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% else %}
                                                <span style="font-size:13px;color:#64748b;">{{ bill.billing_month.strftime('%Y-%m') }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ bill.floor_ref.name }}</td>
                                        <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
                                        <td class="text-right" style="color:#059669;">
                                            {% if bill.welfare_discount > 0 %}
                                                -{{ "{:,.0f}".format(bill.welfare_discount) }}ì›
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-right" style="color:#059669;">
                                            {% if bill.voucher_discount > 0 %}
                                                -{{ "{:,.0f}".format(bill.voucher_discount) }}ì›
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-right" style="color:#dc2626;">
                                            {% if bill.tv_fee_total > 0 %}
                                                +{{ "{:,.0f}".format(bill.tv_fee_total) }}ì›
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ bill.details|length }}ì„¸ëŒ€</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p style="color: #94a3b8;">ì„ íƒ ê°€ëŠ¥í•œ ì „ê¸°ìš”ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>

                    <!-- ìˆ˜ë„ìš”ê¸ˆ ì„ íƒ -->
                    <div style="margin: 30px 0;">
                        <h3>ğŸ’§ ìˆ˜ë„ìš”ê¸ˆ ì„ íƒ</h3>
                        {% if water_bills %}
                            <table>
                                <thead>
                                <tr>
                                    <th width="50">ì„ íƒ</th>
                                    <th>ì •ì‚°ì›”</th>
                                    <th class="text-right">ì´ì•¡</th>
                                    <th class="text-right">ë³µì§€í• ì¸í•©ê³„</th>
                                    <th>ì„¸ëŒ€ìˆ˜</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for bill in water_bills %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="water-item"
                                                   data-id="{{ bill.id }}"
                                                   data-month="{{ bill.billing_month }}"
                                                   data-desc="{{ bill.billing_month.strftime('%Yë…„ %mì›”') }} ìˆ˜ë„ìš”ê¸ˆ">
                                        </td>
                                        <td>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</td>
                                        <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
                                        <td class="text-right" style="color:#059669;">
                                            {% if bill.welfare_discount_total > 0 %}
                                                -{{ "{:,.0f}".format(bill.welfare_discount_total) }}ì›
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ bill.details|length }}ì„¸ëŒ€</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p style="color: #94a3b8;">ì„ íƒ ê°€ëŠ¥í•œ ìˆ˜ë„ìš”ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>

                    <!-- ê³µë™ ê³µê³¼ê¸ˆ ì„ íƒ -->
                    <div style="margin: 30px 0;">
                        <h3>ğŸ˜ï¸ ê³µë™ ê³µê³¼ê¸ˆ ì„ íƒ</h3>
                        {% if common_bills %}
                            <table>
                                <thead>
                                <tr>
                                    <th width="50">ì„ íƒ</th>
                                    <th>ì •ì‚°ì›”</th>
                                    <th>í•­ëª©</th>
                                    <th class="text-right">ì´ì•¡</th>
                                    <th>ë¶„ë°°ë°©ì‹</th>
                                    <th>ì„¸ëŒ€ìˆ˜</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for bill in common_bills %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="common-item"
                                                   data-id="{{ bill.id }}"
                                                   data-month="{{ bill.billing_month }}"
                                                   data-desc="{{ bill.description }}">
                                        </td>
                                        <td>{{ bill.billing_month.strftime('%Yë…„ %mì›”') }}</td>
                                        <td>{{ bill.description }}</td>
                                        <td class="text-right">{{ "{:,.0f}".format(bill.total_amount) }}ì›</td>
                                        <td>
                                            {% if bill.distribution_method == 'BY_RESIDENTS' %}
                                                ì¸ì›ìˆ˜ ë¹„ë¡€
                                            {% else %}
                                                ì„¸ëŒ€ ê· ë“±
                                            {% endif %}
                                        </td>
                                        <td>{{ bill.details|length }}ì„¸ëŒ€</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p style="color: #94a3b8;">ì„ íƒ ê°€ëŠ¥í•œ ê³µë™ ê³µê³¼ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="goToStep2()">ë‹¤ìŒ ë‹¨ê³„: ì„¸ëŒ€ë³„ ì„¤ì •</button>
                    </div>
                </div>

                <!-- Step 2: ì„¸ëŒ€ë³„ ê¸°íƒ€ê¸ˆì•¡ ë° ë©”ëª¨ -->
                <div id="step2" class="step-content" style="display:none;">
                    <h2>Step 2. ì„¸ëŒ€ë³„ ê¸°íƒ€ê¸ˆì•¡ ë° ë©”ëª¨</h2>
                    <p style="color:#64748b;margin-bottom:20px;">
                        ğŸ’¡ íŠ¹ì • ì„¸ëŒ€ì—ë§Œ ë¶€ê³¼ë˜ëŠ” ê¸°íƒ€ í•­ëª©(ë¯¸ë‚©ê¸ˆ, ìˆ˜ë¦¬ë¹„ ë“±) ë˜ëŠ” í™˜ê¸‰ì•¡ê³¼ ì„¸ëŒ€ë³„ íŠ¹ë³„ ì•ˆë‚´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”.
                    </p>

                    <div id="unitsAdditionalContainer"></div>

                    <div style="margin-top: 30px;display:flex;gap:10px;">
                        <button class="btn btn-secondary" onclick="goToStep1()">ì´ì „: í•­ëª© ì„ íƒ</button>
                        <button class="btn btn-primary" onclick="goToStep3()">ë‹¤ìŒ: ìµœì¢… í™•ì¸</button>
                        <button class="btn" onclick="skipToFinal()">ê¸°íƒ€ê¸ˆì•¡ ì—†ì´ ë°”ë¡œ ìƒì„±</button>
                    </div>
                </div>

                <!-- Step 3: ìµœì¢… í™•ì¸ -->
                <div id="step3" class="step-content" style="display:none;">
                    <h2>Step 3. ìµœì¢… í™•ì¸</h2>
                    <div id="finalConfirmation"></div>

                    <div style="margin-top: 30px;display:flex;gap:10px;">
                        <button class="btn btn-secondary" onclick="goToStep2()">ì´ì „: ì„¸ëŒ€ë³„ ì„¤ì •</button>
                        <button class="btn btn-primary" onclick="createInvoiceFinal()">âœ… ì •ì‚°ì„œ ìƒì„±</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì •ì‚° ë‚´ì—­ íƒ­ -->
        <div id="history-tab" class="tab-content">
            <h2>ì •ì‚° ë‚´ì—­</h2>

            {% if combinations %}
                <table>
                    <thead>
                    <tr>
                        <th>ìƒì„±ì¼</th>
                        <th>ì •ì‚°ì„œëª…</th>
                        <th>ë©”ëª¨</th>
                        <th>í¬í•¨ í•­ëª©ìˆ˜</th>
                        <th>ì‘ì—…</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for combo in combinations %}
                        <tr>
                            <td>{{ combo.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td><strong>{{ combo.invoice_name }}</strong></td>
                            <td>{{ combo.memo[:50] if combo.memo else '-' }}
                                    {% if combo.memo and combo.memo|length > 50 %}...{% endif %}</td>
                            <td>{{ combo.items|length }}ê°œ</td>
                            <td>
                                <a href="{{ url_for('view_invoice', combination_id=combo.id) }}"
                                   class="btn btn-secondary" style="padding: 5px 10px;">ì¡°íšŒ</a>
                                <a href="{{ url_for('print_invoice', combination_id=combo.id) }}" target="_blank"
                                   class="btn btn-primary" style="padding: 5px 10px;">ì¸ì‡„</a>
                                <button class="btn btn-danger" style="padding: 5px 10px;"
                                        onclick="deleteInvoice({{ combo.id }})">ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p style="color: #94a3b8; text-align: center; padding: 40px;">ìƒì„±ëœ ì •ì‚°ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        const UNITS = {{ (units|default([]))|tojson }};
        const FLOORS = {{ (floors|default([]))|tojson }};
        let selectedItems = [];
        let unitAdditionalData = {};

        // íƒ­ ì „í™˜
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).style.display = 'block';
            event.target.classList.add('active');
        }

        // Step ê´€ë¦¬
        function updateStepIndicators(currentStep) {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                const content = document.getElementById(`step${i}`);

                if (i < currentStep) {
                    indicator.className = 'step completed';
                } else if (i === currentStep) {
                    indicator.className = 'step active';
                } else {
                    indicator.className = 'step';
                }

                content.style.display = (i === currentStep) ? 'block' : 'none';
            }
        }

        function goToStep1() {
            updateStepIndicators(1);
        }

        function goToStep2() {
            const name = document.getElementById('invoiceName').value;
            if (!name) {
                alert('ì •ì‚°ì„œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„ íƒëœ í•­ëª© ìˆ˜ì§‘
            selectedItems = [];

            document.querySelectorAll('.electric-item:checked').forEach(el => {
                selectedItems.push({
                    type: 'ELECTRIC',
                    id: parseInt(el.dataset.id),
                    month: el.dataset.month,
                    description: el.dataset.desc
                });
            });

            document.querySelectorAll('.water-item:checked').forEach(el => {
                selectedItems.push({
                    type: 'WATER',
                    id: parseInt(el.dataset.id),
                    month: el.dataset.month,
                    description: el.dataset.desc
                });
            });

            document.querySelectorAll('.common-item:checked').forEach(el => {
                selectedItems.push({
                    type: 'COMMON',
                    id: parseInt(el.dataset.id),
                    month: el.dataset.month,
                    description: el.dataset.desc
                });
            });

            if (selectedItems.length === 0) {
                alert('ìµœì†Œ í•˜ë‚˜ ì´ìƒì˜ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            renderStep2();
            updateStepIndicators(2);
        }

       async function renderStep2() {
            const container = document.getElementById('unitsAdditionalContainer');
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);

            // ì „ì²´ ì„¸ëŒ€ ì”ì•¡ ê°€ì ¸ì˜¤ê¸°
            let balances = {};
            try {
                const res = await fetch('/payments/all_units_balance');
                const data = await res.json();
                if (data.success) {
                    balances = data.balances;
                }
            } catch (error) {
                console.error('ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }

            // ì¸µë³„ë¡œ ê·¸ë£¹í™”
            const floorGroups = {};
            occupiedUnits.forEach(unit => {
                if (!floorGroups[unit.floor_id]) {
                    const floor = FLOORS.find(f => f.id === unit.floor_id);
                    floorGroups[unit.floor_id] = {
                        floor_name: floor ? floor.name : '',
                        floor_number: floor?.floor_number || 0,
                        units: []
                    };
                }
                floorGroups[unit.floor_id].units.push(unit);
            });

            // ìš”ì•½ ì •ë³´ ê³„ì‚°
            let totalUnits = occupiedUnits.length;
            let unitsWithBalance = 0;
            let totalUnpaid = 0;

            occupiedUnits.forEach(unit => {
                const balance = balances[unit.id];
                if (balance && balance.balance > 0) {
                    unitsWithBalance++;
                    totalUnpaid += balance.balance;
                }
            });

            let html = `
                <div class="table-summary">
                    <div class="summary-item">
                        <div class="summary-label">ì´ ì„¸ëŒ€ìˆ˜</div>
                        <div class="summary-value">${totalUnits}ì„¸ëŒ€</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ë¯¸ë‚© ì„¸ëŒ€</div>
                        <div class="summary-value ${unitsWithBalance > 0 ? 'highlight' : ''}">${unitsWithBalance}ì„¸ëŒ€</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ì´ ë¯¸ë‚©ê¸ˆì•¡</div>
                        <div class="summary-value ${totalUnpaid > 0 ? 'highlight' : ''}">${totalUnpaid.toLocaleString()}ì›</div>
                    </div>
                </div>

                <div class="units-table-container">
                    <table class="units-table">
                        <thead>
                            <tr>
                                <th style="width: 120px;">ì¸µ/í˜¸ìˆ˜</th>
                                <th style="width: 200px;">ë¯¸ë‚©ê¸ˆ í˜„í™©</th>
                                <th style="width: 320px;">ê¸°íƒ€ í•­ëª©</th>
                                <th style="width: 250px;">ì„¸ëŒ€ë³„ ë©”ëª¨</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // ì¸µë³„ë¡œ ì •ë ¬í•˜ì—¬ ë Œë”ë§
            const sortedFloorIds = Object.keys(floorGroups).sort((a, b) => {
                return floorGroups[a].floor_number - floorGroups[b].floor_number;
            });

            sortedFloorIds.forEach(floorId => {
                const group = floorGroups[floorId];

                // ì¸µ êµ¬ë¶„ì„ 
                html += `
                    <tr class="floor-separator">
                        <td colspan="5">${group.floor_name}</td>
                    </tr>
                `;

                // ê° ì„¸ëŒ€ í–‰
                group.units.forEach(unit => {
                    const balance = balances[unit.id];
                    let balanceContent = '<span class="balance-badge none">ì™„ë‚©</span>';

                    if (balance && balance.balance !== 0) {
                        const balanceAmount = Math.abs(balance.balance);
                        if (balance.balance > 0) {
                            balanceContent = `
                                <div class="balance-info-container">
                                    <span class="balance-badge unpaid">ë¯¸ë‚© ${balanceAmount.toLocaleString()}ì›</span>
                                    <button type="button" class="btn btn-primary balance-apply-btn"
                                            onclick="applyBalance(${unit.id}, ${balance.balance})"
                                            data-balance-value="${balance.balance}">
                                        ë¯¸ë‚©ê¸ˆ ì •ì‚°ì„œì— í¬í•¨
                                    </button>
                                </div>
                            `;
                        } else {
                            balanceContent = `
                                <div class="balance-info-container">
                                    <span class="balance-badge overpaid">ì´ˆê³¼ ${balanceAmount.toLocaleString()}ì›</span>
                                    <button type="button" class="btn btn-success balance-apply-btn"
                                            onclick="applyBalance(${unit.id}, ${balance.balance})"
                                            data-balance-value="${balance.balance}">
                                        í™˜ê¸‰ê¸ˆ ì •ì‚°ì„œì— í¬í•¨
                                    </button>
                                </div>
                            `;
                        }
                    }

                    html += `
                        <tr>
                            <td class="unit-name-cell">
                                ${unit.unit_name}
                                ${unit.memo ? `<span class="unit-memo-badge">${unit.memo}</span>` : ''}
                            </td>
                            <td class="balance-cell">
                                ${balanceContent}
                            </td>
                            <td class="charges-cell">
                                <div id="charges-${unit.id}" class="charge-inline-container"></div>
                                <div class="charge-inline-container" style="padding-left: 11px;">
                                    <button type="button" class="add-charge-btn" onclick="addChargeRow(${unit.id})">
                                        + í•­ëª© ì¶”ê°€
                                    </button>
                                <div>
                            </td>
                            <td class="memo-cell">
                                <textarea id="memo-${unit.id}" rows="2"
                                          placeholder="ì„¸ëŒ€ íŠ¹ë³„ ì•ˆë‚´ì‚¬í•­"></textarea>
                            </td>
                        </tr>
                    `;
                });
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        let chargeCounter = 0;

        function addChargeRow(unitId) {
            const container = document.getElementById(`charges-${unitId}`);
            const rowId = `charge-${unitId}-${Date.now()}`;
            const row = document.createElement('div');
            row.className = 'charge-inline-row';
            row.id = rowId;
            row.setAttribute('data-unit-id', unitId);
            row.setAttribute('data-is-carryover', 'false');  // ì¼ë°˜ í•­ëª© ëª…ì‹œ

            row.innerHTML = `
                <select class="charge-type">
                    <option value="charge">ë¶€ê³¼</option>
                    <option value="refund">í™˜ê¸‰</option>
                </select>
                <input type="text" placeholder="í•­ëª©ëª…" class="charge-desc">
                <input type="number" placeholder="ê¸ˆì•¡" class="charge-amount" min="0">
                <button type="button" class="btn btn-danger" onclick="removeChargeRow('${rowId}')">ì‚­ì œ</button>
            `;

            container.appendChild(row);
        }

        function removeChargeRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                // data ì†ì„±ìœ¼ë¡œ ì´ì›” í•­ëª©ì¸ì§€ í™•ì¸
                const isCarryover = row.getAttribute('data-is-carryover') === 'true';
                const unitId = row.getAttribute('data-unit-id');
                const originalBalance = row.getAttribute('data-original-balance');

                row.remove();

                // ì´ì›” í•­ëª©ì´ ì‚­ì œë˜ë©´ í•´ë‹¹ ì„¸ëŒ€ì˜ ë¯¸ë‚©ê¸ˆ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                if (isCarryover && unitId && originalBalance) {
                    // í•´ë‹¹ ë²„íŠ¼ ì°¾ê¸° (data-balance-value ì†ì„± í™œìš©)
                    const buttons = document.querySelectorAll(`td.balance-cell button[data-balance-value="${originalBalance}"]`);

                    buttons.forEach(btn => {
                        // onclick ì†ì„±ì—ì„œ unitId í™•ì¸
                        const onclickAttr = btn.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes(`applyBalance(${unitId},`)) {
                            btn.disabled = false;
                            btn.textContent = btn.getAttribute('data-original-text') || 'ë¯¸ë‚©ê¸ˆ ì •ì‚°ì„œì— í¬í•¨';
                            btn.removeAttribute('data-applied');

                            const originalClass = btn.getAttribute('data-original-class');
                            if (originalClass) {
                                btn.classList.remove('btn-secondary');
                                btn.classList.add(originalClass);
                            }

                            // ë¶€ëª¨ ì»¨í…Œì´ë„ˆ íˆ¬ëª…ë„ ì›ë³µ
                            const balanceContainer = btn.parentElement;
                            if (balanceContainer && balanceContainer.classList.contains('balance-info-container')) {
                                balanceContainer.style.opacity = '1';
                                balanceContainer.removeAttribute('data-applied');
                            }
                        }
                    });
                }
            }
        }

        // ì”ì•¡ ìë™ ì ìš© í•¨ìˆ˜
        function applyBalance(unitId, balance) {
            const container = document.getElementById(`charges-${unitId}`);

            // ì´ë¯¸ ì´ì›” í•­ëª©ì´ ìˆëŠ”ì§€ data ì†ì„±ìœ¼ë¡œ í™•ì¸
            const existingCarryover = container.querySelector('[data-is-carryover="true"]');
            if (existingCarryover) {
                alert('ì´ë¯¸ ë¯¸ë‚©ê¸ˆ/í™˜ê¸‰ê¸ˆì´ ì •ì‚°ì„œì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const rowId = `charge-${unitId}-${Date.now()}`;
            const row = document.createElement('div');
            row.className = 'charge-inline-row carryover-row';  // carryover-row í´ë˜ìŠ¤ ì¶”ê°€
            row.id = rowId;
            row.setAttribute('data-unit-id', unitId);
            row.setAttribute('data-is-carryover', 'true');
            row.setAttribute('data-original-balance', balance);

            const type = balance > 0 ? 'charge' : 'refund';
            const amount = Math.abs(balance);
            const description = balance > 0 ? '[ì´ì›”] ì „ì›” ë¯¸ë‚©ê¸ˆ' : '[ì´ì›”] ì „ì›” ì´ˆê³¼ë‚©ë¶€ í™˜ê¸‰';

            // íˆ´íŒ ì•„ì´ì½˜ ì¶”ê°€
            row.innerHTML = `
                <select class="charge-type" data-carryover-type="${type}">
                    <option value="charge" ${type === 'charge' ? 'selected' : ''}>ë¶€ê³¼</option>
                    <option value="refund" ${type === 'refund' ? 'selected' : ''}>í™˜ê¸‰</option>
                </select>
                <input type="text" placeholder="í•­ëª©ëª…" class="charge-desc" value="${description}" data-carryover-desc="true">
                <input type="number" placeholder="ê¸ˆì•¡" class="charge-amount" value="${amount}" min="0" data-carryover-amount="${amount}">
                <button type="button" class="btn btn-danger" onclick="removeChargeRow('${rowId}')">ì‚­ì œ</button>
                <span class="carryover-tooltip" title="ì „ì›” ì”ì•¡ ìë™ ì¶”ê°€">!</span>
            `;

            container.appendChild(row);

            // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì†ì„± ì €ì¥
            const button = event.target;
            button.disabled = true;
            button.textContent = 'í¬í•¨ë¨';
            button.classList.remove('btn-primary', 'btn-success');
            button.classList.add('btn-secondary');
            button.setAttribute('data-applied', 'true');
            button.setAttribute('data-original-text', balance > 0 ? 'ë¯¸ë‚©ê¸ˆ ì •ì‚°ì„œì— í¬í•¨' : 'í™˜ê¸‰ê¸ˆ ì •ì‚°ì„œì— í¬í•¨');
            button.setAttribute('data-original-class', balance > 0 ? 'btn-primary' : 'btn-success');
            button.setAttribute('data-balance-value', balance);

            // ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ì ìš© ì™„ë£Œ í‘œì‹œ
            const balanceContainer = button.parentElement;
            if (balanceContainer && balanceContainer.classList.contains('balance-info-container')) {
                balanceContainer.style.opacity = '0.7';
                balanceContainer.setAttribute('data-applied', 'true');
            }
        }

        function goToStep3() {
            // ì„¸ëŒ€ë³„ ì¶”ê°€ ë°ì´í„° ìˆ˜ì§‘
            unitAdditionalData = {};
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);

            occupiedUnits.forEach(unit => {
                const charges = [];
                const chargesContainer = document.getElementById(`charges-${unit.id}`);

                if (chargesContainer) {
                    chargesContainer.querySelectorAll('.charge-inline-row').forEach(row => {
                        const type = row.querySelector('.charge-type').value;
                        const desc = row.querySelector('.charge-desc').value;
                        let amount = parseFloat(row.querySelector('.charge-amount').value) || 0;
                        const isCarryover = row.getAttribute('data-is-carryover') === 'true';

                        if (desc && amount > 0) {
                            // í™˜ê¸‰ì¸ ê²½ìš° ìŒìˆ˜ë¡œ ë³€í™˜
                            if (type === 'refund') {
                                amount = -Math.abs(amount);
                            }
                            charges.push({
                                description: desc,
                                amount: amount,
                                type: type,
                                is_carryover: isCarryover  // ì´ì›” ì—¬ë¶€ ì €ì¥
                            });
                        }
                    });
                }

                const memo = document.getElementById(`memo-${unit.id}`)?.value || '';

                if (charges.length > 0 || memo) {
                    unitAdditionalData[unit.id] = {charges, memo};
                }
            });

            renderStep3();
            updateStepIndicators(3);
        }

        function renderStep3() {
            const container = document.getElementById('finalConfirmation');

            let html = '<div class="confirm-section">';
            html += '<h3>ğŸ“‹ ì„ íƒí•œ í•­ëª©</h3>';

            selectedItems.forEach(item => {
                html += `
            <div class="confirm-item">
                <span class="confirm-item-icon">
                    ${item.type === 'ELECTRIC' ? 'âš¡' : item.type === 'WATER' ? 'ğŸ’§' : 'ğŸ˜ï¸'}
                </span>
                <span class="confirm-item-text">${item.description}</span>
            </div>
        `;
            });
            html += '</div>';

            // ê¸°íƒ€ê¸ˆì•¡/ë©”ëª¨ê°€ ìˆëŠ” ì„¸ëŒ€ ë˜ëŠ” ì„¤ì • ë¹„ê³ ê°€ ìˆëŠ” ì„¸ëŒ€ ì°¾ê¸°
            const occupiedUnits = UNITS.filter(u => !u.is_vacant);
            const unitsToShow = occupiedUnits.filter(unit => {
                const hasAdditional = unitAdditionalData[unit.id];
                const hasSettingMemo = unit.memo && unit.memo.trim() !== '';
                return hasAdditional || hasSettingMemo;
            });

            if (unitsToShow.length > 0) {
                html += '<div class="confirm-section">';
                html += '<h3>ğŸ’° ê¸°íƒ€ê¸ˆì•¡ ë° ë©”ëª¨ ì„¤ì •</h3>';

                unitsToShow.forEach(unit => {
                    const data = unitAdditionalData[unit.id] || {charges: [], memo: ''};

                    html += '<div class="unit-summary-card">';
                    html += '<div class="unit-summary-header">';
                    html += `<span class="unit-summary-name">${unit.unit_name}</span>`;

                    // ì„¸ëŒ€ ì„¤ì • ë¹„ê³  í‘œì‹œ (unit.memo)
                    if (unit.memo) {
                        html += `<span class="unit-summary-memo">${unit.memo}</span>`;
                    }

                    html += '</div>';

                    html += '<div class="unit-summary-details">';

                    // ê¸°íƒ€ í•­ëª©
                    if (data.charges && data.charges.length > 0) {
                        html += '<div style="margin-top:8px;">';
                        html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">ê¸°íƒ€ í•­ëª©:</div>';
                        data.charges.forEach(c => {
                            const isRefund = c.type === 'refund' || c.amount < 0;
                            const isCarryover = c.is_carryover || c.description.includes('[ì´ì›”]');
                            const displayAmount = Math.abs(c.amount).toLocaleString();
                            const color = isRefund ? '#059669' : '#dc2626';
                            const prefix = isRefund ? 'í™˜ê¸‰ -' : 'ë¶€ê³¼ +';
                            const bgColor = isCarryover ? '#fef3c7' : '#f8fafc';
                            const borderStyle = isCarryover ? 'border-left:3px solid #fbbf24;' : '';

                            html += `
                        <div style="padding:6px 12px;background:${bgColor};border-radius:6px;margin-bottom:4px;${borderStyle}">
                            ${isCarryover ? '<span style="background:#fbbf24;color:white;font-size:10px;padding:1px 4px;border-radius:3px;margin-right:6px;">ìë™</span>' : ''}
                            <span style="color:#475569;">${c.description}</span>
                            <span style="color:${color};font-weight:600;margin-left:8px;">${prefix}${displayAmount}ì›</span>
                            ${isCarryover ? '<span style="font-size:10px;color:#92400e;margin-left:4px;">(ì „ì›” ì”ì•¡)</span>' : ''}
                        </div>
                    `;
                        });
                        html += '</div>';
                    }

                    // ì„¸ëŒ€ ë©”ëª¨
                    if (data.memo) {
                        html += '<div style="grid-column: 1 / -1;">';
                        html += '<div style="font-size:12px;color:#64748b;margin-bottom:4px;">ì„¸ëŒ€ ë©”ëª¨:</div>';
                        html += `<div style="padding:8px 12px;background:#fff3cd;border-radius:6px;color:#78350f;font-size:13px;white-space:pre-wrap;">${data.memo}</div>`;
                        html += '</div>';
                    }

                    // ê¸°íƒ€ í•­ëª©ì´ë‚˜ ì„¸ëŒ€ ë©”ëª¨ê°€ ì—†ì§€ë§Œ ì„¤ì • ë¹„ê³ ë§Œ ìˆëŠ” ê²½ìš°
                    if ((!data.charges || data.charges.length === 0) && !data.memo && unit.memo) {
                        html += '<div style="grid-column: 1 / -1;color:#64748b;font-size:13px;font-style:italic;">';
                        html += '(ì„¤ì •ì— ë¹„ê³ ë§Œ ë“±ë¡ëœ ì„¸ëŒ€ì…ë‹ˆë‹¤)';
                        html += '</div>';
                    }

                    html += '</div>'; // unit-summary-details
                    html += '</div>'; // unit-summary-card
                });

                html += '</div>';
            } else {
                html += '<div class="confirm-section">';
                html += '<p style="color:#64748b;margin:0;">ê¸°íƒ€ê¸ˆì•¡ ë° ì„¸ëŒ€ë³„ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function skipToFinal() {
            unitAdditionalData = {};
            renderStep3();
            updateStepIndicators(3);
        }

        // ì •ì‚°ì„œ ìµœì¢… ìƒì„±
        async function createInvoiceFinal() {
            const name = document.getElementById('invoiceName').value;

            const data = {
                name: name,
                memo: document.getElementById('invoiceMemo').value,
                items: selectedItems,
                unit_additional_data: unitAdditionalData,
                _csrf_token: getCsrfToken()
            };

            const response = await fetch('/invoice/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('ì •ì‚°ì„œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = `/invoice/view/${result.id}`;
            } else {
                alert(result.message);
            }
        }

        // ì •ì‚°ì„œ ì‚­ì œ
        async function deleteInvoice(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ëœ ëª¨ë“  ì²­êµ¬ ë‚´ì—­ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            const fd = new FormData();
            fd.append('_csrf_token', getCsrfToken());

            const res = await fetch(`/invoice/delete/${id}`, {
                method: 'POST',
                body: fd
            });

            const j = await res.json();
            alert(j.message || (j.success ? 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‚­ì œ ì‹¤íŒ¨'));
            if (j.success) location.reload();
        }
    </script>
{% endblock %}